"""Tests for scripts/check_pentest_findings.py."""

from __future__ import annotations

import json
import os
import subprocess
import sys
from pathlib import Path


SCRIPT = Path(__file__).resolve().parents[2] / "scripts" / "check_pentest_findings.py"


def _run(*args: str, cwd: Path | None = None) -> subprocess.CompletedProcess[str]:
    return subprocess.run(
        [sys.executable, str(SCRIPT), *args],
        capture_output=True,
        text=True,
        cwd=str(cwd) if cwd else None,
        env=dict(os.environ),
    )


def test_passes_with_no_blocking_findings(tmp_path: Path):
    findings = tmp_path / "findings.json"
    findings.write_text(
        json.dumps(
            {
                "last_audit_date": "2026-02-13",
                "schema_version": "1.0",
                "findings": [
                    {
                        "id": "PT-1",
                        "severity": "medium",
                        "status": "open",
                        "title": "Medium issue",
                    }
                ],
            }
        )
    )

    result = _run("--file", str(findings))
    assert result.returncode == 0
    assert "passed:" in result.stdout.lower()


def test_fails_with_open_high_finding(tmp_path: Path):
    findings = tmp_path / "findings.json"
    findings.write_text(
        json.dumps(
            {
                "last_audit_date": "2026-02-13",
                "schema_version": "1.0",
                "findings": [
                    {"id": "PT-2", "severity": "high", "status": "open", "title": "Issue"}
                ],
            }
        )
    )

    result = _run("--file", str(findings))
    assert result.returncode == 1
    assert "unresolved" in result.stdout.lower()
