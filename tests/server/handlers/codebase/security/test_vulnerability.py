"""
Tests for Vulnerability Scanning Handler.

Tests cover:
- Scan trigger endpoint
- Scan status and results
- Vulnerability listing with filtering
- CVE database lookup
- Package vulnerability queries
- Scan history listing
- Permission checks
- Error handling
"""

from __future__ import annotations

import json
import pytest
from datetime import datetime, timezone
from unittest.mock import AsyncMock, MagicMock, patch

from aragora.server.handlers.base import HandlerResult


# ============================================================================
# Mock Classes
# ============================================================================


class MockVulnerabilityScanResult:
    """Mock vulnerability scan result."""

    def __init__(
        self,
        scan_id: str = "vuln_123",
        repository: str = "test-repo",
        status: str = "completed",
    ):
        self.scan_id = scan_id
        self.repository = repository
        self.status = status
        self.branch = "main"
        self.commit_sha = "abc123def"
        self.started_at = datetime.now(timezone.utc)
        self.completed_at = datetime.now(timezone.utc)
        self.error = None
        self.vulnerabilities = []
        self.critical_count = 0
        self.high_count = 0
        self.medium_count = 0
        self.low_count = 0

    def to_dict(self) -> dict:
        return {
            "scan_id": self.scan_id,
            "repository": self.repository,
            "status": self.status,
            "branch": self.branch,
            "commit_sha": self.commit_sha,
            "started_at": self.started_at.isoformat(),
            "completed_at": self.completed_at.isoformat() if self.completed_at else None,
            "vulnerabilities": [v.to_dict() for v in self.vulnerabilities],
            "summary": {
                "critical": self.critical_count,
                "high": self.high_count,
                "medium": self.medium_count,
                "low": self.low_count,
            },
        }


class MockVulnerability:
    """Mock vulnerability."""

    def __init__(
        self,
        cve_id: str,
        severity: str,
        package_name: str = "test-pkg",
        package_version: str = "1.0.0",
    ):
        self.cve_id = cve_id
        self.severity = severity
        self.package_name = package_name
        self.package_version = package_version
        self.description = f"Test vulnerability {cve_id}"
        self.cvss_score = 7.5 if severity == "high" else 5.0
        self.references = []
        self.fix_version = None

    def to_dict(self) -> dict:
        return {
            "cve_id": self.cve_id,
            "severity": self.severity,
            "package_name": self.package_name,
            "package_version": self.package_version,
            "description": self.description,
            "cvss_score": self.cvss_score,
            "fix_version": self.fix_version,
        }


# ============================================================================
# Fixtures
# ============================================================================


@pytest.fixture
def mock_scanner():
    """Create mock vulnerability scanner."""
    scanner = MagicMock()
    scanner.scan_repository = AsyncMock(return_value=MockVulnerabilityScanResult())
    return scanner


@pytest.fixture
def mock_cve_client():
    """Create mock CVE client."""
    client = MagicMock()
    mock_cve = MagicMock()
    mock_cve.cve_id = "CVE-2023-1234"
    mock_cve.severity = "high"
    mock_cve.description = "Test CVE"
    mock_cve.to_dict = MagicMock(
        return_value={
            "cve_id": "CVE-2023-1234",
            "severity": "high",
            "description": "Test CVE",
            "references": [],
        }
    )
    client.get_cve = AsyncMock(return_value=mock_cve)
    client.query_package = AsyncMock(return_value=[mock_cve])
    return client


@pytest.fixture
def mock_scan_storage():
    """Create mock scan storage."""
    return {}


# ============================================================================
# Scan Trigger Tests
# ============================================================================


class TestScanTrigger:
    """Test vulnerability scan trigger endpoint."""

    @pytest.mark.asyncio
    async def test_scan_repository_success(self, mock_scanner):
        """Test successful scan trigger returns scan ID."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_scan_repository,
        )

        with (
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_vulnerability_scanner",
                return_value=mock_scanner,
            ),
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
                return_value={},
            ),
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_running_scans",
                return_value={},
            ),
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_scan_lock",
                return_value=MagicMock(),
            ),
        ):
            result = await handle_scan_repository(
                repo_path="/path/to/repo",
                repo_id="test-repo",
                branch="main",
            )

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert "scan_id" in data
            assert data["status"] == "running"

    @pytest.mark.asyncio
    async def test_scan_repository_already_running(self, mock_scanner):
        """Test scan returns 409 if already running."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_scan_repository,
        )

        running_task = MagicMock()
        running_task.done.return_value = False

        with (
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_running_scans",
                return_value={"test-repo": running_task},
            ),
        ):
            result = await handle_scan_repository(
                repo_path="/path/to/repo",
                repo_id="test-repo",
            )

            assert result.status_code == 409

    @pytest.mark.asyncio
    async def test_scan_repository_generates_repo_id(self, mock_scanner):
        """Test scan generates repo_id if not provided."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_scan_repository,
        )

        with (
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_vulnerability_scanner",
                return_value=mock_scanner,
            ),
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
                return_value={},
            ),
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_running_scans",
                return_value={},
            ),
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_scan_lock",
                return_value=MagicMock(),
            ),
        ):
            result = await handle_scan_repository(repo_path="/path/to/repo")

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert data["repository"].startswith("repo_")


# ============================================================================
# Scan Status Tests
# ============================================================================


class TestScanStatus:
    """Test scan status endpoint."""

    @pytest.mark.asyncio
    async def test_get_scan_status_specific(self):
        """Test getting specific scan by ID."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_scan_status,
        )

        scan = MockVulnerabilityScanResult(scan_id="scan_123")
        scan_results = {"scan_123": scan}

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value=scan_results,
        ):
            result = await handle_get_scan_status(
                repo_id="test-repo",
                scan_id="scan_123",
            )

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert data["scan_result"]["scan_id"] == "scan_123"

    @pytest.mark.asyncio
    async def test_get_scan_status_latest(self):
        """Test getting latest scan."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_scan_status,
        )

        scan1 = MockVulnerabilityScanResult(scan_id="scan_old")
        scan1.started_at = datetime(2023, 1, 1, tzinfo=timezone.utc)
        scan2 = MockVulnerabilityScanResult(scan_id="scan_new")
        scan2.started_at = datetime(2024, 1, 1, tzinfo=timezone.utc)

        scan_results = {"scan_old": scan1, "scan_new": scan2}

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value=scan_results,
        ):
            result = await handle_get_scan_status(repo_id="test-repo")

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert data["scan_result"]["scan_id"] == "scan_new"

    @pytest.mark.asyncio
    async def test_get_scan_status_not_found(self):
        """Test 404 when scan not found."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_scan_status,
        )

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value={},
        ):
            result = await handle_get_scan_status(
                repo_id="test-repo",
                scan_id="nonexistent",
            )

            assert result.status_code == 404


# ============================================================================
# Vulnerability List Tests
# ============================================================================


class TestVulnerabilityList:
    """Test vulnerability listing endpoint."""

    @pytest.mark.asyncio
    async def test_get_vulnerabilities_success(self):
        """Test getting vulnerabilities from latest scan."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_vulnerabilities,
        )

        scan = MockVulnerabilityScanResult()
        scan.vulnerabilities = [
            MockVulnerability("CVE-2023-0001", "high"),
            MockVulnerability("CVE-2023-0002", "medium"),
        ]
        scan.high_count = 1
        scan.medium_count = 1

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value={"scan_123": scan},
        ):
            result = await handle_get_vulnerabilities(repo_id="test-repo")

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert "vulnerabilities" in data
            assert len(data["vulnerabilities"]) == 2

    @pytest.mark.asyncio
    async def test_get_vulnerabilities_filter_by_severity(self):
        """Test filtering vulnerabilities by severity."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_vulnerabilities,
        )

        scan = MockVulnerabilityScanResult()
        scan.vulnerabilities = [
            MockVulnerability("CVE-2023-0001", "high"),
            MockVulnerability("CVE-2023-0002", "medium"),
            MockVulnerability("CVE-2023-0003", "high"),
        ]

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value={"scan_123": scan},
        ):
            result = await handle_get_vulnerabilities(
                repo_id="test-repo",
                severity="high",
            )

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert all(v["severity"] == "high" for v in data["vulnerabilities"])

    @pytest.mark.asyncio
    async def test_get_vulnerabilities_pagination(self):
        """Test vulnerability pagination."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_vulnerabilities,
        )

        scan = MockVulnerabilityScanResult()
        scan.vulnerabilities = [MockVulnerability(f"CVE-2023-{i:04d}", "high") for i in range(10)]

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value={"scan_123": scan},
        ):
            result = await handle_get_vulnerabilities(
                repo_id="test-repo",
                limit=5,
                offset=0,
            )

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert len(data["vulnerabilities"]) == 5
            assert data["total"] == 10

    @pytest.mark.asyncio
    async def test_get_vulnerabilities_no_completed_scans(self):
        """Test 404 when no completed scans."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_vulnerabilities,
        )

        scan = MockVulnerabilityScanResult(status="running")

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value={"scan_123": scan},
        ):
            result = await handle_get_vulnerabilities(repo_id="test-repo")

            assert result.status_code == 404


# ============================================================================
# CVE Lookup Tests
# ============================================================================


class TestCVELookup:
    """Test CVE lookup endpoint."""

    @pytest.mark.asyncio
    async def test_get_cve_details_success(self, mock_cve_client):
        """Test successful CVE lookup."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_cve_details,
        )

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_cve_client",
            return_value=mock_cve_client,
        ):
            result = await handle_get_cve_details("CVE-2023-1234")

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert data["vulnerability"]["cve_id"] == "CVE-2023-1234"

    @pytest.mark.asyncio
    async def test_get_cve_details_not_found(self, mock_cve_client):
        """Test 404 when CVE not found."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_cve_details,
        )

        mock_cve_client.get_cve = AsyncMock(return_value=None)

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_cve_client",
            return_value=mock_cve_client,
        ):
            result = await handle_get_cve_details("CVE-9999-9999")

            assert result.status_code == 404


# ============================================================================
# Package Vulnerability Query Tests
# ============================================================================


class TestPackageVulnerabilityQuery:
    """Test package vulnerability query endpoint."""

    @pytest.mark.asyncio
    async def test_query_package_success(self, mock_cve_client):
        """Test successful package vulnerability query."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_query_package_vulnerabilities,
        )

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_cve_client",
            return_value=mock_cve_client,
        ):
            result = await handle_query_package_vulnerabilities(
                package_name="lodash",
                package_version="4.17.0",
                ecosystem="npm",
            )

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert "vulnerabilities" in data

    @pytest.mark.asyncio
    async def test_query_package_no_results(self, mock_cve_client):
        """Test package query with no vulnerabilities."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_query_package_vulnerabilities,
        )

        mock_cve_client.query_package = AsyncMock(return_value=[])

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_cve_client",
            return_value=mock_cve_client,
        ):
            result = await handle_query_package_vulnerabilities(
                package_name="safe-package",
                package_version="1.0.0",
            )

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert data["vulnerabilities"] == []


# ============================================================================
# Scan History Tests
# ============================================================================


class TestScanHistory:
    """Test scan history listing endpoint."""

    @pytest.mark.asyncio
    async def test_list_scans_success(self):
        """Test listing scan history."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_list_scans,
        )

        scan1 = MockVulnerabilityScanResult(scan_id="scan_1")
        scan2 = MockVulnerabilityScanResult(scan_id="scan_2")

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value={"scan_1": scan1, "scan_2": scan2},
        ):
            result = await handle_list_scans(repo_id="test-repo")

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert len(data["scans"]) == 2

    @pytest.mark.asyncio
    async def test_list_scans_with_limit(self):
        """Test listing scans with limit."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_list_scans,
        )

        scans = {f"scan_{i}": MockVulnerabilityScanResult(scan_id=f"scan_{i}") for i in range(10)}

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value=scans,
        ):
            result = await handle_list_scans(repo_id="test-repo", limit=5)

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert len(data["scans"]) == 5

    @pytest.mark.asyncio
    async def test_list_scans_empty(self):
        """Test listing scans when none exist."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_list_scans,
        )

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
            return_value={},
        ):
            result = await handle_list_scans(repo_id="test-repo")

            assert result.status_code == 200
            response = json.loads(result.body.decode())
            data = response.get("data", response)
            assert data["scans"] == []


# ============================================================================
# Permission Tests
# ============================================================================


class TestVulnerabilityPermissions:
    """Test permission enforcement."""

    def test_scan_has_permission_decorator(self):
        """Scan trigger requires security permission."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_scan_repository,
        )
        import inspect

        source = inspect.getsource(handle_scan_repository)
        assert "require_permission" in source

    def test_get_vulnerabilities_has_permission_decorator(self):
        """Get vulnerabilities requires security permission."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_vulnerabilities,
        )
        import inspect

        source = inspect.getsource(handle_get_vulnerabilities)
        assert "require_permission" in source


# ============================================================================
# Error Handling Tests
# ============================================================================


class TestVulnerabilityErrorHandling:
    """Test error handling."""

    @pytest.mark.asyncio
    async def test_scan_handles_scanner_error(self, mock_scanner):
        """Test scan handles scanner errors."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_scan_repository,
        )

        mock_scanner.scan_repository.side_effect = RuntimeError("Scanner failed")

        with (
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_vulnerability_scanner",
                return_value=mock_scanner,
            ),
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_or_create_scan_results",
                return_value={},
            ),
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_running_scans",
                return_value={},
            ),
            patch(
                "aragora.server.handlers.codebase.security.vulnerability.get_scan_lock",
                return_value=MagicMock(),
            ),
        ):
            result = await handle_scan_repository(
                repo_path="/path/to/repo",
                repo_id="test-repo",
            )

            # Should return 200 with running status since scan is async
            # The error will be recorded in the scan result
            assert result.status_code in (200, 500)

    @pytest.mark.asyncio
    async def test_cve_lookup_handles_client_error(self, mock_cve_client):
        """Test CVE lookup handles client errors."""
        from aragora.server.handlers.codebase.security.vulnerability import (
            handle_get_cve_details,
        )

        mock_cve_client.get_cve.side_effect = RuntimeError("CVE service unavailable")

        with patch(
            "aragora.server.handlers.codebase.security.vulnerability.get_cve_client",
            return_value=mock_cve_client,
        ):
            result = await handle_get_cve_details("CVE-2023-1234")

            assert result.status_code == 500


__all__ = [
    "TestScanTrigger",
    "TestScanStatus",
    "TestVulnerabilityList",
    "TestCVELookup",
    "TestPackageVulnerabilityQuery",
    "TestScanHistory",
    "TestVulnerabilityPermissions",
    "TestVulnerabilityErrorHandling",
]
