# Prometheus alerting rules for Aragora
#
# These rules define when to trigger alerts based on metrics.
# Configure Alertmanager to route these to Slack, PagerDuty, etc.

groups:
  - name: aragora_availability
    interval: 30s
    rules:
      - alert: AragoraDown
        expr: up{job="aragora-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Aragora API is down"
          description: "Aragora API server has been unreachable for more than 1 minute."

      - alert: AragoraHighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="aragora-api"}[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API latency detected"
          description: "P95 latency is above 500ms for 5 minutes. Current: {{ $value | printf \"%.2f\" }}s"

      - alert: AragoraCriticalLatency
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job="aragora-api"}[5m])) > 2
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical API latency"
          description: "P99 latency is above 2s for 2 minutes. Current: {{ $value | printf \"%.2f\" }}s"

  - name: aragora_errors
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{job="aragora-api", status=~"5.."}[5m]))
          /
          sum(rate(http_requests_total{job="aragora-api"}[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "More than 5% of requests are failing. Current: {{ $value | printf \"%.2f\" }}%"

      - alert: RateLimitExhaustion
        expr: sum(rate(http_requests_total{job="aragora-api", status="429"}[5m])) > 0.83
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High rate limit rejections"
          description: "More than 50 rate limit rejections per minute for 5 minutes."

      - alert: DebateTimeoutRate
        expr: |
          sum(rate(aragora_debates_total{status="timeout"}[15m]))
          /
          sum(rate(aragora_debates_total[15m])) > 0.1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High debate timeout rate"
          description: "More than 10% of debates are timing out. Current: {{ $value | printf \"%.1f\" }}%"

  - name: aragora_resources
    interval: 60s
    rules:
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes{job="aragora-api"} / 1024 / 1024 / 1024 > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Aragora is using more than 2GB of memory. Current: {{ $value | printf \"%.1f\" }}GB"

      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total{job="aragora-api"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage"
          description: "Aragora CPU usage above 80% for 5 minutes. Current: {{ $value | printf \"%.0f\" }}%"

      - alert: TooManyOpenConnections
        expr: aragora_active_connections > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Too many open connections"
          description: "More than 1000 active connections. Current: {{ $value }}"

  - name: aragora_debates
    interval: 60s
    rules:
      - alert: NoActiveDebates
        expr: aragora_active_debates == 0
        for: 30m
        labels:
          severity: info
        annotations:
          summary: "No active debates"
          description: "No debates have been running for 30 minutes. This may be expected during low traffic."

      - alert: LowConsensusRate
        expr: |
          sum(rate(aragora_consensus_reached[1h]))
          /
          sum(rate(aragora_debates_total{status="completed"}[1h])) < 0.5
        for: 1h
        labels:
          severity: info
        annotations:
          summary: "Low consensus rate"
          description: "Less than 50% of debates are reaching consensus in the last hour."

      - alert: AgentHighErrorRate
        expr: |
          sum by (agent) (rate(aragora_agent_errors_total[15m]))
          /
          sum by (agent) (rate(aragora_agent_requests_total[15m])) > 0.2
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Agent {{ $labels.agent }} has high error rate"
          description: "Agent {{ $labels.agent }} is failing more than 20% of requests."

  - name: aragora_circuit_breakers
    interval: 30s
    rules:
      - alert: CircuitBreakerOpen
        expr: aragora_circuit_breakers_open > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Circuit breaker(s) open"
          description: "{{ $value }} circuit breaker(s) are in open state. Some agents may be unavailable."

      - alert: MultipleCircuitBreakersOpen
        expr: aragora_circuit_breakers_open > 3
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Multiple circuit breakers open"
          description: "{{ $value }} circuit breakers are open. Service degradation likely."

  - name: aragora_redis
    interval: 30s
    rules:
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          description: "Redis server is unreachable. Rate limiting will fall back to in-memory."

      - alert: RedisHighMemory
        expr: redis_memory_used_bytes / redis_memory_max_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis high memory usage"
          description: "Redis is using more than 90% of max memory."

  - name: aragora_slo
    interval: 30s
    rules:
      - alert: SLOAvailabilityBreach
        expr: |
          1 - (
            sum(rate(http_requests_total{job="aragora-api", status=~"5.."}[1h]))
            /
            sum(rate(http_requests_total{job="aragora-api"}[1h]))
          ) < 0.999
        for: 15m
        labels:
          severity: critical
          slo: availability
        annotations:
          summary: "SLO Availability breach"
          description: "Availability SLO (99.9%) is breached. Current: {{ $value | printf \"%.4f\" }}"
          runbook_url: "https://docs.aragora.io/runbooks/slo-availability"

      - alert: SLOLatencyBreach
        expr: |
          histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job="aragora-api"}[1h])) * 1000 > 500
        for: 15m
        labels:
          severity: warning
          slo: latency
        annotations:
          summary: "SLO Latency P99 breach"
          description: "P99 latency SLO (500ms) is breached. Current: {{ $value | printf \"%.0f\" }}ms"

      - alert: SLODebateSuccessBreach
        expr: |
          sum(rate(aragora_debates_total{status="completed"}[1h]))
          /
          sum(rate(aragora_debates_total[1h])) < 0.95
        for: 30m
        labels:
          severity: warning
          slo: debate_success
        annotations:
          summary: "SLO Debate success rate breach"
          description: "Debate success SLO (95%) is breached. Current: {{ $value | printf \"%.2f\" }}"

  - name: aragora_database
    interval: 60s
    rules:
      - alert: DatabaseConnectionPoolExhausted
        expr: aragora_db_pool_available == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database connection pool exhausted"
          description: "No available database connections. New requests may fail."

      - alert: DatabaseConnectionPoolLow
        expr: aragora_db_pool_available / aragora_db_pool_size < 0.2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database connection pool running low"
          description: "Less than 20% of database connections available."

      - alert: DatabaseSlowQueries
        expr: |
          histogram_quantile(0.95, rate(aragora_db_query_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries"
          description: "P95 database query time exceeds 1 second. Current: {{ $value | printf \"%.2f\" }}s"

      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database is unreachable."

  - name: aragora_agents
    interval: 30s
    rules:
      - alert: AgentCircuitOpen
        expr: aragora_agent_circuit_state{state="open"} == 1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Agent {{ $labels.agent }} circuit breaker open"
          description: "Agent {{ $labels.agent }} has circuit breaker open due to failures."

      - alert: AllAgentsUnavailable
        expr: |
          count(aragora_agent_circuit_state{state="closed"} == 1) == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "All agents unavailable"
          description: "No agents have closed circuit breakers. System cannot process debates."

      - alert: AgentHighLatency
        expr: |
          histogram_quantile(0.95, rate(aragora_agent_response_seconds_bucket[5m])) > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Agent {{ $labels.agent }} high latency"
          description: "Agent {{ $labels.agent }} P95 response time exceeds 30 seconds."

      - alert: AgentQuotaExhausted
        expr: aragora_agent_quota_remaining{agent=~".+"} == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Agent {{ $labels.agent }} quota exhausted"
          description: "Agent {{ $labels.agent }} has exhausted its API quota."

  - name: aragora_websocket
    interval: 30s
    rules:
      - alert: WebSocketConnectionSpike
        expr: |
          rate(aragora_ws_connections_total[5m]) > 100
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "WebSocket connection spike"
          description: "Unusual spike in WebSocket connections. Potential DoS or misconfigured client."

      - alert: WebSocketHighDropRate
        expr: |
          sum(rate(aragora_ws_errors_total{type="dropped"}[5m]))
          /
          sum(rate(aragora_ws_messages_total[5m])) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High WebSocket message drop rate"
          description: "More than 1% of WebSocket messages are being dropped."

  - name: aragora_queue
    interval: 30s
    rules:
      - alert: JobQueueBacklog
        expr: aragora_job_queue_size > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Job queue backlog growing"
          description: "More than 100 jobs waiting in queue for 10+ minutes."

      - alert: JobQueueCritical
        expr: aragora_job_queue_size > 500
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Critical job queue backlog"
          description: "More than 500 jobs waiting in queue. Workers may be down or overwhelmed."

      - alert: StaleJobs
        expr: aragora_stale_jobs_count > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Stale jobs detected"
          description: "{{ $value }} jobs are stale and may need recovery."

  - name: aragora_certificates
    interval: 3600s  # Check hourly
    rules:
      # Certificate expiring within 7 days - Critical
      - alert: TLSCertificateExpiringSoon
        expr: |
          (probe_ssl_earliest_cert_expiry - time()) / 86400 < 7
        for: 5m
        labels:
          severity: critical
          component: tls
        annotations:
          summary: "TLS certificate expiring within 7 days"
          description: "Certificate for {{ $labels.instance }} expires in {{ $value | printf \"%.1f\" }} days."
          runbook_url: "https://docs.aragora.ai/runbook/certificate-renewal"

      # Certificate expiring within 30 days - Warning
      - alert: TLSCertificateExpiringWarning
        expr: |
          (probe_ssl_earliest_cert_expiry - time()) / 86400 < 30
        for: 5m
        labels:
          severity: warning
          component: tls
        annotations:
          summary: "TLS certificate expiring within 30 days"
          description: "Certificate for {{ $labels.instance }} expires in {{ $value | printf \"%.1f\" }} days. Plan renewal."

      # Certificate expired
      - alert: TLSCertificateExpired
        expr: |
          probe_ssl_earliest_cert_expiry - time() < 0
        for: 1m
        labels:
          severity: critical
          component: tls
        annotations:
          summary: "TLS certificate has EXPIRED"
          description: "Certificate for {{ $labels.instance }} has expired! Immediate action required."

      # Kubernetes cert-manager certificate not ready
      - alert: CertManagerCertificateNotReady
        expr: |
          certmanager_certificate_ready_status{condition="False"} == 1
        for: 15m
        labels:
          severity: warning
          component: tls
        annotations:
          summary: "cert-manager certificate not ready"
          description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} is not ready."

      # Kubernetes cert-manager certificate renewal failed
      - alert: CertManagerCertificateRenewalFailed
        expr: |
          certmanager_certificate_renewal_timestamp_seconds - time() > 0
          and certmanager_certificate_ready_status{condition="False"} == 1
        for: 30m
        labels:
          severity: critical
          component: tls
        annotations:
          summary: "cert-manager certificate renewal failed"
          description: "Certificate {{ $labels.name }} renewal appears to have failed."

  - name: aragora_billing
    interval: 60s
    rules:
      # Stripe webhook failures
      - alert: StripeWebhookFailures
        expr: |
          sum(rate(aragora_stripe_webhook_errors_total[5m])) > 0.1
        for: 10m
        labels:
          severity: warning
          component: billing
        annotations:
          summary: "High Stripe webhook failure rate"
          description: "Stripe webhooks are failing. Check billing integration."

      # Subscription sync issues
      - alert: BillingSubscriptionSyncLag
        expr: |
          time() - aragora_billing_last_sync_timestamp > 3600
        for: 5m
        labels:
          severity: warning
          component: billing
        annotations:
          summary: "Billing subscription sync is stale"
          description: "Last billing sync was more than 1 hour ago."

  - name: aragora_nomic_loop
    interval: 60s
    rules:
      # Nomic loop stuck
      - alert: NomicLoopStuck
        expr: |
          aragora_nomic_loop_phase_duration_seconds > 1800
        for: 5m
        labels:
          severity: warning
          component: nomic
        annotations:
          summary: "Nomic loop phase taking too long"
          description: "Nomic loop phase {{ $labels.phase }} has been running for {{ $value | humanizeDuration }}."

      # Nomic loop failures
      - alert: NomicLoopFailureRate
        expr: |
          sum(rate(aragora_nomic_loop_failures_total[1h])) / sum(rate(aragora_nomic_loop_cycles_total[1h])) > 0.5
        for: 30m
        labels:
          severity: warning
          component: nomic
        annotations:
          summary: "High Nomic loop failure rate"
          description: "More than 50% of Nomic loop cycles are failing."

  - name: aragora_security
    interval: 30s
    rules:
      # Brute force detection - many failed logins
      - alert: AuthBruteForceAttempt
        expr: |
          sum(rate(aragora_auth_failures_total[5m])) > 10
        for: 2m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "Possible brute force attack"
          description: "High rate of authentication failures detected. {{ $value | printf \"%.0f\" }} failures/min."
          runbook_url: "https://docs.aragora.ai/runbook/brute-force"

      # Account lockouts
      - alert: AccountLockoutSpike
        expr: |
          sum(rate(aragora_account_lockouts_total[15m])) > 5
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "Account lockout spike"
          description: "Multiple accounts being locked out. Possible attack or misconfigured client."

      # Invalid API tokens
      - alert: InvalidTokenSpike
        expr: |
          sum(rate(aragora_auth_invalid_token_total[5m])) > 20
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "High invalid token rate"
          description: "Many requests with invalid API tokens. Possible credential stuffing."

      # SSO failures
      - alert: SSOAuthFailures
        expr: |
          sum(rate(aragora_sso_failures_total[15m])) > 5
        for: 10m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "High SSO authentication failure rate"
          description: "SSO authentication is failing. Check IdP connectivity."

      # Suspicious user activity (high request rate from single user)
      - alert: SuspiciousUserActivity
        expr: |
          sum by (user_id) (rate(aragora_requests_by_user_total[5m])) > 100
        for: 5m
        labels:
          severity: info
          component: security
        annotations:
          summary: "Suspicious user activity"
          description: "User {{ $labels.user_id }} has unusually high request rate."

      # Admin API access from unusual IP
      - alert: AdminAPIFromNewIP
        expr: |
          increase(aragora_admin_api_new_ip_total[1h]) > 0
        for: 1m
        labels:
          severity: info
          component: security
        annotations:
          summary: "Admin API accessed from new IP"
          description: "Admin API was accessed from a new IP address. Verify legitimacy."

  - name: aragora_rate_limiting
    interval: 30s
    rules:
      # Rate limit near exhaustion for user
      - alert: UserRateLimitNearExhaustion
        expr: |
          aragora_user_rate_limit_remaining / aragora_user_rate_limit_max < 0.1
        for: 5m
        labels:
          severity: info
          component: rate_limit
        annotations:
          summary: "User rate limit nearly exhausted"
          description: "User {{ $labels.user_id }} has used 90%+ of their rate limit."

      # Global rate limiter at capacity
      - alert: GlobalRateLimiterAtCapacity
        expr: |
          aragora_global_rate_limit_capacity < 0.2
        for: 5m
        labels:
          severity: warning
          component: rate_limit
        annotations:
          summary: "Global rate limiter nearing capacity"
          description: "System is approaching global rate limit capacity."

  - name: aragora_memory_store
    interval: 60s
    rules:
      # Memory tier full
      - alert: MemoryTierFull
        expr: |
          aragora_memory_tier_size{tier="fast"} > aragora_memory_tier_max{tier="fast"} * 0.9
        for: 5m
        labels:
          severity: warning
          component: memory
        annotations:
          summary: "Memory tier {{ $labels.tier }} nearly full"
          description: "Memory tier {{ $labels.tier }} is at 90% capacity. Consider cleanup."

      # Memory eviction rate high
      - alert: HighMemoryEvictionRate
        expr: |
          sum(rate(aragora_memory_evictions_total[15m])) > 100
        for: 10m
        labels:
          severity: warning
          component: memory
        annotations:
          summary: "High memory eviction rate"
          description: "Memory is being evicted at a high rate. May affect debate continuity."
