# Aragora Demo â€” Full-Stack One-Click Deployment
#
# Usage:
#   docker compose -f deploy/demo/docker-compose.yml up --build
#
# This starts the complete Aragora platform in offline/demo mode:
# - Backend API on http://localhost:8080 (REST + health endpoints)
# - WebSocket on ws://localhost:8765 (live debate streaming)
# - Frontend UI on http://localhost:3000 (Next.js dashboard)
# - SQLite backend (no external database needed)
# - Mock agents (no API keys needed)
# - Demo data pre-loaded (8 agents, 10 debates, trending topics)
#
# For production deployment, see deploy/kubernetes/ or deploy/openclaw/

services:
  # -------------------------------------------------------------------------
  # Backend: Aragora API + WebSocket server
  # -------------------------------------------------------------------------
  backend:
    build:
      context: ../..
      dockerfile: deploy/demo/Dockerfile
    ports:
      - "8080:8080"
      - "8765:8765"
    environment:
      # Offline mode: no external APIs needed
      - ARAGORA_OFFLINE=true
      - ARAGORA_DEMO_MODE=true
      - ARAGORA_DB_BACKEND=sqlite
      - ARAGORA_ENV=development
      - ARAGORA_SEED_DEMO=true
      # Server config
      - ARAGORA_API_PORT=8080
      - ARAGORA_WS_PORT=8765
      - ARAGORA_ALLOWED_ORIGINS=*
      # Disable features that need external services
      - ARAGORA_DISABLE_TELEMETRY=true
      - ARAGORA_DISABLE_REDIS=true
    volumes:
      - demo-data:/app/data
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/api/v1/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped

  # -------------------------------------------------------------------------
  # Frontend: Next.js dashboard
  # -------------------------------------------------------------------------
  frontend:
    build:
      context: ../..
      dockerfile: deploy/Dockerfile.frontend
      args:
        NEXT_PUBLIC_API_URL: http://localhost:8080
        NEXT_PUBLIC_WS_URL: ws://localhost:8765/ws
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - NEXT_PUBLIC_WS_URL=ws://localhost:8765/ws
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped

volumes:
  demo-data:
