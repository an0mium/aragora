# Prometheus Alert Rules for Aragora

groups:
  - name: aragora-availability
    rules:
      # Instance down
      - alert: InstanceDown
        expr: up{job="aragora-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Aragora backend instance is down"
          description: "Instance {{ $labels.instance }} has been down for more than 1 minute."
          runbook_url: "https://docs.aragora.ai/runbook#instance-down"

      # Health check failing
      - alert: HealthCheckFailing
        expr: probe_success{job="aragora-health"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Aragora health check is failing"
          description: "Health check for {{ $labels.instance }} has been failing for 2 minutes."
          runbook_url: "https://docs.aragora.ai/runbook#health-check-failing"

  - name: aragora-performance
    rules:
      # High API latency
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, sum(rate(aragora_http_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: high
        annotations:
          summary: "API latency is high"
          description: "95th percentile API latency is above 2 seconds (current: {{ $value | humanizeDuration }})."
          runbook_url: "https://docs.aragora.ai/runbook#high-latency"

      # High error rate
      - alert: APIErrorRate
        expr: sum(rate(aragora_http_requests_total{status=~"5.."}[5m])) / sum(rate(aragora_http_requests_total[5m])) * 100 > 5
        for: 5m
        labels:
          severity: high
        annotations:
          summary: "API error rate is high"
          description: "Error rate is above 5% (current: {{ $value | printf \"%.2f\" }}%)."
          runbook_url: "https://docs.aragora.ai/runbook#high-error-rate"

      # Debate completion rate low
      - alert: LowDebateCompletionRate
        expr: rate(aragora_debates_completed_total[1h]) / rate(aragora_debates_started_total[1h]) < 0.9
        for: 30m
        labels:
          severity: high
        annotations:
          summary: "Debate completion rate is low"
          description: "Less than 90% of debates are completing successfully."
          runbook_url: "https://docs.aragora.ai/runbook#debate-issues"

  - name: aragora-resources
    rules:
      # High memory usage
      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes{job="aragora-backend"} / 1024 / 1024 / 1024 > 1.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Memory usage is high"
          description: "Backend memory usage is above 1.5GB (current: {{ $value | printf \"%.2f\" }}GB)."
          runbook_url: "https://docs.aragora.ai/runbook#high-memory"

      # High CPU usage
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total{job="aragora-backend"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "CPU usage is high"
          description: "Backend CPU usage is above 80% (current: {{ $value | printf \"%.2f\" }}%)."
          runbook_url: "https://docs.aragora.ai/runbook#high-cpu"

  - name: aragora-agents
    rules:
      # Agent timeout rate high
      - alert: AgentTimeoutRateHigh
        expr: rate(aragora_agent_timeouts_total[15m]) / rate(aragora_agent_requests_total[15m]) * 100 > 10
        for: 10m
        labels:
          severity: high
        annotations:
          summary: "Agent timeout rate is high"
          description: "More than 10% of agent requests are timing out."
          runbook_url: "https://docs.aragora.ai/runbook#agent-timeouts"

      # External API quota warning
      - alert: ExternalAPIQuotaLow
        expr: aragora_external_api_remaining{provider=~"anthropic|openai"} < 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "External API quota is low"
          description: "{{ $labels.provider }} API has less than 1000 requests remaining."
          runbook_url: "https://docs.aragora.ai/runbook#api-quota"

  - name: aragora-database
    rules:
      # Redis connection issues
      - alert: RedisConnectionIssues
        expr: aragora_redis_connection_errors_total > 0
        for: 5m
        labels:
          severity: high
        annotations:
          summary: "Redis connection issues detected"
          description: "There are Redis connection errors occurring."
          runbook_url: "https://docs.aragora.ai/runbook#redis-issues"

      # Database connection pool exhausted
      - alert: DatabasePoolExhausted
        expr: aragora_db_pool_available == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database connection pool exhausted"
          description: "No database connections available in the pool."
          runbook_url: "https://docs.aragora.ai/runbook#db-pool-exhausted"

  - name: aragora-rate-limiting
    rules:
      # Rate limiting too many requests
      - alert: RateLimitingExcessive
        expr: sum(rate(aragora_ratelimit_rejected_total[5m])) / sum(rate(aragora_http_requests_total[5m])) * 100 > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Rate limiting is rejecting many requests"
          description: "More than 10% of requests are being rate limited."
          runbook_url: "https://docs.aragora.ai/runbook#rate-limiting"

  - name: aragora-websocket
    rules:
      # WebSocket connection issues
      - alert: WebSocketErrorRate
        expr: rate(aragora_websocket_errors_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "WebSocket errors occurring"
          description: "WebSocket errors are happening at rate > 1/minute."
          runbook_url: "https://docs.aragora.ai/runbook#websocket-issues"

      # Too many concurrent WebSocket connections
      - alert: HighWebSocketConnections
        expr: aragora_websocket_connections_active > 500
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High number of WebSocket connections"
          description: "There are more than 500 active WebSocket connections."
          runbook_url: "https://docs.aragora.ai/runbook#high-ws-connections"

  # ==========================================================================
  # SLO Recording Rules
  # Pre-compute SLO metrics for efficient alerting and dashboards
  # ==========================================================================

  - name: aragora-slo-recording
    interval: 30s
    rules:
      # API Availability SLO (99.9% target)
      - record: slo:api_availability:ratio5m
        expr: |
          1 - (
            sum(rate(aragora_http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(aragora_http_requests_total[5m]))
          )

      # API p99 Latency SLO (500ms target)
      - record: slo:api_latency_p99:seconds
        expr: |
          histogram_quantile(0.99, sum(rate(aragora_http_request_duration_seconds_bucket[5m])) by (le))

      # Debate Success Rate SLO (95% target)
      - record: slo:debate_success:ratio5m
        expr: |
          sum(rate(aragora_debates_completed_total[5m]))
          /
          sum(rate(aragora_debates_started_total[5m]))

      # Error budget remaining (availability)
      - record: slo:api_availability:error_budget_remaining
        expr: |
          1 - (
            (1 - slo:api_availability:ratio5m) / 0.001
          )

      # Error budget remaining (debate success)
      - record: slo:debate_success:error_budget_remaining
        expr: |
          1 - (
            (1 - slo:debate_success:ratio5m) / 0.05
          )

      # Burn rate (1h window)
      - record: slo:api_availability:burn_rate_1h
        expr: |
          (1 - slo:api_availability:ratio5m) / 0.001

      # Burn rate (6h window)
      - record: slo:api_availability:burn_rate_6h
        expr: |
          (1 - (
            1 - (
              sum(increase(aragora_http_requests_total{status=~"5.."}[6h]))
              /
              sum(increase(aragora_http_requests_total[6h]))
            )
          )) / 0.001

  # ==========================================================================
  # SLO Alerting Rules
  # Multi-window, multi-burn-rate alerts for SLO violations
  # ==========================================================================

  - name: aragora-slo-alerts
    rules:
      # SLO: API Availability - Critical (fast burn)
      - alert: SLOAvailabilityBudgetBurning
        expr: |
          slo:api_availability:burn_rate_1h > 14.4
          and
          slo:api_availability:burn_rate_6h > 6
        for: 2m
        labels:
          severity: critical
          slo: availability
        annotations:
          summary: "API availability SLO error budget is burning fast"
          description: "Error budget is depleting rapidly. 1h burn rate: {{ $value | printf \"%.1f\" }}x expected."
          runbook_url: "https://docs.aragora.ai/runbook#slo-availability"

      # SLO: API Availability - Warning (slow burn)
      - alert: SLOAvailabilityBudgetBurning
        expr: |
          slo:api_availability:burn_rate_1h > 3
          and
          slo:api_availability:error_budget_remaining < 0.5
        for: 15m
        labels:
          severity: warning
          slo: availability
        annotations:
          summary: "API availability SLO error budget is depleting"
          description: "Error budget is below 50%. Remaining: {{ $value | printf \"%.1f\" }}%."
          runbook_url: "https://docs.aragora.ai/runbook#slo-availability"

      # SLO: API Availability - Exhausted
      - alert: SLOAvailabilityBudgetExhausted
        expr: slo:api_availability:error_budget_remaining < 0
        for: 5m
        labels:
          severity: critical
          slo: availability
        annotations:
          summary: "API availability SLO error budget exhausted"
          description: "Error budget is completely exhausted. Availability is below 99.9%."
          runbook_url: "https://docs.aragora.ai/runbook#slo-availability-exhausted"

      # SLO: API Latency - Warning
      - alert: SLOLatencyWarning
        expr: slo:api_latency_p99:seconds > 0.5
        for: 5m
        labels:
          severity: warning
          slo: latency
        annotations:
          summary: "API p99 latency exceeding SLO target"
          description: "p99 latency is {{ $value | humanizeDuration }} (target: 500ms)."
          runbook_url: "https://docs.aragora.ai/runbook#slo-latency"

      # SLO: API Latency - Critical
      - alert: SLOLatencyCritical
        expr: slo:api_latency_p99:seconds > 1
        for: 5m
        labels:
          severity: critical
          slo: latency
        annotations:
          summary: "API p99 latency critically high"
          description: "p99 latency is {{ $value | humanizeDuration }} (2x SLO target)."
          runbook_url: "https://docs.aragora.ai/runbook#slo-latency-critical"

      # SLO: Debate Success - Warning
      - alert: SLODebateSuccessWarning
        expr: slo:debate_success:ratio5m < 0.95
        for: 15m
        labels:
          severity: warning
          slo: debate_success
        annotations:
          summary: "Debate success rate below SLO target"
          description: "Debate success rate is {{ $value | printf \"%.1f\" }}% (target: 95%)."
          runbook_url: "https://docs.aragora.ai/runbook#slo-debate-success"

      # SLO: Debate Success - Budget Exhausted
      - alert: SLODebateSuccessBudgetExhausted
        expr: slo:debate_success:error_budget_remaining < 0
        for: 10m
        labels:
          severity: critical
          slo: debate_success
        annotations:
          summary: "Debate success SLO error budget exhausted"
          description: "Debate success rate is significantly below 95% target."
          runbook_url: "https://docs.aragora.ai/runbook#slo-debate-exhausted"
