# Secrets Rotation CronJob
# Runs automated secret rotation on a schedule
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secrets-rotation
  namespace: aragora
  labels:
    app.kubernetes.io/name: secrets-rotation
    app.kubernetes.io/component: security
    app.kubernetes.io/part-of: aragora
spec:
  # Run daily at 2 AM UTC (off-peak hours)
  schedule: "0 2 * * *"

  # Timezone for schedule
  timeZone: "UTC"

  # Don't start new job if previous is still running
  concurrencyPolicy: Forbid

  # Keep last 3 successful and 1 failed job for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1

  # Start within 5 minutes of scheduled time
  startingDeadlineSeconds: 300

  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: secrets-rotation
    spec:
      # Retry up to 3 times on failure
      backoffLimit: 3

      # Job should complete within 1 hour
      activeDeadlineSeconds: 3600

      template:
        metadata:
          labels:
            app.kubernetes.io/name: secrets-rotation
          annotations:
            # Prevent Istio sidecar from blocking job completion
            sidecar.istio.io/inject: "false"
        spec:
          restartPolicy: OnFailure

          serviceAccountName: secrets-rotation

          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            fsGroup: 1000
            seccompProfile:
              type: RuntimeDefault

          containers:
            - name: rotation
              image: ghcr.io/an0mium/aragora/secrets-rotation:2.1.10
              imagePullPolicy: Always

              command:
                - python
                - -m
                - aragora.scheduler.run_rotation

              args:
                - --dry-run=false
                - --notify-on-failure
                - --log-level=info

              env:
                - name: ROTATION_MODE
                  value: "scheduled"

                # AWS Secrets Manager region
                - name: AWS_REGION
                  value: "us-east-2"

                # Notification webhook
                - name: SLACK_WEBHOOK_URL
                  valueFrom:
                    secretKeyRef:
                      name: aragora-secrets
                      key: slack-webhook-url
                      optional: true

                # Database connection for rotation state
                - name: DATABASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: aragora-secrets
                      key: database-url

              # Mount secrets and config
              volumeMounts:
                - name: rotation-config
                  mountPath: /etc/aragora/rotation
                  readOnly: true

                - name: aws-credentials
                  mountPath: /root/.aws
                  readOnly: true

              resources:
                limits:
                  cpu: 500m
                  memory: 512Mi
                requests:
                  cpu: 100m
                  memory: 256Mi

              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL

          volumes:
            - name: rotation-config
              configMap:
                name: secrets-rotation-config

            - name: aws-credentials
              secret:
                secretName: aws-credentials
                optional: true

---
# ServiceAccount for secrets rotation
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secrets-rotation
  namespace: aragora
  labels:
    app.kubernetes.io/name: secrets-rotation
  annotations:
    # AWS IRSA annotation
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/aragora-secrets-rotation

---
# RBAC for reading/updating secrets
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secrets-rotation
  namespace: aragora
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "update", "patch"]

  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]

  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secrets-rotation
  namespace: aragora
subjects:
  - kind: ServiceAccount
    name: secrets-rotation
    namespace: aragora
roleRef:
  kind: Role
  name: secrets-rotation
  apiGroup: rbac.authorization.k8s.io

---
# ConfigMap for rotation configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: secrets-rotation-config
  namespace: aragora
  labels:
    app.kubernetes.io/name: secrets-rotation
data:
  rotation.yaml: |
    # Secrets rotation configuration
    rotation:
      # Global settings
      dry_run: false
      notify_on_success: false
      notify_on_failure: true

      # Grace period before revoking old credentials
      grace_period_hours: 24

      # GitHub Secrets sync (push to GitHub after rotation)
      github_sync:
        repo: "aragora-ai/aragora"

      # Secrets to rotate
      secrets:
        # ================================================================
        # Database credentials (90-day rotation)
        # ================================================================
        - id: postgres_aragora_rw
          type: database
          rotation_interval_days: 90
          metadata:
            db_type: postgresql
            host: postgres.aragora.svc.cluster.local
            database: aragora
            username: aragora_rw

        - id: DATABASE_URL
          type: database
          rotation_interval_days: 90
          metadata:
            db_type: postgresql
            github_secret_name: DATABASE_URL

        - id: REDIS_URL
          type: database
          rotation_interval_days: 90
          metadata:
            db_type: redis
            github_secret_name: REDIS_URL

        - id: SUPABASE_DB_PASSWORD
          type: database
          rotation_interval_days: 90
          metadata:
            db_type: supabase
            github_secret_name: SUPABASE_DB_PASSWORD

        # ================================================================
        # OAuth tokens (refresh automatically, 7-day rotation)
        # ================================================================
        - id: google_oauth
          type: oauth
          rotation_interval_days: 7
          metadata:
            provider: google

        - id: GOOGLE_OAUTH_CLIENT_SECRET
          type: oauth
          rotation_interval_days: 7
          metadata:
            provider: google
            github_secret_name: GOOGLE_OAUTH_CLIENT_SECRET

        # ================================================================
        # Self-generated secrets (no external API needed)
        # ================================================================

        # JWT secrets (30-day rotation)
        - id: ARAGORA_JWT_SECRET
          type: encryption_key
          rotation_interval_days: 30
          metadata:
            key_type: jwt
            jwt_algorithm: HS256
            github_secret_name: ARAGORA_JWT_SECRET

        - id: OAUTH_JWT_SECRET
          type: encryption_key
          rotation_interval_days: 30
          metadata:
            key_type: jwt
            jwt_algorithm: HS256
            github_secret_name: OAUTH_JWT_SECRET

        # Encryption keys (90-day rotation)
        - id: ARAGORA_ENCRYPTION_KEY
          type: encryption_key
          rotation_interval_days: 90
          metadata:
            key_type: aes256
            data_stores:
              - integrations
              - webhooks
              - gmail_tokens
            github_secret_name: ARAGORA_ENCRYPTION_KEY

        - id: ARAGORA_RECEIPT_SIGNING_KEY
          type: encryption_key
          rotation_interval_days: 90
          metadata:
            key_type: hmac
            github_secret_name: ARAGORA_RECEIPT_SIGNING_KEY

        - id: ARAGORA_SECRET_KEY
          type: encryption_key
          rotation_interval_days: 90
          metadata:
            key_type: aes256
            github_secret_name: ARAGORA_SECRET_KEY

        - id: encryption_key_primary
          type: encryption_key
          rotation_interval_days: 90
          metadata:
            key_type: aes256
            data_stores:
              - integrations
              - webhooks

        # ================================================================
        # API keys with programmatic rotation
        # ================================================================
        - id: ANTHROPIC_API_KEY
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: anthropic
            github_secret_name: ANTHROPIC_API_KEY

        - id: OPENAI_API_KEY
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: openai
            github_secret_name: OPENAI_API_KEY

        - id: STRIPE_SECRET_KEY
          type: api_key
          rotation_interval_days: 60
          metadata:
            provider: stripe
            github_secret_name: STRIPE_SECRET_KEY

        - id: CLOUDFLARE_API_TOKEN
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: cloudflare
            github_secret_name: CLOUDFLARE_API_TOKEN

        # ================================================================
        # API keys requiring manual rotation (notification-based)
        # ================================================================
        - id: MISTRAL_API_KEY
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: mistral
            github_secret_name: MISTRAL_API_KEY

        - id: GEMINI_API_KEY
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: google
            github_secret_name: GEMINI_API_KEY

        - id: XAI_API_KEY
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: xai
            github_secret_name: XAI_API_KEY

        - id: OPENROUTER_API_KEY
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: openrouter
            github_secret_name: OPENROUTER_API_KEY

        - id: DEEPSEEK_API_KEY
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: deepseek
            github_secret_name: DEEPSEEK_API_KEY

        - id: ELEVENLABS_API_KEY
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: elevenlabs
            github_secret_name: ELEVENLABS_API_KEY

        - id: SUPERMEMORY_API_KEY
          type: api_key
          rotation_interval_days: 90
          metadata:
            provider: supermemory
            github_secret_name: SUPERMEMORY_API_KEY

        - id: NPM_TOKEN
          type: api_key
          rotation_interval_days: 180
          metadata:
            provider: npm
            github_secret_name: NPM_TOKEN

      # Notification channels
      notifications:
        slack:
          enabled: true
          channel: "#aragora-security"
          mention_on_failure: "@oncall"

        email:
          enabled: false
          recipients:
            - security@aragora.ai

---
# PodDisruptionBudget (not really needed for CronJob but for completeness)
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: secrets-rotation
  namespace: aragora
spec:
  minAvailable: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: secrets-rotation
