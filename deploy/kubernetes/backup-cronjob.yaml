---
# Aragora Database Backup CronJob
# Runs daily backups of SQLite databases with 7-day rotation
#
# Prerequisites:
#   1. PersistentVolumeClaim 'aragora-data' exists
#   2. PersistentVolumeClaim 'aragora-backups' exists (or create one below)
#
# The backup script:
#   - Uses SQLite's backup API for consistency during writes
#   - Compresses backups with gzip
#   - Rotates backups, keeping last 7 by default
#   - Writes a manifest.json for each backup run
#
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: aragora-backups
  namespace: aragora
  labels:
    app.kubernetes.io/name: aragora
    app.kubernetes.io/component: backup
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  # Uncomment to use a specific storage class
  # storageClassName: standard

---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: aragora-backup
  namespace: aragora
  labels:
    app.kubernetes.io/name: aragora
    app.kubernetes.io/component: backup
spec:
  # Run daily at 2:00 AM UTC
  schedule: "0 2 * * *"
  # Keep history of last 3 successful and 1 failed jobs
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  # Don't run if previous backup is still running
  concurrencyPolicy: Forbid
  # Start deadline - if job can't start within 1 hour, skip it
  startingDeadlineSeconds: 3600
  jobTemplate:
    metadata:
      labels:
        app.kubernetes.io/name: aragora
        app.kubernetes.io/component: backup
    spec:
      # Retry up to 2 times on failure
      backoffLimit: 2
      # Cleanup completed pods after 1 hour
      ttlSecondsAfterFinished: 3600
      template:
        metadata:
          labels:
            app.kubernetes.io/name: aragora
            app.kubernetes.io/component: backup
        spec:
          restartPolicy: OnFailure
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            fsGroup: 1000
          containers:
            - name: backup
              image: aragora/aragora:0.8.0
              imagePullPolicy: IfNotPresent
              command:
                - python
                - scripts/backup_databases.py
                - --backup-dir
                - /backups
                - --root
                - /data
                - --keep
                - "7"
              resources:
                requests:
                  cpu: "100m"
                  memory: "256Mi"
                limits:
                  cpu: "500m"
                  memory: "512Mi"
              volumeMounts:
                - name: data
                  mountPath: /data
                  readOnly: true
                - name: backups
                  mountPath: /backups
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop:
                    - ALL
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: aragora-data
            - name: backups
              persistentVolumeClaim:
                claimName: aragora-backups

---
# Optional: ServiceAccount for backup job (if RBAC is required)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aragora-backup
  namespace: aragora
  labels:
    app.kubernetes.io/name: aragora
    app.kubernetes.io/component: backup

---
# Optional: Manual backup Job (run with: kubectl create job --from=cronjob/aragora-backup manual-backup)
# Or use this template directly for one-off backups
apiVersion: batch/v1
kind: Job
metadata:
  name: aragora-backup-manual
  namespace: aragora
  labels:
    app.kubernetes.io/name: aragora
    app.kubernetes.io/component: backup
    app.kubernetes.io/instance: manual
spec:
  backoffLimit: 1
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: aragora
        app.kubernetes.io/component: backup
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
        - name: backup
          image: aragora/aragora:0.8.0
          imagePullPolicy: IfNotPresent
          command:
            - python
            - scripts/backup_databases.py
            - --backup-dir
            - /backups
            - --root
            - /data
            - --keep
            - "7"
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"
          volumeMounts:
            - name: data
              mountPath: /data
              readOnly: true
            - name: backups
              mountPath: /backups
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: aragora-data
        - name: backups
          persistentVolumeClaim:
            claimName: aragora-backups
