---
# Aragora External Secrets Configuration
# Uses the External Secrets Operator (https://external-secrets.io/)
# to sync secrets from external providers (Vault, AWS Secrets Manager, etc.)
#
# Prerequisites:
#   1. Install External Secrets Operator:
#      helm repo add external-secrets https://charts.external-secrets.io
#      helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
#
#   2. Configure a SecretStore/ClusterSecretStore for your provider
#
#   3. Create the secrets in your provider:
#      - aragora/api-keys/anthropic
#      - aragora/api-keys/openai
#      - aragora/api-keys/openrouter (optional)
#      - aragora/database/supabase-url
#      - aragora/database/supabase-key
#      - aragora/auth/api-token
#
# Supported Secret Stores:
#   - HashiCorp Vault
#   - AWS Secrets Manager
#   - Google Secret Manager
#   - Azure Key Vault
#   - 1Password
#   - Doppler
#
# Example ClusterSecretStore for Vault:
#   apiVersion: external-secrets.io/v1beta1
#   kind: ClusterSecretStore
#   metadata:
#     name: vault-backend
#   spec:
#     provider:
#       vault:
#         server: "https://vault.example.com"
#         path: "secret"
#         version: "v2"
#         auth:
#           kubernetes:
#             mountPath: "kubernetes"
#             role: "aragora"
#

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: aragora-secrets
  namespace: aragora
  labels:
    app.kubernetes.io/name: aragora
    app.kubernetes.io/component: secrets
spec:
  # Refresh interval - how often to sync secrets
  refreshInterval: 1h

  # Reference to the SecretStore
  secretStoreRef:
    name: vault-backend  # Change to your SecretStore name
    kind: ClusterSecretStore

  # Target Kubernetes secret that will be created
  target:
    name: aragora-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: Opaque
      metadata:
        labels:
          app.kubernetes.io/name: aragora
          app.kubernetes.io/component: secrets
          app.kubernetes.io/managed-by: external-secrets

  # Data mappings from external secret store
  data:
    # Required: AI Provider API Keys
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: aragora/api-keys
        property: anthropic
        decodingStrategy: None

    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: aragora/api-keys
        property: openai
        decodingStrategy: None

    # Optional: Additional AI Providers
    - secretKey: OPENROUTER_API_KEY
      remoteRef:
        key: aragora/api-keys
        property: openrouter
        decodingStrategy: None

    - secretKey: GEMINI_API_KEY
      remoteRef:
        key: aragora/api-keys
        property: gemini
        decodingStrategy: None

    - secretKey: XAI_API_KEY
      remoteRef:
        key: aragora/api-keys
        property: xai
        decodingStrategy: None

    - secretKey: MISTRAL_API_KEY
      remoteRef:
        key: aragora/api-keys
        property: mistral
        decodingStrategy: None

    # Database credentials
    - secretKey: SUPABASE_URL
      remoteRef:
        key: aragora/database
        property: supabase-url
        decodingStrategy: None

    - secretKey: SUPABASE_KEY
      remoteRef:
        key: aragora/database
        property: supabase-key
        decodingStrategy: None

    # Auth
    - secretKey: ARAGORA_API_TOKEN
      remoteRef:
        key: aragora/auth
        property: api-token
        decodingStrategy: None

    # Stripe (billing)
    - secretKey: STRIPE_SECRET_KEY
      remoteRef:
        key: aragora/billing
        property: stripe-secret
        decodingStrategy: None

    - secretKey: STRIPE_WEBHOOK_SECRET
      remoteRef:
        key: aragora/billing
        property: stripe-webhook
        decodingStrategy: None

---
# Alternative: AWS Secrets Manager Configuration
# Uncomment and modify if using AWS
#
# apiVersion: external-secrets.io/v1beta1
# kind: ExternalSecret
# metadata:
#   name: aragora-secrets-aws
#   namespace: aragora
# spec:
#   refreshInterval: 1h
#   secretStoreRef:
#     name: aws-secrets-manager
#     kind: ClusterSecretStore
#   target:
#     name: aragora-secrets
#   dataFrom:
#     - extract:
#         key: aragora/production
#         decodingStrategy: None

---
# Alternative: Google Secret Manager Configuration
# Uncomment and modify if using GCP
#
# apiVersion: external-secrets.io/v1beta1
# kind: ExternalSecret
# metadata:
#   name: aragora-secrets-gcp
#   namespace: aragora
# spec:
#   refreshInterval: 1h
#   secretStoreRef:
#     name: gcp-secret-manager
#     kind: ClusterSecretStore
#   target:
#     name: aragora-secrets
#   data:
#     - secretKey: ANTHROPIC_API_KEY
#       remoteRef:
#         key: aragora-anthropic-api-key
#
#     - secretKey: OPENAI_API_KEY
#       remoteRef:
#         key: aragora-openai-api-key
