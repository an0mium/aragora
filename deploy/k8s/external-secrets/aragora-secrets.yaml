# ExternalSecret for Aragora
#
# Pulls secrets from your configured ClusterSecretStore and creates
# a Kubernetes Secret that Aragora pods can consume.
#
# Prerequisites:
#   1. Install External Secrets Operator
#   2. Configure ClusterSecretStore (see cluster-secret-store.yaml)
#   3. Create secrets in your backend (AWS SM, Vault, etc.)
#
# Usage:
#   kubectl apply -f deploy/k8s/external-secrets/aragora-secrets.yaml

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: aragora-secrets
  namespace: aragora
  labels:
    app.kubernetes.io/name: aragora
    app.kubernetes.io/component: secrets
spec:
  # How often to sync secrets from the backend
  refreshInterval: 1h

  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: aws-secrets-manager  # UPDATE: Match your ClusterSecretStore name
    kind: ClusterSecretStore

  # Target Kubernetes Secret to create
  target:
    name: aragora-secrets
    creationPolicy: Owner
    deletionPolicy: Retain

  # Secret data mappings
  # The remote key format depends on your backend:
  # - AWS SM: "aragora/production/api-keys"
  # - Vault: "secret/data/aragora/production/api-keys"
  # - GCP SM: "projects/xxx/secrets/aragora-api-keys/versions/latest"
  data:
    # Database
    - secretKey: database-url
      remoteRef:
        key: aragora/production/database
        property: url

    # JWT Secret
    - secretKey: jwt-secret
      remoteRef:
        key: aragora/production/auth
        property: jwt-secret

    # AI Provider Keys
    - secretKey: anthropic-api-key
      remoteRef:
        key: aragora/production/api-keys
        property: anthropic

    - secretKey: openai-api-key
      remoteRef:
        key: aragora/production/api-keys
        property: openai

    - secretKey: openrouter-api-key
      remoteRef:
        key: aragora/production/api-keys
        property: openrouter

    # Stripe (if using billing)
    - secretKey: stripe-secret-key
      remoteRef:
        key: aragora/production/stripe
        property: secret-key

    - secretKey: stripe-webhook-secret
      remoteRef:
        key: aragora/production/stripe
        property: webhook-secret

---
# Alternative: Environment-specific ExternalSecrets
# Use this pattern for staging/production variations

# apiVersion: external-secrets.io/v1beta1
# kind: ExternalSecret
# metadata:
#   name: aragora-secrets-staging
#   namespace: aragora-staging
# spec:
#   secretStoreRef:
#     name: aws-secrets-manager
#     kind: ClusterSecretStore
#   target:
#     name: aragora-secrets
#   dataFrom:
#     - extract:
#         key: aragora/staging  # All keys under this path become secret data
