# ExternalSecret for Aragora
#
# Pulls secrets from your configured ClusterSecretStore and creates
# a Kubernetes Secret that Aragora pods can consume.
#
# Prerequisites:
#   1. Install External Secrets Operator
#   2. Configure ClusterSecretStore (see cluster-secret-store.yaml)
#   3. Create secrets in your backend (AWS SM, Vault, etc.)
#
# Usage:
#   kubectl apply -f deploy/k8s/external-secrets/aragora-secrets.yaml

apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: aragora-secrets
  namespace: aragora
  labels:
    app.kubernetes.io/name: aragora
    app.kubernetes.io/component: secrets
spec:
  # How often to sync secrets from the backend
  refreshInterval: 1h

  # Reference to the ClusterSecretStore
  secretStoreRef:
    name: aws-secrets-manager  # UPDATE: Match your ClusterSecretStore name
    kind: ClusterSecretStore

  # Target Kubernetes Secret to create
  target:
    name: aragora-secrets
    creationPolicy: Owner
    deletionPolicy: Retain

  # Secret data mappings
  # The remote key format depends on your backend:
  # - AWS SM: "aragora/production/api-keys"
  # - Vault: "secret/data/aragora/production/api-keys"
  # - GCP SM: "projects/xxx/secrets/aragora-api-keys/versions/latest"
  data:
    # JWT Secret
    - secretKey: ARAGORA_JWT_SECRET
      remoteRef:
        key: aragora/production/auth
        property: jwt-secret

    # AI Provider Keys (uppercase to match Helm chart expectations)
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: aragora/production/api-keys
        property: anthropic

    - secretKey: OPENAI_API_KEY
      remoteRef:
        key: aragora/production/api-keys
        property: openai

    - secretKey: OPENROUTER_API_KEY
      remoteRef:
        key: aragora/production/api-keys
        property: openrouter

    # Supabase (PostgreSQL + Auth + Realtime)
    - secretKey: SUPABASE_URL
      remoteRef:
        key: aragora/production/supabase
        property: url

    - secretKey: SUPABASE_KEY
      remoteRef:
        key: aragora/production/supabase
        property: service-role-key

    - secretKey: NEXT_PUBLIC_SUPABASE_ANON_KEY
      remoteRef:
        key: aragora/production/supabase
        property: anon-key

    # PostgreSQL connection string (for direct DB access)
    - secretKey: DATABASE_URL
      remoteRef:
        key: aragora/production/supabase
        property: postgres-dsn

    - secretKey: ARAGORA_POSTGRES_DSN
      remoteRef:
        key: aragora/production/supabase
        property: postgres-dsn

    # Redis (for caching/sessions)
    - secretKey: REDIS_PASSWORD
      remoteRef:
        key: aragora/production/redis
        property: password

    - secretKey: REDIS_URL
      remoteRef:
        key: aragora/production/redis
        property: url

    # Stripe (if using billing)
    - secretKey: STRIPE_SECRET_KEY
      remoteRef:
        key: aragora/production/stripe
        property: secret-key

    - secretKey: STRIPE_WEBHOOK_SECRET
      remoteRef:
        key: aragora/production/stripe
        property: webhook-secret

---
# Alternative: Environment-specific ExternalSecrets
# Use this pattern for staging/production variations

# apiVersion: external-secrets.io/v1beta1
# kind: ExternalSecret
# metadata:
#   name: aragora-secrets-staging
#   namespace: aragora-staging
# spec:
#   secretStoreRef:
#     name: aws-secrets-manager
#     kind: ClusterSecretStore
#   target:
#     name: aragora-secrets
#   dataFrom:
#     - extract:
#         key: aragora/staging  # All keys under this path become secret data
