# Aragora External Penetration Test -- Scope Document

**Version:** 2.0.0
**Classification:** Confidential
**Date:** February 2026
**SOC 2 Control:** CC7.1 (Security Testing)
**Platform:** Aragora Decision Integrity Platform

---

## Engagement Overview

Aragora is a multi-agent Decision Integrity Platform that orchestrates 42+ AI agent
types to adversarially vet decisions, producing audit-ready decision receipts. The
platform exposes HTTP REST APIs, WebSocket streaming, JWT/OIDC authentication,
multi-tenant RBAC, and an OpenClaw agent gateway.

| Parameter | Value |
|-----------|-------|
| Testing approach | Gray-box (API docs, architecture overview, test credentials provided) |
| Duration | 2--3 weeks active testing |
| Frequency | Annual full assessment; quarterly automated scans |

---

## In-Scope Attack Surface

### 1. HTTP API Surface

| Component | Source Location | Details |
|-----------|----------------|---------|
| Unified Server | `aragora/server/unified_server.py` | 2,000+ API operations across 1,800+ route paths |
| Handler Modules | `aragora/server/handlers/` | 580+ handler modules covering debates, admin, billing, knowledge, workflows, etc. |
| Request Lifecycle | `aragora/server/request_lifecycle.py` | Request parsing, body deserialization, content-length enforcement |
| Request Utilities | `aragora/server/request_utils.py` | `MAX_JSON_CONTENT_LENGTH` enforcement, JSON body parsing |
| Response Utilities | `aragora/server/response_utils.py` | Response serialization, error message formatting |

**Key API categories and base paths:**

| Category | Path Pattern | Priority |
|----------|-------------|----------|
| Authentication | `/api/v2/auth/*`, `/api/auth/*` | Critical |
| Admin / System | `/api/v2/admin/*` | Critical |
| Billing / Payments | `/api/v2/billing/*`, `/api/v2/payments/*` | Critical |
| Debates | `/api/v2/debates/*` | High |
| Users / Tenancy | `/api/v2/users/*`, `/api/v2/workspaces/*` | High |
| Knowledge Mound | `/api/v2/knowledge/*` | Medium |
| Workflows | `/api/v2/workflows/*` | Medium |
| OpenClaw Gateway | `/api/gateway/openclaw/*` | High |
| Health / Status | `/healthz`, `/readyz`, `/api/health/*` | Low |

### 2. WebSocket Streaming

| Component | Source Location | Details |
|-----------|----------------|---------|
| Debate Stream Server | `aragora/server/stream/servers.py` | Real-time debate events (190+ event types) |
| WebSocket Handler | `aragora/server/stream/servers_ws_handler.py` | Connection lifecycle, message dispatch |
| Voice Stream | `aragora/server/stream/voice_stream.py` | Voice session management and TTS |
| Gateway Stream | `aragora/server/stream/gateway_stream.py` | Gateway-level WebSocket events |
| Autonomous Stream | `aragora/server/stream/autonomous_stream.py` | Autonomous agent event feeds |
| Resume Tokens | `aragora/server/stream/resume_token.py` | Connection resume/reconnect tokens |

**Testing focus:** Authentication on WebSocket upgrade, message injection, event
subscription authorization, connection exhaustion, and resume token replay.

### 3. Authentication

| Component | Source Location | Details |
|-----------|----------------|---------|
| Auth Checks Mixin | `aragora/server/auth_checks.py` | Token extraction, auth-exempt path list, rate limiting |
| OIDC Provider | `aragora/auth/oidc.py` | OpenID Connect flows (Azure AD, Okta, Google, Auth0, Keycloak) |
| SAML Provider | `aragora/auth/saml.py` | SAML SSO integration |
| Token Rotation | `aragora/auth/token_rotation.py` | Rotation policies: max-use, time-based, IP-change, suspicious activity |
| Account Lockout | `aragora/auth/lockout.py` | Failed login lockout policy |
| Impersonation | `aragora/auth/impersonation.py` | Admin impersonation flows |
| Teams SSO | `aragora/auth/teams_sso.py` | Microsoft Teams SSO integration |
| Auth Middleware | `aragora/server/middleware/auth.py` | HTTP auth middleware |
| User Auth Middleware | `aragora/server/middleware/user_auth.py` | User-level auth middleware |
| MFA Middleware | `aragora/server/middleware/mfa.py` | Multi-factor authentication enforcement |
| Token Revocation | `aragora/server/middleware/token_revocation.py` | Revoked token checking |
| Impersonation Middleware | `aragora/server/middleware/impersonation.py` | Impersonation request handling |

**Auth-exempt paths** (defined in `auth_checks.py`): `/healthz`, `/readyz`,
`/api/health/*`, `/api/auth/oauth/providers`, `/api/openapi*`, `/api/docs/*`,
`/api/insights/recent`, `/api/flips/recent`, `/api/evidence`, `/api/evidence/statistics`,
`/api/verification/status`.

**Testing focus:** JWT signing algorithm confusion, token expiration bypass, `sub` claim
validation, OIDC state parameter fixation, redirect URI manipulation, MFA bypass, session
fixation, concurrent session handling, impersonation privilege escalation, token rotation
race conditions.

### 4. Authorization (RBAC v2)

| Component | Source Location | Details |
|-----------|----------------|---------|
| RBAC Models | `aragora/rbac/models.py` | Permission, Role, RoleAssignment, APIKeyScope, AuthorizationContext |
| Permission Checker | `aragora/rbac/checker.py` | Permission resolution with caching |
| RBAC Middleware | `aragora/rbac/middleware.py` | HTTP route permission enforcement (`DEFAULT_ROUTE_PERMISSIONS`) |
| RBAC Decorators | `aragora/rbac/decorators.py` | `@require_permission`, `@require_role` |
| Role Hierarchy | `aragora/rbac/hierarchy.py` | Parent role inheritance |
| RBAC Types | `aragora/rbac/types.py` | 7 default roles, hierarchical scopes (global/org/workspace/resource) |
| Delegation | `aragora/rbac/delegation.py` | Permission delegation between users |
| Emergency Access | `aragora/rbac/emergency.py` | Break-glass access mechanism |
| Conditions (ABAC) | `aragora/rbac/conditions.py` | Attribute-based access control conditions |
| Ownership | `aragora/rbac/ownership.py` | Resource ownership checks |
| RBAC Cache | `aragora/rbac/cache.py` | Permission decision caching |
| RBAC Audit | `aragora/rbac/audit.py` | Authorization audit logging |
| Resource Permissions | `aragora/rbac/resource_permissions.py` | Per-resource permission definitions |
| Quotas | `aragora/rbac/quotas.py` | Role-based resource quotas |

**Permission model:** 50+ permissions across 100+ resource types. Permissions use
`resource.action` keys (e.g., `debates.create`, `admin.system_config`). Wildcard
support: `resource.*` and `*`. Colon/dot format interchangeable (`debates:create` =
`debates.create`).

**Testing focus:** Horizontal privilege escalation (IDOR across tenants/workspaces),
vertical privilege escalation (role escalation to admin), permission cache poisoning,
wildcard permission abuse, delegation chain escalation, break-glass bypass without
audit, `APIKeyScope` with empty permissions granting full access (documented behavior --
verify intentional).

### 5. Multi-Tenancy Isolation

| Component | Source Location | Details |
|-----------|----------------|---------|
| Tenant Isolation Middleware | `aragora/server/middleware/tenant_isolation.py` | Fail-closed membership checks |
| Tenancy Middleware | `aragora/server/middleware/tenancy.py` | Tenant context propagation |
| Tenant Quotas | `aragora/tenancy/quotas.py` | Per-tenant resource quotas and usage tracking |

**Testing focus:** Cross-tenant data access, tenant context spoofing, quota bypass
between tenants, tenant ID injection in API requests.

### 6. OpenClaw Agent Gateway

| Component | Source Location | Details |
|-----------|----------------|---------|
| Standalone Server | `aragora/compat/openclaw/standalone.py` | Minimal HTTP server (independent of main stack) |
| Session Orchestrator | `aragora/server/handlers/openclaw/orchestrator.py` | Session and action management |
| Credential Store | `aragora/server/handlers/openclaw/store.py` | In-memory + SQLite persistent store |
| Credential Handlers | `aragora/server/handlers/openclaw/credentials.py` | Credential CRUD with AES-256-GCM |
| Policy Handlers | `aragora/server/handlers/openclaw/policies.py` | Policy management and health |
| Input Validation | `aragora/server/handlers/openclaw/validation.py` | Regex whitelisting, shell metachar blocking |
| Skill Scanner | `aragora/compat/openclaw/skill_scanner.py` | Malware pattern detection in skills |
| Computer Use Bridge | `aragora/compat/openclaw/computer_use_bridge.py` | Browser action bridging (SSRF risk: F07) |
| Sandbox | `aragora/compat/openclaw/openclaw_sandbox.py` | Workspace scoping, resource limits, path blocking |

**Testing focus:** See `docs/security/OPENCLAW_AUDIT.md` for 13 findings from the
prior OWASP Top 10 audit. Key areas: standalone server authentication bypass (F01),
credential encryption fallback (F02), SSRF via NavigateAction (F07), session expiration
absence (F10), CORS wildcard (F05).

### 7. File Upload Handling

| Component | Source Location | Details |
|-----------|----------------|---------|
| File Validation | `aragora/server/handlers/utils/file_validation.py` | Size limits, MIME whitelist, path traversal prevention |
| Smart Upload | `aragora/server/handlers/features/smart_upload.py` | Intelligent upload processing |
| Document Upload | `aragora/server/handlers/features/documents.py` | Document upload and batch processing |
| Cloud Storage | `aragora/server/handlers/cloud_storage.py` | Cloud storage file operations |
| Transcription Upload | `aragora/server/handlers/transcription.py` | Audio/video upload for transcription |

**Configuration:** `MAX_CONTENT_LENGTH = 100MB` (unified server), `DEFAULT_MAX_FILE_SIZE = 100MB`
(configurable via `ARAGORA_MAX_FILE_SIZE`), `MAX_MULTIPART_PARTS = 10`.

**Testing focus:** Path traversal in filenames, MIME type spoofing, polyglot file
uploads, null byte injection, double extension bypass, zip bomb / decompression bomb,
oversized multipart boundary attacks.

### 8. Database Layer

| Component | Source Location | Details |
|-----------|----------------|---------|
| PostgreSQL Store | `aragora/storage/postgres_store.py` | Production database |
| Schema Manager | `aragora/storage/schema.py` | SQLite/PostgreSQL schema versioning and migrations |
| Redis HA | `aragora/storage/redis_ha.py` | High-availability Redis |
| Repositories | `aragora/storage/repositories/` | Data access layer |

**Testing focus:** SQL injection via any endpoint backed by string-interpolated queries
(note: parameterized queries are standard -- verify no exceptions), migration injection,
connection string exposure.

### 9. Security Middleware Stack

| Component | Source Location | Purpose |
|-----------|----------------|---------|
| CSRF Protection | `aragora/server/middleware/csrf.py` | Double-submit cookie pattern |
| Security Headers | `aragora/server/middleware/security_headers.py` | X-Frame-Options, CSP, HSTS |
| XSS Protection | `aragora/server/middleware/xss_protection.py` | XSS filtering |
| Body Size Limit | `aragora/server/middleware/body_size_limit.py` | Request body size enforcement |
| Rate Limiting | `aragora/server/middleware/rate_limit/` | Multi-tier: IP, user, tenant, OAuth, platform, Redis-backed distributed |
| Tracing | `aragora/server/middleware/tracing.py` | Request correlation IDs |
| Audit Logger | `aragora/server/middleware/audit_logger.py` | Security event audit trail |
| ABAC | `aragora/server/middleware/abac.py` | Attribute-based access control |
| Timeout | `aragora/server/middleware/timeout.py` | Request timeout enforcement |
| Error Handler | `aragora/server/middleware/error_handler.py` | Safe error message sanitization |
| Deprecation | `aragora/server/middleware/deprecation.py` | API version deprecation headers |
| Budget Enforcement | `aragora/server/middleware/budget_enforcement.py` | Cost budget enforcement |
| Approval Gate | `aragora/server/middleware/approval_gate.py` | Approval workflow enforcement |
| Tier Enforcement | `aragora/server/middleware/tier_enforcement.py` | Plan tier feature gating |
| Validation | `aragora/server/middleware/validation.py` | Request validation |

### 10. Cryptographic Controls

| Component | Source Location | Details |
|-----------|----------------|---------|
| Encryption Service | `aragora/security/encryption.py` | AES-256-GCM, PBKDF2 key derivation, field-level encryption |
| Key Rotation | `aragora/security/key_rotation.py` | Automated 30/60/90-day rotation, KMS integration |
| KMS Provider | `aragora/security/kms_provider.py` | Cloud KMS integration |
| Token Rotation | `aragora/security/token_rotation.py` | Token lifecycle management |
| SSRF Protection | `aragora/security/ssrf_protection.py` | URL validation, private IP blocking, DNS rebinding protection |
| Anomaly Detection | `aragora/security/anomaly_detection.py` | Behavioral baseline, brute force, impossible travel |
| Threat Intel | `aragora/security/threat_intel_enrichment.py` | Threat intelligence enrichment |

### 11. Agent Execution

| Component | Source Location | Details |
|-----------|----------------|---------|
| CLI Agents | `aragora/agents/cli_agents.py` | Claude, Codex, Gemini, Grok CLI wrappers |
| API Agents | `aragora/agents/api_agents/` | Anthropic, OpenAI, Mistral, Grok, OpenRouter API clients |
| Agent Fallback | `aragora/agents/fallback.py` | OpenRouter fallback on quota errors |
| Airlock Proxy | `aragora/agents/airlock.py` | Agent resilience proxy |

**Testing focus:** Prompt injection via debate inputs, agent credential leakage in
responses, API key exposure in error messages, request smuggling through agent proxy.

---

## Out-of-Scope

### Excluded Systems

| System | Reason |
|--------|--------|
| Third-party AI providers (Anthropic, OpenAI, Mistral, xAI, etc.) | Covered by their own security assessments |
| Payment processor (Stripe) | PCI DSS certified, separate vendor |
| Email delivery (SendGrid/Postmark) | Separate vendor assessment |
| DNS / CDN (Cloudflare) | Separate infrastructure vendor |
| Monitoring stack (Prometheus, Grafana) | Internal-only, no external exposure |
| Client-side JavaScript | No web frontend shipped with the platform |
| Cloud infrastructure configuration (AWS/GCP IAM, VPC, etc.) | Separate infrastructure assessment |

### Excluded Techniques

| Technique | Reason |
|-----------|--------|
| Volumetric Denial of Service (DDoS) | Risk of production impact; coordinate separately |
| Physical security testing | Out of scope for application assessment |
| Social engineering of employees | Separate engagement required |
| Supply chain attacks on dependencies | Covered by dependency scanning (Dependabot) |
| Zero-day exploitation of underlying OS/runtime | Separate disclosure process |

---

## Known Mitigations (Existing Controls)

The following controls have been implemented and should be validated by the pentest:

1. **RBAC decorators** (`@require_permission`) on all handler endpoints
2. **Ownership verification** on resource access (non-admins see only their own data)
3. **Impersonation prevention** -- approver IDs forced to authenticated user
4. **Input validation** with strict regex whitelisting and shell metacharacter blocking
5. **Rate limiting** per IP, per user, per tenant, and per OAuth client (Redis-backed distributed)
6. **Circuit breaker** (threshold=5, cooldown=30s) preventing cascading failures
7. **Skill malware scanner** blocking dangerous patterns before skill registration
8. **Credential data separation** -- secrets never returned in API responses
9. **Safe error messages** -- `safe_error_message()` sanitizes exception details
10. **Comprehensive audit logging** with actor, resource, action, result, timestamp
11. **Sandbox isolation** for agent action execution (workspace scoping, resource limits)
12. **Parameterized SQL queries** throughout the codebase (verified in OpenClaw audit)
13. **SSRF protection** with private IP blocking, DNS rebinding checks, cloud metadata blocking
14. **CSRF protection** via double-submit cookie pattern (HMAC-signed tokens)
15. **Security headers** (X-Frame-Options: DENY, CSP, HSTS, X-Content-Type-Options: nosniff)
16. **AES-256-GCM encryption** for secrets at rest with key rotation
17. **Tenant isolation middleware** with fail-closed membership checks
18. **File upload validation** (MIME whitelist, size limits, path traversal prevention, null byte detection)

### Prior Audit Findings

See `docs/security/OPENCLAW_AUDIT.md` for the OpenClaw gateway OWASP Top 10 audit
conducted February 2026. Summary: 1 Critical, 3 High, 4 Medium, 3 Low, 2 Info findings.
Status of fixes:

| Finding | Severity | Status |
|---------|----------|--------|
| F01: Standalone server no auth | Critical | Open (warning logged if no API key) |
| F02: Credential encryption fallback | High | Mitigated (logger.critical + RuntimeError in prod) |
| F03: Unbounded request body | High | Fixed (MAX_BODY_SIZE=1MB, HTTP 413) |
| F04: Unbounded header count | High | Fixed (MAX_HEADER_COUNT=100, HTTP 431) |
| F05: CORS wildcard default | Medium | Partially mitigated (default changed to localhost) |
| F06: OpenClaw routes missing from RBAC middleware | Medium | Open |
| F07: NavigateAction SSRF | Medium | Open |
| F08: Health endpoint leaks exceptions | Medium | Open |
| F09: Query params not URL-decoded | Low | Open |
| F10: No session expiration | Low | Open |
| F11: Audit log 10K-entry cap | Low | Accepted risk |

---

## Severity Classification

| Severity | CVSS Range | Examples |
|----------|------------|---------|
| Critical | 9.0--10.0 | RCE, authentication bypass, mass data exposure |
| High | 7.0--8.9 | Privilege escalation, SQL injection, significant data leak |
| Medium | 4.0--6.9 | Stored XSS, IDOR with limited impact, information disclosure |
| Low | 0.1--3.9 | Reflected XSS, verbose errors, missing headers |
| Informational | 0 | Best practice recommendations, positive findings |

---

## Deliverables

1. **Executive Summary** (1--2 pages): overall risk rating, key findings, remediation priorities
2. **Technical Findings**: per-finding vulnerability description, reproduction steps, evidence (request/response), CVSS score, remediation recommendations, CWE/OWASP references
3. **Appendices**: tools used, testing timeline, raw scan data

---

## Remediation SLAs

| Severity | Target | Verification |
|----------|--------|--------------|
| Critical | 48 hours | Immediate retest |
| High | 7 days | Retest included in engagement |
| Medium | 30 days | Next quarterly scan |
| Low | 90 days | Next annual assessment |

---

*This document is confidential and intended only for authorized penetration testing personnel.*
