name: Deploy to Lightsail

on:
  push:
    branches: [main]
    paths:
      - 'aragora/**'
      - 'pyproject.toml'
      - 'setup.py'
      - 'requirements*.txt'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test step'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: deploy-lightsail
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  test:
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install and test
        run: |
          pip install -e ".[dev]" pytest-timeout httpx
          pytest tests/test_handlers_debates.py tests/test_api_handler.py \
            --timeout=60 -x --tb=short
        env:
          PYTHONPATH: .

  deploy:
    needs: test
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ubuntu
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          command_timeout: 5m
          script: |
            set -e
            echo "=== Deploying Aragora to Lightsail ==="

            # Find the aragora directory
            if [ -d /home/ubuntu/aragora ]; then
              cd /home/ubuntu/aragora
            elif [ -d /home/ec2-user/aragora ]; then
              cd /home/ec2-user/aragora
            else
              echo "ERROR: aragora directory not found"
              exit 1
            fi
            echo "Working directory: $(pwd)"

            # Record rollback point
            PREV=$(git rev-parse HEAD)
            echo "Rollback: $PREV"

            # Pull latest
            sudo chown -R $(whoami):$(id -gn) .git || true
            git stash --include-untracked || true
            git fetch origin main
            git checkout main 2>/dev/null || git checkout -b main origin/main
            git reset --hard origin/main

            NEW=$(git rev-parse HEAD)
            echo "Deployed: $PREV -> $NEW"

            # Install
            source venv/bin/activate 2>/dev/null || source .venv/bin/activate 2>/dev/null || true
            pip install -e . --quiet --no-cache-dir 2>/dev/null || true

            # Import check
            python -c "from aragora.server.unified_server import UnifiedServer; print('Import OK')"

            # Ensure data directory exists with correct permissions
            ARAGORA_DIR=$(pwd)
            sudo mkdir -p "$ARAGORA_DIR/.nomic" /opt/aragora 2>/dev/null || true
            sudo chown -R $(whoami):$(id -gn) "$ARAGORA_DIR/.nomic" /opt/aragora 2>/dev/null || true
            # Also check if service runs as a different user
            SERVICE_USER=$(grep -oP '(?<=User=)\S+' /etc/systemd/system/aragora.service 2>/dev/null || echo "")
            if [ -n "$SERVICE_USER" ] && [ "$SERVICE_USER" != "$(whoami)" ]; then
              echo "Service runs as: $SERVICE_USER"
              sudo chown -R "$SERVICE_USER":"$SERVICE_USER" "$ARAGORA_DIR/.nomic" /opt/aragora 2>/dev/null || true
              sudo chown -R "$SERVICE_USER":"$SERVICE_USER" "$ARAGORA_DIR" 2>/dev/null || true
            fi

            # Restart service - try multiple methods
            echo "Restarting service..."
            if sudo systemctl restart aragora 2>/dev/null; then
              echo "systemctl restart succeeded"
            elif sudo systemctl restart aragora.service 2>/dev/null; then
              echo "systemctl restart aragora.service succeeded"
            else
              echo "systemctl failed, trying process-based restart..."
              # Kill existing server processes and let systemd/supervisor restart them
              sudo pkill -f "unified_server\|aragora.*serve" 2>/dev/null || true
              sleep 2
              # If still not running, try starting directly
              if ! sudo systemctl is-active --quiet aragora 2>/dev/null; then
                echo "Attempting direct start..."
                sudo systemctl start aragora 2>/dev/null || true
              fi
            fi

            sleep 5

            # Check if running
            if sudo systemctl is-active --quiet aragora 2>/dev/null; then
              echo "Service: RUNNING (systemd)"
            elif pgrep -f "unified_server\|aragora.*serve" > /dev/null 2>&1; then
              echo "Service: RUNNING (process)"
            else
              echo "Service: NOT RUNNING - checking logs..."
              sudo journalctl -u aragora --no-pager -n 20 2>/dev/null || true
            fi

            echo "=== Deploy complete ==="

            # Diagnostic: check service environment configuration
            echo "=== Diagnostics ==="
            echo "--- Service unit file ---"
            sudo cat /etc/systemd/system/aragora.service 2>/dev/null | grep -v 'SECRET\|KEY\|TOKEN\|PASSWORD' || echo "No service file"
            echo "--- Environment file ---"
            sudo ls -la /etc/default/aragora 2>/dev/null || echo "No /etc/default/aragora"
            sudo ls -la /home/ubuntu/aragora/.env 2>/dev/null || echo "No .env file"
            # Check which env vars are SET (not their values) for auth-related config
            echo "--- Auth env vars (names only, from service env) ---"
            sudo cat /etc/systemd/system/aragora.service 2>/dev/null | grep -oP 'Environment=\K[^=]+' || true
            sudo grep -oP '^[^#][^=]+' /etc/default/aragora 2>/dev/null || true
            # Check .env for var names only
            if [ -f /home/ubuntu/aragora/.env ]; then
              echo "--- .env var names ---"
              grep -oP '^[^#][^=]+' /home/ubuntu/aragora/.env 2>/dev/null || true
            fi

            # Hit the auth debug endpoint from localhost to trigger any errors
            echo "--- Auth debug endpoint (localhost) ---"
            AUTH_PORT=$(grep -oP 'api-port\s+\K\d+' /etc/systemd/system/aragora.service 2>/dev/null || echo "8080")
            AUTH_DEBUG_RESP=$(curl -sS -w "\nHTTP_STATUS:%{http_code}" "http://localhost:${AUTH_PORT}/api/auth/debug" 2>&1) || true
            echo "$AUTH_DEBUG_RESP"

            # Capture logs AFTER the curl to include the traceback
            echo "--- Recent service logs (last 50 lines, after auth/debug curl) ---"
            sudo journalctl -u aragora --no-pager -n 50 --no-hostname 2>/dev/null || true
            echo "=== End Diagnostics ==="

      - name: Verify health
        run: |
          for i in $(seq 1 12); do
            if curl -sf "https://api.aragora.ai/api/health" -o /dev/null 2>/dev/null; then
              echo "Health check passed"
              exit 0
            fi
            echo "Waiting... attempt $i/12"
            sleep 5
          done
          echo "::warning::Health check failed after 60s"
          exit 1
