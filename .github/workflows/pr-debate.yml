name: Aragora PR Review

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review'
        required: true

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    # Skip if PR is from a fork (no access to secrets)
    if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install aragora from PR
        run: |
          pip install --upgrade pip
          # Install from checked-out PR code (editable mode)
          pip install -e .

      - name: Get PR diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PR_NUMBER=${{ github.event.inputs.pr_number }}
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi

          # Get the diff
          gh pr diff $PR_NUMBER > pr.diff

          # Check diff size
          DIFF_SIZE=$(wc -c < pr.diff)
          echo "Diff size: $DIFF_SIZE bytes"

          # Smart truncation: prioritize security-sensitive files
          if [ "$DIFF_SIZE" -gt 50000 ]; then
            echo "Diff exceeds 50KB, applying smart truncation..."

            # Keep security-sensitive files first (auth, crypto, config)
            grep -E "^\+\+\+ .*(auth|security|crypto|password|token|secret|config|env)" pr.diff > priority_files.txt || true

            # Truncate to 50KB
            head -c 50000 pr.diff > pr_truncated.diff
            echo -e "\n\n[... diff truncated to 50KB for review ...]" >> pr_truncated.diff
            mv pr_truncated.diff pr.diff
          fi

          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "DIFF_SIZE=$DIFF_SIZE" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create artifacts directory
        run: mkdir -p ./artifacts

      - name: Run aragora review
        id: review
        run: |
          # Run the review command
          aragora review \
            --diff-file pr.diff \
            --output-format github \
            --output-dir ./artifacts \
            --agents anthropic-api,openai-api \
            --rounds 2 \
            --focus security,performance,quality \
            > ./artifacts/comment.md 2> ./artifacts/review.log || true

          # Check if review was generated
          if [ -f "./artifacts/comment.md" ] && [ -s "./artifacts/comment.md" ]; then
            echo "review_generated=true" >> $GITHUB_OUTPUT
          else
            echo "review_generated=false" >> $GITHUB_OUTPUT
            # Create fallback comment
            cat > ./artifacts/comment.md << 'FALLBACK'
          ## AI Red Team Code Review

          Review could not be completed. Please check the workflow logs.

          **Possible causes:**
          - Missing API keys (ANTHROPIC_API_KEY, OPENAI_API_KEY)
          - Diff too large or complex
          - Rate limiting

          ---
          *Powered by [Aragora](https://github.com/an0mium/aragora) - AI Red Team*
          FALLBACK
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aragora-review-${{ steps.diff.outputs.PR_NUMBER }}
          path: ./artifacts/
          retention-days: 30

      - name: Post PR comment
        run: |
          PR_NUMBER=${{ steps.diff.outputs.PR_NUMBER }}

          # Post the review comment
          gh pr comment $PR_NUMBER --body-file ./artifacts/comment.md
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Add review label
        if: steps.review.outputs.review_generated == 'true'
        run: |
          PR_NUMBER=${{ steps.diff.outputs.PR_NUMBER }}
          gh pr edit $PR_NUMBER --add-label "ai-reviewed" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ github.token }}
