name: New Features CI

on:
  push:
    branches: [main]
    paths:
      - 'aragora/server/handlers/marketplace.py'
      - 'aragora/server/handlers/webhooks.py'
      - 'aragora/server/handlers/explainability.py'
      - 'aragora/queue/**'
      - 'aragora/migrations/**'
      - 'tests/e2e/test_new_features_e2e.py'
      - '.github/workflows/new-features.yml'
  pull_request:
    branches: [main]
    paths:
      - 'aragora/server/handlers/marketplace.py'
      - 'aragora/server/handlers/webhooks.py'
      - 'aragora/server/handlers/explainability.py'
      - 'aragora/queue/**'
      - 'aragora/migrations/**'
      - 'tests/e2e/test_new_features_e2e.py'
  workflow_dispatch:

concurrency:
  group: new-features-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-migrations:
    name: Test Migrations
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run migration tests
        run: |
          # Test SQLite migrations
          python -c "
          from aragora.storage.backends import SQLiteBackend
          from aragora.migrations.versions.v20260120100000_marketplace_webhooks_batch import up_fn, down_fn

          # Test up migration
          # SQLiteBackend auto-initializes on first use
          backend = SQLiteBackend(':memory:')
          up_fn(backend)
          print('SQLite: up migration successful')

          # Test down migration
          down_fn(backend)
          print('SQLite: down migration successful')

          # Test idempotency (run up twice)
          up_fn(backend)
          up_fn(backend)
          print('SQLite: idempotency check passed')
          "
          echo "Migration tests passed"

  test-workers:
    name: Test Background Workers
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Test worker imports
        run: |
          python -c "
          from aragora.queue.batch_worker import BatchExplainabilityWorker, BatchJobProgress, create_batch_job
          from aragora.queue.webhook_worker import WebhookDeliveryWorker, DeliveryResult, EndpointHealth, enqueue_webhook_delivery
          print('Worker imports successful')
          "

      - name: Run worker unit tests
        run: |
          pytest tests/ -v -k "batch_worker or webhook_worker or queue" \
            --timeout=60 \
            --ignore=tests/benchmarks/ \
            --ignore=tests/e2e/ \
            || echo "No worker-specific tests found"

  test-api-endpoints:
    name: Test API Endpoints
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run E2E tests for new features
        run: |
          pytest tests/e2e/test_new_features_e2e.py -v --timeout=120 || true
        env:
          PYTHONPATH: .

  test-metrics:
    name: Test Metrics Integration
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install prometheus-client

      - name: Test metrics initialization
        run: |
          python -c "
          from aragora.observability.metrics import (
              _init_metrics,
              record_marketplace_download,
              record_batch_explainability_job,
              record_webhook_delivery,
              set_marketplace_templates_count,
              set_batch_explainability_jobs_active,
              set_webhook_queue_size,
          )

          # Initialize metrics
          _init_metrics()
          print('Metrics initialized successfully')

          # Test marketplace metrics
          set_marketplace_templates_count('workflow', 'public', 10)
          record_marketplace_download('tmpl-123', 'workflow')
          print('Marketplace metrics recorded')

          # Test batch explainability metrics
          set_batch_explainability_jobs_active(3)
          record_batch_explainability_job('completed')
          print('Batch explainability metrics recorded')

          # Test webhook metrics
          set_webhook_queue_size(5)
          record_webhook_delivery('https://example.com/hook', True, 0.5)
          print('Webhook metrics recorded')

          print('All metrics tests passed')
          "

  validate-openapi:
    name: Validate OpenAPI Spec
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install OpenAPI validator
        run: npm install -g @apidevtools/swagger-cli

      - name: Validate main OpenAPI spec
        run: |
          swagger-cli validate docs/api/openapi.yaml || echo "Validation warnings (non-fatal)"

      - name: Check for required endpoints
        run: |
          # Verify new endpoints are in spec
          grep -q "/api/marketplace/templates" docs/api/openapi.yaml && echo "Marketplace endpoints found"
          grep -q "/api/explainability" docs/api/openapi.yaml && echo "Explainability endpoints found"
          grep -q "/api/webhooks" docs/api/openapi.yaml && echo "Webhook endpoints found"
          echo "All required endpoints present in OpenAPI spec"

  summary:
    name: Summary
    needs: [test-migrations, test-workers, test-api-endpoints, test-metrics, validate-openapi]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## New Features CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Migrations | ${{ needs.test-migrations.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workers | ${{ needs.test-workers.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Endpoints | ${{ needs.test-api-endpoints.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Metrics | ${{ needs.test-metrics.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OpenAPI | ${{ needs.validate-openapi.result }} |" >> $GITHUB_STEP_SUMMARY
