name: Backup Verification

on:
  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      full_drill:
        description: 'Run full DR drill (includes restore test)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: backup-verification
  cancel-in-progress: false  # Don't cancel DR tests

permissions:
  contents: read

jobs:
  backup-tests:
    name: Backup System Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-backup-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-backup-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run backup manager tests
        run: |
          pytest tests/backup/test_backup_manager.py -v --tb=short
        env:
          PYTHONPATH: .

      - name: Run restore verification tests
        run: |
          pytest tests/backup/test_restore_verification.py -v --tb=short
        env:
          PYTHONPATH: .

      - name: Run encryption tests
        run: |
          pytest tests/backup/test_encryption.py -v --tb=short
        env:
          PYTHONPATH: .

  dr-drill-tests:
    name: DR Drill Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: backup-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run DR drill tests
        run: |
          pytest tests/backup/test_disaster_recovery_drill.py -v --tb=short
        env:
          PYTHONPATH: .

      - name: Measure RTO/RPO metrics
        run: |
          python scripts/dr_metrics.py --ci-mode
        env:
          PYTHONPATH: .

  backup-handler-tests:
    name: Backup Handler Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: backup-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run backup handler tests
        run: |
          pytest tests/server/handlers/test_backup_handler.py -v --tb=short
        env:
          PYTHONPATH: .

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [backup-tests, dr-drill-tests, backup-handler-tests]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Backup Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backup Manager | ${{ needs.backup-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DR Drill | ${{ needs.dr-drill-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backup Handlers | ${{ needs.backup-handler-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### RTO/RPO Targets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tier | RTO | RPO |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Free | 24h | 24h |" >> $GITHUB_STEP_SUMMARY
          echo "| Pro | 4h | 1h |" >> $GITHUB_STEP_SUMMARY
          echo "| Enterprise | 1h | 15m |" >> $GITHUB_STEP_SUMMARY
