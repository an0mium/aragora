name: Release Notes

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v2.2.0)'
        required: true
        type: string
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-release-notes:
    name: Generate Release Notes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Get previous tag
        id: prev_tag
        run: |
          CURRENT_TAG="${{ steps.version.outputs.version }}"
          PREV_TAG=$(git tag --sort=-version:refname | grep -A1 "^$CURRENT_TAG$" | tail -1)
          if [ "$PREV_TAG" = "$CURRENT_TAG" ]; then
            # First release or no previous tag found
            PREV_TAG=$(git rev-list --max-parents=0 HEAD | head -1)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate changelog
        id: changelog
        run: |
          CURRENT="${{ steps.version.outputs.version }}"
          PREV="${{ steps.prev_tag.outputs.prev_tag }}"

          echo "Generating changelog from $PREV to $CURRENT"

          # Generate changelog
          python scripts/generate_changelog.py \
            --from "$PREV" \
            --to "$CURRENT" \
            --output /tmp/changelog.md

          # Read changelog for GitHub release
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: ${{ github.event.inputs.draft || false }}
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        if: ${{ !github.event.inputs.draft }}
        run: |
          # Prepend new release to CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            # Insert after header
            head -2 CHANGELOG.md > /tmp/changelog_new.md
            echo "" >> /tmp/changelog_new.md
            cat /tmp/changelog.md >> /tmp/changelog_new.md
            echo "" >> /tmp/changelog_new.md
            tail -n +3 CHANGELOG.md >> /tmp/changelog_new.md
            mv /tmp/changelog_new.md CHANGELOG.md
          else
            # Create new CHANGELOG.md
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            cat /tmp/changelog.md >> CHANGELOG.md
          fi

      - name: Commit CHANGELOG update
        if: ${{ !github.event.inputs.draft }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet CHANGELOG.md; then
            echo "No changes to CHANGELOG.md"
          else
            git add CHANGELOG.md
            git commit -m "docs: update CHANGELOG for ${{ steps.version.outputs.version }}"
            git push origin HEAD:main
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
