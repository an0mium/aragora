name: Branch Discipline

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  enforce-main-pr-policy:
    if: github.event_name == 'push'
    runs-on: aragora
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Verify commits are associated with pull requests
        uses: actions/github-script@v7
        with:
          script: |
            const commits = context.payload.commits || [];
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const bypassTag = "[allow-direct-main]";
            const violations = [];

            if (commits.length === 0) {
              core.info("No commits in payload; skipping direct-push check.");
              return;
            }

            for (const commit of commits) {
              const title = (commit.message || "").split("\n")[0];
              if ((commit.message || "").includes(bypassTag)) {
                core.warning(`Bypass tag present for ${commit.id.slice(0, 7)}: ${title}`);
                continue;
              }

              try {
                const resp = await github.request(
                  "GET /repos/{owner}/{repo}/commits/{commit_sha}/pulls",
                  {
                    owner,
                    repo,
                    commit_sha: commit.id,
                    mediaType: { previews: ["groot"] },
                  }
                );
                const prs = Array.isArray(resp.data) ? resp.data : [];
                if (prs.length === 0) {
                  violations.push(`${commit.id.slice(0, 7)} ${title}`);
                }
              } catch (error) {
                violations.push(`${commit.id.slice(0, 7)} ${title} (PR lookup failed)`);
                core.warning(`PR lookup failed for ${commit.id}: ${String(error)}`);
              }
            }

            if (violations.length > 0) {
              core.setFailed(
                "Direct push commits detected on main without associated PRs:\n" +
                  violations.join("\n") +
                  "\nUse feature branches + PR merge. Emergency override tag: [allow-direct-main]"
              );
            } else {
              core.info("All pushed commits are associated with pull requests.");
            }
