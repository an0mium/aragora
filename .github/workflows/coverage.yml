name: Coverage Gate

on:
  pull_request:
    branches: [main]
    paths:
      - 'aragora/**'
      - 'tests/**'
      - 'pyproject.toml'
  push:
    branches: [main]
    paths:
      - 'aragora/**'
      - 'tests/**'
  workflow_dispatch:

concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  coverage:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"

      - name: Run tests with coverage
        run: |
          python -m pytest tests/ \
            -m "not slow and not load and not e2e" \
            --cov=aragora \
            --cov-report=json:coverage.json \
            --cov-report=xml:coverage.xml \
            --cov-report=term-missing \
            --timeout=120 \
            -q \
            --cov-fail-under=70

      - name: Generate coverage report
        run: |
          python scripts/coverage_report.py --no-run --json > coverage-summary.json
          cat coverage-summary.json

      - name: Check coverage thresholds
        run: |
          # Check minimum overall coverage (BLOCKING - must maintain 70%)
          OVERALL=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
          echo "Overall coverage: ${OVERALL}%"

          # Fail if coverage is below 70%
          python -c "
          import json
          import sys
          data = json.load(open('coverage.json'))
          coverage = data['totals']['percent_covered']
          if coverage < 70:
              print(f'::error::Coverage {coverage:.1f}% is below minimum 70%')
              sys.exit(1)
          print(f'Coverage check passed: {coverage:.1f}%')
          "

          # Check for zero-coverage in critical modules
          python scripts/coverage_report.py --no-run --critical-only

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.json
            coverage.xml
            coverage-summary.json
          retention-days: 14

      - name: Coverage comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('coverage-summary.json', 'utf8'));
            const overall = summary.overall_coverage.toFixed(1);
            const zeroFiles = summary.zero_coverage_files.length;

            const body = `## Coverage Report

            **Overall Coverage:** ${overall}%

            ${zeroFiles > 0 ? `**Zero-Coverage Files:** ${zeroFiles}` : '**Zero-Coverage Files:** None'}

            <details>
            <summary>Module Coverage</summary>

            | Module | Coverage | Status |
            |--------|----------|--------|
            ${Object.entries(summary.modules)
              .sort((a, b) => a[1].percent - b[1].percent)
              .slice(0, 20)
              .map(([m, d]) => `| ${m} | ${d.percent.toFixed(1)}% | ${d.passing ? ':white_check_mark:' : ':x:'} |`)
              .join('\n')}

            </details>
            `;

            // Find existing coverage comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Coverage Report')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

  coverage-diff:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'
    needs: coverage

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Get changed files
        id: changed
        run: |
          # Get list of changed Python files
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- 'aragora/**/*.py' | tr '\n' ' ')
          echo "files=$CHANGED" >> $GITHUB_OUTPUT

      - name: Check new code coverage
        if: steps.changed.outputs.files != ''
        run: |
          echo "Changed files: ${{ steps.changed.outputs.files }}"
          pip install -e ".[dev,test]"

          # Run coverage on changed files only
          python -m pytest tests/ \
            -m "not slow and not load and not e2e" \
            --cov=aragora \
            --cov-report=json:new-coverage.json \
            --timeout=60 \
            -q \
            --cov-fail-under=60 || true

          # Check that new code has reasonable coverage
          python -c "
          import json
          import sys
          try:
              data = json.load(open('new-coverage.json'))
              coverage = data['totals']['percent_covered']
              if coverage < 60:
                  print(f'::warning::New code coverage {coverage:.1f}% is below 60%')
              else:
                  print(f'New code coverage: {coverage:.1f}%')
          except Exception as e:
              print(f'Coverage check skipped: {e}')
          "
