name: "Integration Gate"

# Runs integration smoke tests that must pass before any release.
# Validates that core subsystems wire together correctly, API contracts
# are in sync, and the smoke test harness passes.

on:
  pull_request:
    branches: [main]
    paths:
      - 'aragora/**'
      - 'tests/**'
      - 'scripts/smoke_test.py'
      - 'aragora/live/**'
      - 'docs/api/openapi*.json'
      - 'docs/api/openapi*.yaml'
      - 'docs/STATUS.md'
      - 'pyproject.toml'
      - '.github/workflows/integration-gate.yml'
  merge_group:
  workflow_call:
    # Allow release.yml to call this workflow as a reusable gate
  workflow_dispatch:

concurrency:
  group: integration-gate-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  smoke-tests:
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    name: Smoke Test Harness
    runs-on: aragora
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Keep smoke gate dependency footprint lean to avoid CI install stalls/timeouts.
          pip install -e ".[dev,test]"
          pip install pytest-timeout

      # ---------------------------------------------------------------
      # Smoke test script (backend-focused; frontend has its own gate)
      # ---------------------------------------------------------------
      - name: "Run smoke test harness (--skip-server)"
        run: python scripts/smoke_test.py --skip-server --quick --verbose
        env:
          PYTHONPATH: .

      # ---------------------------------------------------------------
      # Pytest integration smoke tests
      # ---------------------------------------------------------------
      - name: "Run integration smoke tests"
        run: |
          pytest tests/integration/test_smoke.py -q --timeout=120 --tb=short
        env:
          PYTHONPATH: .

  api-contract-sync:
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    name: API Contract Sync
    runs-on: aragora
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"

      # ---------------------------------------------------------------
      # OpenAPI spec drift detection
      # ---------------------------------------------------------------
      - name: "BLOCKING: OpenAPI contract sync"
        run: |
          pytest tests/sdk/test_openapi_sync.py -q --timeout=60 --tb=short
        env:
          PYTHONPATH: .

  frontend-build:
    name: Frontend Build
    runs-on: aragora
    timeout-minutes: 12
    if: (github.event_name != 'pull_request' || !github.event.pull_request.draft) && (github.event_name != 'workflow_call')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install frontend dependencies
        working-directory: aragora/live
        run: npm ci

      - name: TypeScript type check
        working-directory: aragora/live
        run: npx tsc --noEmit

      - name: Build frontend
        working-directory: aragora/live
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: "1"

      # ---------------------------------------------------------------
      # SDK contract parity (Python vs TypeScript)
      # ---------------------------------------------------------------
      - name: Set up Python for SDK parity check
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install parity test deps
        run: pip install pytest pytest-timeout

      - name: "BLOCKING: SDK contract parity"
        run: |
          pytest tests/sdk/test_contract_parity.py -q --timeout=60 --tb=short
        env:
          PYTHONPATH: .

  status-doc-validation:
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    name: Status Doc Validation
    runs-on: aragora
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ---------------------------------------------------------------
      # Validate that docs/STATUS.md is parseable and well-formed
      # ---------------------------------------------------------------
      - name: "Validate STATUS.md is parseable"
        run: |
          python -c "
          from pathlib import Path
          import sys

          status_path = Path('docs/STATUS.md')
          if not status_path.exists():
              print('::error::docs/STATUS.md does not exist')
              sys.exit(1)

          content = status_path.read_text()

          # Check basic structure
          if not content.strip():
              print('::error::docs/STATUS.md is empty')
              sys.exit(1)

          # Check for required sections
          required_markers = ['# Aragora', 'Summary', '##']
          found = [m for m in required_markers if m in content]
          if len(found) < 2:
              print(f'::warning::docs/STATUS.md may be malformed (found {len(found)}/{len(required_markers)} expected markers)')

          lines = content.splitlines()
          print(f'docs/STATUS.md: {len(lines)} lines, {len(content)} bytes')
          print('STATUS.md validation passed')
          "

      # ---------------------------------------------------------------
      # Verify version in pyproject.toml matches release tag (if tagged)
      # ---------------------------------------------------------------
      - name: "Version-tag consistency check"
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          PYPROJECT_VERSION=$(python -c "
          import re
          from pathlib import Path
          content = Path('pyproject.toml').read_text()
          match = re.search(r'^version\s*=\s*[\"'\''](.*?)[\"'\'']', content, re.MULTILINE)
          print(match.group(1) if match else 'UNKNOWN')
          ")
          echo "Tag version: $TAG_VERSION"
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "::error::Version mismatch: tag=$TAG_VERSION pyproject.toml=$PYPROJECT_VERSION"
            exit 1
          fi
          echo "Version alignment check passed"

  integration-summary:
    name: Integration Gate Summary
    runs-on: aragora
    needs: [smoke-tests, api-contract-sync, status-doc-validation, frontend-build]
    if: (github.event_name != 'pull_request' || !github.event.pull_request.draft) && (always())
    timeout-minutes: 2

    steps:
      - name: Check gate results
        run: |
          echo "## Integration Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Contract Sync | ${{ needs.api-contract-sync.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status Doc Validation | ${{ needs.status-doc-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | ${{ needs.frontend-build.result }} |" >> $GITHUB_STEP_SUMMARY

          validate_gate_result() {
            local name="$1"
            local result="$2"
            case "$result" in
              success|cancelled|skipped) return 0 ;;
              *)
                echo "::error::${name} returned unexpected status: ${result}"
                return 1
                ;;
            esac
          }

          failed=0
          validate_gate_result "Smoke Tests" "${{ needs.smoke-tests.result }}" || failed=1
          validate_gate_result "API Contract Sync" "${{ needs.api-contract-sync.result }}" || failed=1
          validate_gate_result "Status Doc Validation" "${{ needs.status-doc-validation.result }}" || failed=1
          validate_gate_result "Frontend Build" "${{ needs.frontend-build.result }}" || failed=1

          if [ "$failed" -ne 0 ]; then
            echo ""
            echo "::error::Integration gate FAILED - one or more checks did not pass"
            exit 1
          fi
          echo ""
          echo "All integration checks passed."
