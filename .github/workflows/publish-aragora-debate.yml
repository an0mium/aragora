name: Publish aragora-debate to PyPI

# Publishes the `aragora-debate` standalone package from aragora-debate/.
# Triggers:
#   1. Tag push matching `aragora-debate-v*` (e.g. `aragora-debate-v0.2.0`)
#   2. Manual workflow_dispatch with version input

on:
  push:
    tags:
      - 'aragora-debate-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.2.0). Ignored for tag triggers.'
        required: false
        type: string
      confirm:
        description: 'Type PUBLISH to confirm (required for manual dispatch)'
        required: false
        type: string

permissions:
  contents: write
  id-token: write  # Required for PyPI trusted publishing

jobs:
  # -------------------------------------------------------------------
  # Resolve the version from either the tag or manual input
  # -------------------------------------------------------------------
  resolve-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_tag: ${{ steps.version.outputs.is_tag }}
    steps:
      - name: Extract version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#aragora-debate-v}"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "is_tag=true" >> "$GITHUB_OUTPUT"
            echo "Resolved version ${VERSION} from tag ${TAG}"
          else
            VERSION="${{ github.event.inputs.version }}"
            if [[ -z "${VERSION}" ]]; then
              echo "::error::Version is required for manual dispatch"
              exit 1
            fi
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "is_tag=false" >> "$GITHUB_OUTPUT"
            echo "Manual dispatch for version ${VERSION}"
          fi

  # -------------------------------------------------------------------
  # Run the full test suite before publishing
  # -------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    defaults:
      run:
        working-directory: aragora-debate

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install package with dev deps
        run: pip install -e ".[dev]"

      - name: Run tests
        run: python -m pytest tests/ -v

  # -------------------------------------------------------------------
  # Build and publish to PyPI
  # -------------------------------------------------------------------
  publish:
    needs: [resolve-version, test]
    runs-on: ubuntu-latest
    # For manual dispatch, require PUBLISH confirmation.
    # For tag pushes, always proceed.
    if: >-
      needs.resolve-version.outputs.is_tag == 'true'
      || github.event.inputs.confirm == 'PUBLISH'
    environment: pypi
    defaults:
      run:
        working-directory: aragora-debate

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install build

      - name: Set version in source files
        env:
          VERSION: ${{ needs.resolve-version.outputs.version }}
        run: |
          sed -i "s/version = \"[^\"]*\"/version = \"${VERSION}\"/" pyproject.toml
          sed -i "s/__version__ = \"[^\"]*\"/__version__ = \"${VERSION}\"/" src/aragora_debate/__init__.py
          echo "Set version to ${VERSION}"
          grep 'version' pyproject.toml | head -1
          grep '__version__' src/aragora_debate/__init__.py

      - name: Build package
        run: python -m build

      - name: Verify package
        run: |
          pip install dist/aragora_debate-*.whl
          python -c "import aragora_debate; print(f'Version: {aragora_debate.__version__}')"
          python -c "from aragora_debate import Arena, Debate, EvidencePoweredTrickster; print('All imports OK')"
          python -c "from aragora_debate import ConvergenceDetector, CrossProposalAnalyzer; print('Analysis imports OK')"

      - name: Publish to PyPI (trusted publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: aragora-debate/dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        env:
          VERSION: ${{ needs.resolve-version.outputs.version }}
        with:
          tag_name: aragora-debate-v${{ needs.resolve-version.outputs.version }}
          name: aragora-debate v${{ needs.resolve-version.outputs.version }}
          body: |
            ## aragora-debate v${{ needs.resolve-version.outputs.version }}

            Install:
            ```bash
            pip install aragora-debate==${{ needs.resolve-version.outputs.version }}
            ```

            With all providers:
            ```bash
            pip install "aragora-debate[all]==${{ needs.resolve-version.outputs.version }}"
            ```

            [Changelog](https://github.com/an0mium/aragora/blob/main/aragora-debate/CHANGELOG.md) |
            [README](https://github.com/an0mium/aragora/tree/main/aragora-debate)
          draft: false
          prerelease: ${{ contains(needs.resolve-version.outputs.version, 'beta') || contains(needs.resolve-version.outputs.version, 'alpha') || contains(needs.resolve-version.outputs.version, 'rc') }}
