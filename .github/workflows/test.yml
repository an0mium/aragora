name: Tests

on:
  push:
    branches: [main]
    paths:
      - 'aragora/**'
      - 'aragora-debate/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements.txt'
      - 'scripts/capability_gap_report.py'
      - 'scripts/generate_capability_matrix.py'
      - 'scripts/check_capability_matrix_sync.py'
      - 'scripts/check_legacy_entrypoints.py'
      - 'scripts/capability_matrix_delta.py'
      - 'scripts/generate_cli_reference.py'
      - 'aragora/capabilities.yaml'
      - 'aragora/capability_surfaces.yaml'
      - 'docs/CAPABILITY_MATRIX.md'
      - 'docs/reference/CLI_REFERENCE.md'
      - 'docs-site/docs/contributing/capability-matrix.md'
      - 'docs-site/docs/api/cli.md'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'aragora/**'
      - 'aragora-debate/**'
      - 'tests/**'
      - 'pyproject.toml'
      - 'requirements.txt'
      - 'scripts/capability_gap_report.py'
      - 'scripts/generate_capability_matrix.py'
      - 'scripts/check_capability_matrix_sync.py'
      - 'scripts/check_legacy_entrypoints.py'
      - 'scripts/capability_matrix_delta.py'
      - 'scripts/generate_cli_reference.py'
      - 'aragora/capabilities.yaml'
      - 'aragora/capability_surfaces.yaml'
      - 'docs/CAPABILITY_MATRIX.md'
      - 'docs/reference/CLI_REFERENCE.md'
      - 'docs-site/docs/contributing/capability-matrix.md'
      - 'docs-site/docs/api/cli.md'
      - '.github/workflows/test.yml'
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

concurrency:
  group: tests-${{ github.ref }}${{ startsWith(github.ref, 'refs/heads/dev/') && format('-{0}', github.sha) || '' }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' && !startsWith(github.ref, 'refs/heads/dev/') }}

jobs:
  # ============================================================
  # Test Tier Architecture (#180)
  # ============================================================
  # PR tier (test-fast):       <5 min target, parallel by category
  #   Markers excluded: slow, load, e2e, integration, benchmark, performance
  # Compat matrix (test):      Full OS/Python matrix, coverage gates
  # Nightly tier (nightly-slow): slow + load + e2e tests, 600s timeout
  # Benchmarks:                Dedicated workflow in benchmark.yml
  #   (pytest-benchmark with regression detection + baseline comparison)
  # ============================================================

  # Version alignment check (fast, runs first)
  version-check:
    name: Version Alignment
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install OpenAPI generation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Check version alignment
        run: python scripts/check_version_alignment.py
      - name: Repo hygiene guard
        run: python scripts/guard_repo_clean.py --check-working-tree

      - name: Check OpenAPI spec is up to date
        run: |
          TMPDIR=$(mktemp -d)
          python scripts/generate_openapi.py --output "$TMPDIR/openapi_generated.json"
          python scripts/generate_openapi.py --output "$TMPDIR/openapi_generated.yaml" --format yaml
          python scripts/add_openapi_operation_ids.py --spec "$TMPDIR/openapi_generated.json"
          python scripts/add_openapi_param_descriptions.py --spec "$TMPDIR/openapi_generated.json"
          python scripts/add_openapi_descriptions.py --spec "$TMPDIR/openapi_generated.json"
          diff -u "$TMPDIR/openapi_generated.json" docs/api/openapi_generated.json
          diff -u "$TMPDIR/openapi_generated.yaml" docs/api/openapi_generated.yaml

      - name: Check TypeScript SDK types are up to date
        run: python scripts/generate_sdk_types.py --openapi docs/api/openapi_generated.json --check

      - name: Check Python SDK types are up to date
        run: |
          pip install datamodel-code-generator
          python scripts/generate_python_sdk_types.py --openapi docs/api/openapi_generated.json --check

      - name: Check capability matrix is up to date
        run: python scripts/check_capability_matrix_sync.py

      - name: Check command guidance drift
        run: python scripts/check_legacy_entrypoints.py

      - name: Check CLI reference is up to date
        run: python scripts/generate_cli_reference.py --check

      - name: Fetch PR base branch for capability summary
        if: github.event_name == 'pull_request'
        run: git fetch --no-tags --depth=1 origin "${{ github.base_ref }}"

      - name: Generate capability matrix summary artifact
        if: github.event_name == 'pull_request'
        run: |
          python scripts/capability_matrix_delta.py \
            --base-ref "origin/${{ github.base_ref }}" \
            --out /tmp/capability-matrix-summary.md

      - name: Upload capability matrix summary artifact
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: capability-matrix-summary
          path: /tmp/capability-matrix-summary.md
          retention-days: 14

  baseline-determinism:
    name: Baseline Determinism
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: version-check

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install baseline test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,research,test]"

      - name: Verify deterministic baseline command
        run: python scripts/run_test_baseline.py

  # Skip marker audit (warns if skip count increases)
  skip-audit:
    name: Skip Marker Audit
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Run skip audit
        run: |
          CURRENT=$(python scripts/audit_test_skips.py --count-only)
          BASELINE=$(cat tests/.skip_baseline 2>/dev/null || echo 600)
          THRESHOLD=2  # Fail if skips increase by more than this (tightened Feb 2026)
          echo "Current skip count: $CURRENT"
          echo "Baseline: $BASELINE"
          echo "Threshold: $THRESHOLD"

          DIFF=$((CURRENT - BASELINE))
          if [ "$DIFF" -gt "$THRESHOLD" ]; then
            echo "::error::Skip count increased by $DIFF (from $BASELINE to $CURRENT)"
            echo "::error::This exceeds the threshold of $THRESHOLD additional skips"
            echo "Run 'python scripts/audit_test_skips.py' locally to see details"
            exit 1
          elif [ "$DIFF" -gt 0 ]; then
            echo "::warning::Skip count increased slightly: $CURRENT > $BASELINE baseline (+$DIFF)"
            echo "Consider updating tests/.skip_baseline if these skips are intentional"
          elif [ "$DIFF" -lt 0 ]; then
            echo "::notice::Skip count decreased by $((-DIFF))! Consider updating baseline."
          fi
          # Store for potential artifact
          echo "$CURRENT" > skip_count.txt

      - name: Upload skip audit
        uses: actions/upload-artifact@v4
        with:
          name: skip-audit
          path: skip_count.txt
          retention-days: 7

  # Zero-coverage baseline check (prevents new zero-coverage files)
  zero-coverage-check:
    name: Zero Coverage Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: baseline-determinism

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"

      - name: Check for new zero-coverage files
        run: |
          # Run quick coverage collection
          python -m pytest tests/debate tests/server -q --cov=aragora --cov-report=json:cov.json \
            -m "not slow and not load and not e2e" --timeout=60 -x || true

          # Check for new zero-coverage files not in baseline
          python -c "
          import json
          import sys
          from pathlib import Path

          baseline_file = Path('tests/.zero_coverage_baseline')
          baseline = set()
          if baseline_file.exists():
              baseline = set(line.strip() for line in baseline_file.read_text().splitlines() if line.strip())

          try:
              with open('cov.json') as f:
                  data = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              print('Coverage data not available, skipping check')
              sys.exit(0)

          zero_cov = []
          for file, info in data.get('files', {}).items():
              if info.get('summary', {}).get('percent_covered', 100) == 0:
                  if file not in baseline:
                      zero_cov.append(file)

          if zero_cov:
              print('::error::New zero-coverage files detected:')
              for f in sorted(zero_cov)[:20]:
                  print(f'  - {f}')
              if len(zero_cov) > 20:
                  print(f'  ... and {len(zero_cov) - 20} more')
              print('Add to tests/.zero_coverage_baseline if intentional')
              sys.exit(1)
          print('No new zero-coverage files detected')
          "

  # Fast parallel tests by category (Ubuntu only, primary Python)
  test-fast:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: baseline-determinism
    strategy:
      fail-fast: false
      matrix:
        category:
          - name: core
            path: tests/debate tests/agents tests/rlm tests/reasoning tests/workflow tests/client
          - name: server
            path: tests/server
          - name: handlers
            path: tests/handlers
          - name: knowledge
            path: tests/knowledge tests/evidence tests/memory
          - name: storage
            path: tests/storage tests/ranking tests/persistence tests/billing
          - name: infra
            path: tests/nomic tests/control_plane tests/rbac tests/events tests/observability tests/compliance tests/gauntlet tests/cli

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,research,test]"
          pip install pytest-timeout pytest-xdist

      - name: Run ${{ matrix.category.name }} tests
        run: |
          pytest ${{ matrix.category.path }} \
            -m "not slow and not load and not e2e and not integration and not integration_minimal and not benchmark and not performance" \
            --timeout=120 \
            -n auto \
            --dist loadscope \
            -v \
            --tb=short \
            --durations=20 \
            --durations-min=1.0
        env:
          PYTHONPATH: .

  # Integration smoke lane for high-risk paths (PR only)
  integration-smoke:
    name: Integration Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: baseline-determinism
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for high-risk path changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            high_risk:
              - 'aragora/server/**'
              - 'aragora/debate/**'
              - 'aragora/memory/**'
              - 'aragora/auth/**'
              - 'aragora/rbac/**'
              - 'aragora/storage/**'

      - name: Set up Python 3.11
        if: steps.changes.outputs.high_risk == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        if: steps.changes.outputs.high_risk == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,research,test]"
          pip install pytest-timeout

      - name: Run integration smoke tests
        if: steps.changes.outputs.high_risk == 'true'
        run: |
          pytest tests/handlers/ tests/debate/test_arena*.py tests/memory/ \
            -x \
            --timeout=60 \
            -q \
            --ignore=tests/connectors \
            -k "not benchmark and not slow"
        env:
          PYTHONPATH: .

      - name: Skip (no high-risk changes)
        if: steps.changes.outputs.high_risk != 'true'
        run: echo "No high-risk path changes detected, skipping integration smoke tests."

  test-pollution-randomized:
    name: Randomized Order Pollution Guard
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: test-fast
    strategy:
      fail-fast: false
      matrix:
        seed: [12345, 54321, 99999]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,research,test]"
          pip install pytest-timeout pytest-xdist pytest-randomly

      - name: Compute dynamic seed
        id: dynamic-seed
        run: echo "seed=$(( ${{ github.run_number }} % 100000 ))" >> $GITHUB_OUTPUT

      - name: Run randomized-order guard (seed=${{ matrix.seed }})
        run: |
          pytest tests/debate tests/knowledge tests/server/handlers tests/control_plane tests/agents tests/memory \
            tests/rbac tests/events tests/observability tests/workflow tests/compliance tests/gauntlet tests/cli \
            -m "not slow and not load and not e2e and not integration and not integration_minimal and not benchmark and not performance" \
            --timeout=60 \
            -x \
            -p randomly \
            --randomly-seed=${{ matrix.seed }} \
            -v \
            --tb=short
        env:
          PYTHONPATH: .

      - name: Run randomized-order guard (dynamic seed=${{ steps.dynamic-seed.outputs.seed }})
        run: |
          pytest tests/debate tests/knowledge tests/server/handlers tests/control_plane tests/agents tests/memory \
            tests/rbac tests/events tests/observability tests/workflow tests/compliance tests/gauntlet tests/cli \
            -m "not slow and not load and not e2e and not integration and not integration_minimal and not benchmark and not performance" \
            --timeout=60 \
            -x \
            -p randomly \
            --randomly-seed=${{ steps.dynamic-seed.outputs.seed }} \
            -v \
            --tb=short
        env:
          PYTHONPATH: .

  golden-paths:
    name: Golden Path Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: version-check

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run golden-path harness (fast)
        run: |
          python scripts/golden_paths.py --mode fast --output-dir /tmp/golden_paths

  aragora-debate-tests:
    name: Standalone Debate Package
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: test-fast

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install aragora-debate with dev deps
        run: |
          python -m pip install --upgrade pip
          pip install -e "aragora-debate[dev]"

      - name: Run aragora-debate tests
        run: |
          cd aragora-debate && python -m pytest tests/ -v --tb=short

      - name: Verify imports
        run: |
          python -c "from aragora_debate import Arena, Debate, EvidencePoweredTrickster, ConvergenceDetector, EventEmitter; print('Imports OK')"
          python -c "import aragora_debate; assert aragora_debate.__version__, 'Version missing'"

      - name: Verify CLI demo
        run: |
          python -m aragora_debate --help

  # Full compatibility matrix (reduced)
  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    needs: [test-fast, aragora-debate-tests]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]
        exclude:
          # Reduce matrix size - only test 3.11 on Windows/macOS
          - os: windows-latest
            python-version: "3.10"
          - os: windows-latest
            python-version: "3.12"
          - os: windows-latest
            python-version: "3.13"
          - os: macos-latest
            python-version: "3.10"
          - os: macos-latest
            python-version: "3.12"
          - os: macos-latest
            python-version: "3.13"
          # Skip Ubuntu 3.11 - covered by test-fast
          - os: ubuntu-latest
            python-version: "3.11"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,research,test]"
          pip install pytest-cov pytest-timeout pytest-xdist

      - name: Run tests (parallel with xdist)
        run: |
          pytest tests/ \
            -m "not slow and not load and not e2e and not benchmark and not integration and not integration_minimal and not performance" \
            --timeout=120 \
            --cov=aragora \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=70 \
            -n auto \
            --dist loadscope \
            -v \
            --tb=short
        shell: bash
        env:
          PYTHONPATH: .

      - name: Check critical path coverage
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        run: |
          # Verify critical modules meet higher coverage threshold
          echo "Checking critical module coverage..."
          python -c "
          import xml.etree.ElementTree as ET
          tree = ET.parse('coverage.xml')
          root = tree.getroot()

          CRITICAL_MODULES = {
              'aragora/server': 65,
              'aragora/debate': 60,
              'aragora/memory': 60,
              'aragora/knowledge/mound': 65,
              'aragora/rbac': 70,
              'aragora/auth': 70,
              'aragora/agents': 55,
          }

          failures = []
          for package in root.findall('.//package'):
              name = package.get('name', '')
              for module, threshold in CRITICAL_MODULES.items():
                  if module in name:
                      line_rate = float(package.get('line-rate', 0)) * 100
                      if line_rate < threshold:
                          failures.append(f'{name}: {line_rate:.1f}% < {threshold}%')
                      else:
                          print(f'✓ {name}: {line_rate:.1f}% >= {threshold}%')
                      break

          if failures:
              print('\\n❌ Critical module coverage below threshold:')
              for f in failures:
                  print(f'  • {f}')
              # Phase 4 hardening: Coverage enforcement now blocking (Feb 2026)
              import sys
              sys.exit(1)
          "

      - name: Upload coverage artifacts
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.xml
            htmlcov/
          retention-days: 14

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true
          flags: unittests
          name: aragora-coverage
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Coverage Summary Comment
        if: github.event_name == 'pull_request' && matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMUM_GREEN: 70
          MINIMUM_ORANGE: 55
        # Non-blocking: PR coverage comment is cosmetic and depends on third-party action
        continue-on-error: true

  smoke:
    name: CLI Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: baseline-determinism

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Smoke - demo ask
        run: |
          aragora ask "Smoke test a demo debate" --demo --rounds 1

      - name: Smoke - demo gauntlet
        run: |
          cat > /tmp/aragora_demo_spec.md <<'EOF'
          # Demo Spec
          Build a simple HTTP service that returns "ok" to GET /health.
          EOF
          if ! aragora gauntlet /tmp/aragora_demo_spec.md \
            --input-type spec \
            --agents demo,demo \
            --profile quick \
            --no-probing \
            --no-audit \
            --timeout 30 \
            --output /tmp/aragora_gauntlet_demo.json; then
            echo "Gauntlet exited non-zero (possible needs-review/reject verdict)."
          fi
          test -s /tmp/aragora_gauntlet_demo.json

      - name: Smoke - seed demo data
        run: |
          python scripts/seed_demo.py
          python scripts/seed_demo.py --check

      - name: Smoke - boot server
        run: |
          set -e
          aragora serve --demo --api-port 8090 --ws-port 8765 --host 127.0.0.1 >/tmp/aragora-server.log 2>&1 &
          SERVER_PID=$!
          trap "kill $SERVER_PID 2>/dev/null || true" EXIT
          # Wait for server to be ready (handler init can take ~30s in CI)
          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:8090/healthz >/dev/null 2>&1; then
              echo "Server is healthy after ${i}s."
              break
            fi
            sleep 1
          done
          curl -fsS http://127.0.0.1:8090/healthz >/dev/null
          # Verify key API endpoints return data
          echo "Checking /api/v1/health..."
          curl -fsS http://127.0.0.1:8090/api/v1/health | python -c "import sys,json; d=json.load(sys.stdin); assert d.get('status')=='ok', f'bad health: {d}'"
          echo "Checking leaderboard..."
          curl -fsS http://127.0.0.1:8090/api/leaderboard-view | python -c "import sys,json; d=json.load(sys.stdin); print(f'Agents: {len(d.get(\"agents\",d.get(\"rankings\",[])))}'); assert len(d.get('agents',d.get('rankings',[]))) > 0, 'no agents'"
          echo "All smoke checks passed."

  nightly-slow:
    name: Nightly Slow Tier
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: baseline-determinism
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,research,test]"
          pip install pytest-timeout

      - name: Run slow/load/e2e/benchmark tier
        run: |
          pytest tests/ \
            -m "slow or load or e2e or benchmark" \
            --timeout=600 \
            -v \
            --tb=short \
            --durations=20 \
            --durations-min=2.0
        env:
          PYTHONPATH: .

  frontend:
    name: Frontend E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: aragora/live/package-lock.json

      - name: Install dependencies
        working-directory: aragora/live
        run: npm ci

      - name: TypeScript Type Check
        working-directory: aragora/live
        run: npx tsc --noEmit

      - name: Run Jest unit tests
        working-directory: aragora/live
        run: npx jest --ci --passWithNoTests

      - name: Install Playwright browsers
        working-directory: aragora/live
        run: npx playwright install --with-deps

      - name: Build frontend
        working-directory: aragora/live
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080

      - name: Run E2E tests
        working-directory: aragora/live
        run: npx playwright test
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: aragora/live/playwright-report/
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: aragora/live/test-results/
          retention-days: 7

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install bandit
        run: pip install bandit[toml]

      - name: Run bandit security scan
        run: |
          bandit -c pyproject.toml -r aragora/ -ll -iii --format json --output bandit-report.json || true
          bandit -c pyproject.toml -r aragora/ -ll -iii --format txt

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 30

  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install mypy types-requests types-aiofiles

      - name: Run mypy
        run: |
          mypy aragora/ --ignore-missing-imports --no-error-summary --show-error-codes 2>&1 | head -100 || true

  # NOTE: Performance benchmarks are handled by .github/workflows/benchmark.yml
  # which runs with full pytest-benchmark tooling, regression detection, and
  # baseline comparison. Do not duplicate benchmark runs here.

  # Database migration testing
  migration-test:
    name: Database Migrations
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: aragora
          POSTGRES_PASSWORD: aragora
          POSTGRES_DB: aragora_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U aragora"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install alembic psycopg2-binary asyncpg

      - name: Verify migration files
        run: |
          echo "Checking migration files..."
          ls -la migrations/versions/
          # Ensure all migration files are valid Python
          for f in migrations/versions/*.py; do
            python -m py_compile "$f"
            echo "✓ $f is valid Python"
          done

      - name: Run migrations (upgrade)
        run: |
          echo "Running migrations to head..."
          alembic upgrade head
          echo "✓ Migrations completed successfully"
        env:
          DATABASE_URL: postgresql://aragora:aragora@localhost:5432/aragora_test

      - name: Verify schema
        run: |
          echo "Verifying schema tables exist..."
          PGPASSWORD=aragora psql -h localhost -U aragora -d aragora_test -c "
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = 'aragora'
            ORDER BY table_name;
          "

      - name: Test migration rollback
        run: |
          echo "Testing rollback (downgrade)..."
          # Downgrade one step
          alembic downgrade -1 || echo "Downgrade not supported (expected for initial migration)"
        env:
          DATABASE_URL: postgresql://aragora:aragora@localhost:5432/aragora_test

      - name: Re-run migrations
        run: |
          echo "Re-running migrations after rollback..."
          alembic upgrade head
          echo "✓ Re-migration successful"
        env:
          DATABASE_URL: postgresql://aragora:aragora@localhost:5432/aragora_test

  nightly-optional:
    name: Optional Deps (Full)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: baseline-determinism
    # Run on schedule, push to main, or workflow_dispatch
    if: github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: aragora
          POSTGRES_PASSWORD: aragora
          POSTGRES_DB: aragora
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U aragora"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test,research]"
          pip install mcp || true

      - name: Run optional-deps test suite
        run: |
          pytest tests/ \
            -m "not load and not e2e" \
            --timeout=180 \
            -v \
            --tb=short
        env:
          PYTHONPATH: .
          DATABASE_URL: postgresql://aragora:aragora@localhost:5432/aragora
          ARAGORA_POSTGRES_DSN: postgresql://aragora:aragora@localhost:5432/aragora
          ARAGORA_REDIS_URL: redis://localhost:6379
          SUPABASE_URL: https://test.supabase.co
          SUPABASE_KEY: test-key
          SUPABASE_JWT_SECRET: test-secret

      - name: Run network-marked tests
        run: |
          pytest tests/ -m "network" --timeout=240 -v --tb=short
        env:
          PYTHONPATH: .

  # Test Analytics - Generate flakiness report
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test-fast, test]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: RBAC coverage audit
        run: python scripts/audit_rbac_coverage.py

      - name: Handler structure audit
        run: python scripts/audit_handler_structure.py

  test-analytics:
    name: Test Analytics
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [test-fast]
    if: always() && github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
          cache-dependency-path: pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pytest-rerunfailures

      - name: Run tests with JUnit output
        id: tests
        # Non-blocking: This job is for flakiness analysis (--reruns=2), not a release gate.
        # Gating tests run in test-fast and test jobs above.
        continue-on-error: true
        run: |
          pytest tests/debate tests/agents tests/server \
            -m "not slow and not load and not e2e" \
            --timeout=60 \
            --reruns=2 \
            --junit-xml=test-results.xml \
            -v \
            --tb=short

      - name: Analyze test results
        id: analyze
        run: |
          python scripts/analyze_test_results.py \
            --junit test-results.xml \
            --format markdown \
            --output test-summary.md

          # Store summary for PR comment
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat test-summary.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results.xml
            test-summary.md
          retention-days: 14

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `${{ steps.analyze.outputs.summary }}`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Test Results Summary')
            );

            const body = summary || '## Test Results Summary\n\nNo test results available.';

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
