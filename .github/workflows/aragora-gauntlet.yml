name: Aragora Gauntlet Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  gauntlet:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Aragora
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .

      - name: Check API keys
        id: keys
        run: |
          if [ -n "${ANTHROPIC_API_KEY}" ] || [ -n "${OPENAI_API_KEY}" ] || [ -n "${GEMINI_API_KEY}" ] || [ -n "${OPENROUTER_API_KEY}" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      - name: Build diff input
        if: steps.keys.outputs.run == 'true'
        run: |
          git diff "${{ github.event.pull_request.base.sha }}...${{ github.sha }}" > /tmp/pr.diff
          echo "Diff size: $(wc -c < /tmp/pr.diff) bytes"

      - name: Run Gauntlet on PR diff
        if: steps.keys.outputs.run == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          mkdir -p artifacts
          aragora gauntlet /tmp/pr.diff \
            --input-type code \
            --profile code \
            --output artifacts/gauntlet_receipt.html

      - name: Upload Decision Receipt
        if: steps.keys.outputs.run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: gauntlet-decision-receipt
          path: artifacts/gauntlet_receipt.html

      - name: Skip (missing API keys)
        if: steps.keys.outputs.run != 'true'
        run: |
          echo "Skipping Gauntlet run: no API keys configured in secrets."
