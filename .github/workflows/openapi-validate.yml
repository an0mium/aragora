name: "API: OpenAPI Spec Validation"

on:
  push:
    branches: [main]
    paths:
      - 'aragora/server/handlers/**'
      - 'aragora/server/openapi/**'
      - 'aragora/server/openapi_impl.py'
      - 'scripts/generate_openapi.py'
  pull_request:
    branches: [main]
    paths:
      - 'aragora/server/handlers/**'
      - 'aragora/server/openapi/**'
      - 'aragora/server/openapi_impl.py'
      - 'scripts/generate_openapi.py'
  workflow_dispatch:

concurrency:
  group: openapi-validate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  openapi-generate:
    name: Generate & Validate OpenAPI Spec
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[test]"
          pip install pyyaml

      - name: Generate OpenAPI spec
        run: |
          python scripts/generate_openapi.py --output /tmp/openapi.yaml --format yaml --quiet
          python scripts/generate_openapi.py --output /tmp/openapi.json --format json --quiet

      - name: Validate spec structure
        run: |
          python -c "
          import json, sys

          with open('/tmp/openapi.json') as f:
              spec = json.load(f)

          errors = []

          # Check OpenAPI version
          if spec.get('openapi') != '3.1.0':
              errors.append(f\"OpenAPI version is {spec.get('openapi')!r}, expected '3.1.0'\")

          # Check required top-level keys
          for key in ('info', 'paths', 'servers', 'components'):
              if key not in spec:
                  errors.append(f'Missing required top-level key: {key}')

          # Check info fields
          info = spec.get('info', {})
          if not info.get('title'):
              errors.append('Missing info.title')
          if not info.get('version'):
              errors.append('Missing info.version')

          # Check security scheme
          schemes = spec.get('components', {}).get('securitySchemes', {})
          if 'bearerAuth' not in schemes:
              errors.append('Missing bearerAuth security scheme')

          # Check paths exist
          paths = spec.get('paths', {})
          if not paths:
              errors.append('No paths defined in spec')

          # Count operations
          total_ops = sum(len(methods) for methods in paths.values())
          print(f'Total paths: {len(paths)}')
          print(f'Total operations: {total_ops}')

          if errors:
              for e in errors:
                  print(f'::error::{e}')
              sys.exit(1)
          else:
              print('Spec structure validation passed')
          "

      - name: Validate all paths start with /api/ or are system paths
        run: |
          python -c "
          import json, sys

          with open('/tmp/openapi.json') as f:
              spec = json.load(f)

          # System paths that are allowed without /api/ prefix
          ALLOWED_NON_API = {'/healthz', '/readyz', '/readyz/dependencies', '/status', '/audio'}

          non_api_paths = []
          for path in spec.get('paths', {}):
              if not path.startswith('/api/') and path not in ALLOWED_NON_API:
                  non_api_paths.append(path)

          if non_api_paths:
              print(f'::warning::Found {len(non_api_paths)} paths not starting with /api/:')
              for p in sorted(non_api_paths)[:20]:
                  print(f'  {p}')
              if len(non_api_paths) > 20:
                  print(f'  ... and {len(non_api_paths) - 20} more')
          else:
              print('All paths start with /api/ or are allowed system paths')
          "

      - name: Validate YAML output is parseable
        run: |
          python -c "
          import yaml, sys
          with open('/tmp/openapi.yaml') as f:
              spec = yaml.safe_load(f)
          assert spec.get('openapi') == '3.1.0', f\"YAML spec version: {spec.get('openapi')}\"
          print(f\"YAML spec valid: {len(spec.get('paths', {}))} paths\")
          "

      - name: AST-only generation smoke test
        run: |
          python scripts/generate_openapi.py --ast-only --output /tmp/openapi_ast.json --format json --quiet
          python -c "
          import json
          with open('/tmp/openapi_ast.json') as f:
              spec = json.load(f)
          paths = spec.get('paths', {})
          total = sum(len(m) for m in paths.values())
          print(f'AST-only mode: {len(paths)} paths, {total} operations')
          assert spec.get('openapi') == '3.1.0'
          "
