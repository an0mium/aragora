name: Migration Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]
    paths:
      - 'aragora/migrations/**'
      - 'aragora/persistence/migrations/**'
      - 'aragora/storage/**'
      - 'tests/migrations/**'
      - 'tests/persistence/test_migration*'
      - 'tests/test_migrations.py'
      - 'tests/test_migration_patterns.py'
      - 'pyproject.toml'
      - '.github/workflows/migration-tests.yml'
  push:
    branches: [main]
    paths:
      - 'aragora/migrations/**'
      - 'aragora/persistence/migrations/**'
      - 'aragora/storage/**'
      - 'tests/migrations/**'
      - 'tests/persistence/test_migration*'
      - 'tests/test_migrations.py'
      - 'tests/test_migration_patterns.py'
      - 'pyproject.toml'
      - '.github/workflows/migration-tests.yml'
  workflow_dispatch:

concurrency:
  group: migration-tests-${{ github.ref }}
  cancel-in-progress: false

jobs:
  migration-tests:
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    name: Migration Tests (SQLite)
    runs-on: aragora
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run migration runner tests
        run: |
          pytest tests/test_migrations.py -v --timeout=60 --tb=short
        env:
          PYTHONPATH: .

      - name: Run migration pattern tests
        run: |
          pytest tests/test_migration_patterns.py -v --timeout=60 --tb=short
        env:
          PYTHONPATH: .

      - name: Run new migration forward/rollback tests
        run: |
          pytest tests/migrations/test_new_migrations.py -v --timeout=60 --tb=short
        env:
          PYTHONPATH: .

      - name: Run concurrent migration tests
        run: |
          pytest tests/migrations/test_concurrent_migrations.py -v --timeout=60 --tb=short
        env:
          PYTHONPATH: .

      - name: Run persistence migration runner tests
        run: |
          pytest tests/persistence/test_migration_runner.py -v --timeout=60 --tb=short
        env:
          PYTHONPATH: .

      - name: Run persistence consolidation tests
        run: |
          pytest tests/persistence/test_migrations.py -v --timeout=60 --tb=short
        env:
          PYTHONPATH: .

      - name: Validate forward and backward migration lifecycle
        run: |
          python -c "
          from aragora.migrations.runner import MigrationRunner, _load_migrations
          from aragora.storage.backends import SQLiteBackend
          import tempfile, os

          # Create a temp database
          with tempfile.TemporaryDirectory() as tmpdir:
              db_path = os.path.join(tmpdir, 'lifecycle_test.db')
              backend = SQLiteBackend(db_path)
              runner = MigrationRunner(backend=backend)
              _load_migrations(runner)

              # Forward: apply all migrations
              applied = runner.upgrade()
              print(f'Applied {len(applied)} migrations forward')
              assert len(applied) > 0, 'Expected at least one migration to apply'

              # Verify idempotency
              second_pass = runner.upgrade()
              assert len(second_pass) == 0, 'Second upgrade should be a no-op'

              # Check status
              status = runner.status()
              print(f'Status: {status[\"applied_count\"]} applied, {status[\"pending_count\"]} pending')
              assert status['pending_count'] == 0, 'All migrations should be applied'

              # Backward: rollback all migrations that have down_sql/down_fn
              rolled_back = runner.downgrade(target_version=0)
              print(f'Rolled back {len(rolled_back)} migrations')

              # Re-apply to confirm round-trip works
              reapplied = runner.upgrade()
              print(f'Re-applied {len(reapplied)} migrations after rollback')

              runner.close()
              print('Migration lifecycle validation PASSED')
          "
        env:
          PYTHONPATH: .

      - name: Migration test summary
        if: always()
        run: |
          echo "## Migration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Validates database migration infrastructure:" >> $GITHUB_STEP_SUMMARY
          echo "- Migration runner (register, upgrade, downgrade, status)" >> $GITHUB_STEP_SUMMARY
          echo "- Zero-downtime migration patterns (add/drop/rename column, indexes)" >> $GITHUB_STEP_SUMMARY
          echo "- Individual migration forward and rollback execution" >> $GITHUB_STEP_SUMMARY
          echo "- Concurrent migration locking (advisory lock simulation)" >> $GITHUB_STEP_SUMMARY
          echo "- Persistence migration runner with checksum verification" >> $GITHUB_STEP_SUMMARY
          echo "- Database consolidation and table migration" >> $GITHUB_STEP_SUMMARY
          echo "- Full forward/backward lifecycle validation against SQLite" >> $GITHUB_STEP_SUMMARY
