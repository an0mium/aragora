name: Deploy (Legacy)

# ⚠️ DEPRECATED: This workflow uses long-lived SSH keys which is a security risk.
# Use deploy-secure.yml instead, which uses AWS OIDC authentication.
#
# Migration guide: See docs/CI_CD_SECURITY.md
#
# This workflow will be removed in a future release. It is currently disabled
# for automated triggers and only available via manual workflow_dispatch.

on:
  # Disabled automatic triggers - use deploy-secure.yml for push-triggered deploys
  # push:
  #   branches: [main]
  #   paths:
  #     - 'aragora/**'
  #     - '.github/workflows/deploy.yml'
  #     - 'requirements.txt'
  #     - 'pyproject.toml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - cloudflare
          - ec2

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deprecation-warning:
    runs-on: ubuntu-latest
    steps:
      - name: Show deprecation warning
        run: |
          echo "::warning::This workflow (deploy.yml) is DEPRECATED and uses insecure SSH keys."
          echo "::warning::Please use deploy-secure.yml instead, which uses AWS OIDC authentication."
          echo "::warning::See docs/CI_CD_SECURITY.md for migration instructions."
          echo ""
          echo "## ⚠️ Deprecation Notice" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow uses **long-lived SSH keys** stored in GitHub secrets." >> $GITHUB_STEP_SUMMARY
          echo "This is a security risk. Please migrate to **deploy-secure.yml** which uses:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ AWS OIDC authentication (no stored credentials)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ AWS SSM Run Command (no SSH access)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Temporary, scoped credentials" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Full audit trail in AWS CloudTrail" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [CI/CD Security Guide](../docs/CI_CD_SECURITY.md) for migration instructions." >> $GITHUB_STEP_SUMMARY

  # Note: Tests run via separate Tests workflow. This workflow deploys directly.
  # Use branch protection to require Tests workflow to pass before merge.

  deploy-cloudflare:
    needs: deprecation-warning
    if: github.event.inputs.environment == 'all' || github.event.inputs.environment == 'cloudflare' || github.event.inputs.environment == null || github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare Pages (aragora)
        run: |
          cd aragora/live
          npm ci
          npm run build:export
          wrangler pages deploy out --project-name=aragora --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # Next.js public env vars - must be set at build time
          NEXT_PUBLIC_WS_URL: wss://api.aragora.ai/ws
          NEXT_PUBLIC_API_URL: https://api.aragora.ai
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Deploy to Cloudflare Pages (aragora-live)
        run: |
          cd aragora/live
          wrangler pages deploy out --project-name=aragora-live --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # Next.js public env vars - must be set at build time
          NEXT_PUBLIC_WS_URL: wss://api.aragora.ai/ws
          NEXT_PUBLIC_API_URL: https://api.aragora.ai
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
        continue-on-error: true

  deploy-lightsail:
    # DISABLED: Lightsail deprecated in favor of multi-EC2 with Cloudflare Load Balancer
    # See deploy/cloudflare-lb-setup.md for architecture details
    needs: deprecation-warning
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH
        id: ssh_config
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail
          chmod 600 ~/.ssh/lightsail
          # Timeout after 10 seconds if host unreachable
          if timeout 10 ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "ssh_ready=true" >> $GITHUB_OUTPUT
            echo "SSH keyscan successful"
          else
            echo "ssh_ready=false" >> $GITHUB_OUTPUT
            echo "::warning::Could not reach Lightsail host - instance may be stopped or firewall blocking SSH"
            echo "::warning::Check that the Lightsail instance is running and security group allows SSH from GitHub Actions"
          fi

      - name: Deploy to Lightsail
        id: lightsail_deploy
        if: steps.ssh_config.outputs.ssh_ready == 'true'
        run: |
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -i ~/.ssh/lightsail ubuntu@${{ secrets.LIGHTSAIL_HOST }} 'bash -s' << 'ENDSSH'
            set -e
            cd /home/ubuntu/aragora

            # Save current commit for rollback (clean up stale state file first)
            PREVIOUS_COMMIT=$(git rev-parse HEAD)
            rm -f /tmp/aragora_deploy_state 2>/dev/null || sudo rm -f /tmp/aragora_deploy_state 2>/dev/null || true
            echo "PREVIOUS_COMMIT=$PREVIOUS_COMMIT" > /tmp/aragora_deploy_state
            echo "Saved rollback point: $PREVIOUS_COMMIT"

            echo "Stashing any local changes..."
            git stash --include-untracked || true
            echo "Pulling latest code..."
            git pull origin main
            source venv/bin/activate
            echo "Installing package (low memory mode)..."
            pip install -e . --quiet --no-cache-dir

            # Create required directories for debate persistence
            echo "Creating data directories..."
            mkdir -p /home/ubuntu/aragora/.nomic
            chmod 755 /home/ubuntu/aragora/.nomic

            # Pre-flight check: verify server module can be imported
            echo "Running pre-flight import check..."
            if ! python -c "from aragora.server.unified_server import UnifiedServer; print('Import OK')" 2>&1; then
              echo "::error::Pre-flight import check failed! Python traceback:"
              python -c "from aragora.server.unified_server import UnifiedServer" 2>&1 || true
              exit 1
            fi

            # Configure nginx for WebSocket routing if nginx is installed (non-fatal)
            # Script auto-detects SSL certs and uses HTTP-only config if none found
            if command -v nginx &> /dev/null && [ -f deploy/configure-nginx.sh ]; then
              echo "Configuring nginx for WebSocket routing..."
              chmod +x deploy/configure-nginx.sh
              if ./deploy/configure-nginx.sh; then
                echo "Nginx configured successfully"
              else
                echo "::warning::Nginx configuration failed (non-fatal), continuing with deploy"
              fi
            fi

            # Update systemd service
            echo "Updating systemd service..."
            sudo cp deploy/aragora.service /etc/systemd/system/aragora.service.tmp
            sudo sed -i 's|/opt/aragora|/home/ubuntu/aragora|g' /etc/systemd/system/aragora.service.tmp
            sudo sed -i 's|User=aragora|User=ubuntu|g' /etc/systemd/system/aragora.service.tmp
            sudo sed -i 's|Group=aragora|Group=ubuntu|g' /etc/systemd/system/aragora.service.tmp
            sudo mv /etc/systemd/system/aragora.service.tmp /etc/systemd/system/aragora.service
            sudo systemctl daemon-reload
            echo "Restarting service..."
            sudo systemctl restart aragora
            echo "Checking service status..."
            sleep 5
            if ! sudo systemctl is-active --quiet aragora; then
              echo "::error::Service failed to start! Showing recent logs:"
              sudo journalctl -u aragora -n 100 --no-pager || true
              exit 1
            fi
            sudo systemctl status aragora --no-pager || true

            # Ensure cloudflared tunnel is running for api.aragora.ai
            echo "Checking cloudflared tunnel status..."
            if sudo systemctl is-active --quiet cloudflared; then
              echo "Cloudflared tunnel is running"
            else
              echo "::warning::Cloudflared tunnel is not running! Attempting to start..."
              sudo systemctl start cloudflared || true
              sleep 2
              if sudo systemctl is-active --quiet cloudflared; then
                echo "Cloudflared tunnel started successfully"
              else
                echo "::error::Failed to start cloudflared tunnel!"
                sudo journalctl -u cloudflared -n 50 --no-pager || true
              fi
            fi
            sudo systemctl status cloudflared --no-pager || true

            echo "Deploy complete"
          ENDSSH

      - name: Verify deployment
        id: lightsail_verify
        if: steps.ssh_config.outputs.ssh_ready == 'true'
        run: |
          # Wait for server to start (up to 60 seconds) - use SSH to check locally
          ssh -o ConnectTimeout=10 -i ~/.ssh/lightsail ubuntu@${{ secrets.LIGHTSAIL_HOST }} 'bash -s' << 'VERIFYEOF'
            for i in {1..12}; do
              if curl -sf "http://localhost:8080/api/health" -o /dev/null 2>/dev/null; then
                echo "Health check passed (port 8080)"
                exit 0
              fi
              echo "Waiting for server... attempt $i/12"
              sleep 5
            done
            echo "Health check failed after 60 seconds"
            exit 1
          VERIFYEOF
          if [ $? -eq 0 ]; then
            echo "health_ok=true" >> $GITHUB_OUTPUT
          else
            echo "health_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify tunnel routing
        if: steps.ssh_config.outputs.ssh_ready == 'true' && steps.lightsail_verify.outputs.health_ok == 'true'
        run: |
          # Verify api.aragora.ai tunnel routes to Lightsail
          echo "Checking api.aragora.ai tunnel routing..."
          HEALTH_RESPONSE=$(curl -sf "https://api.aragora.ai/api/health" 2>/dev/null || echo '{}')
          NOMIC_PATH=$(echo "$HEALTH_RESPONSE" | jq -r '.checks.nomic_dir.path // "unknown"')

          if [[ "$NOMIC_PATH" == *"/home/ubuntu/"* ]]; then
            echo "Tunnel correctly routing to Lightsail (path: $NOMIC_PATH)"
          elif [[ "$NOMIC_PATH" == *"/home/ec2-user/"* ]]; then
            echo "::warning::Tunnel routing to EC2 instead of Lightsail! Path: $NOMIC_PATH"
            echo "::warning::Check cloudflared tunnel configuration on Lightsail"
          else
            echo "::warning::Could not verify tunnel routing (path: $NOMIC_PATH)"
          fi

      - name: Rollback on failure
        if: steps.ssh_config.outputs.ssh_ready == 'true' && steps.lightsail_verify.outputs.health_ok == 'false'
        run: |
          echo "::warning::Health check failed - initiating rollback"
          ssh -o ConnectTimeout=30 -i ~/.ssh/lightsail ubuntu@${{ secrets.LIGHTSAIL_HOST }} 'bash -s' << 'ENDSSH'
            set -e
            cd /home/ubuntu/aragora

            # Load previous commit
            if [ -f /tmp/aragora_deploy_state ]; then
              source /tmp/aragora_deploy_state
              echo "Rolling back to: $PREVIOUS_COMMIT"

              # Stash any local changes (including permission changes from chmod)
              git stash --include-untracked || true

              # Checkout previous commit
              git checkout $PREVIOUS_COMMIT

              # Reinstall
              source venv/bin/activate
              pip install -e . --quiet --no-cache-dir

              # Restart service
              sudo systemctl restart aragora
              sleep 5

              # Verify rollback
              if sudo systemctl is-active --quiet aragora; then
                echo "::notice::Rollback successful - service running on $PREVIOUS_COMMIT"
              else
                echo "::error::Rollback failed - service not running"
                sudo journalctl -u aragora -n 50 --no-pager || true
              fi

              # Cleanup
              rm -f /tmp/aragora_deploy_state
            else
              echo "::error::No rollback state found"
            fi
          ENDSSH

      - name: Skip notification
        if: steps.ssh_config.outputs.ssh_ready != 'true'
        run: |
          echo "::notice::Lightsail deployment skipped - host unreachable"
          echo "To fix this, ensure:"
          echo "  1. The Lightsail instance is running"
          echo "  2. Security group allows SSH (port 22) from 0.0.0.0/0 or GitHub Actions IPs"
          echo "  3. The LIGHTSAIL_HOST secret contains the correct IP address"

  deploy-ec2:
    needs: deprecation-warning
    if: github.event.inputs.environment == 'all' || github.event.inputs.environment == 'ec2' || github.event.inputs.environment == null
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true  # Don't fail the workflow if EC2 is unreachable

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH
        id: ssh_config
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2
          chmod 600 ~/.ssh/ec2
          # Timeout after 10 seconds if host unreachable (matches Lightsail behavior)
          if timeout 10 ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "ssh_ready=true" >> $GITHUB_OUTPUT
            echo "SSH keyscan successful for EC2"
          else
            echo "ssh_ready=false" >> $GITHUB_OUTPUT
            echo "::warning::Could not reach EC2 host - instance may be stopped or firewall blocking SSH"
            echo "::warning::Check that the EC2 instance is running and security group allows SSH from GitHub Actions"
          fi

      - name: Deploy to EC2
        id: ec2_deploy
        if: steps.ssh_config.outputs.ssh_ready == 'true'
        run: |
          ssh -i ~/.ssh/ec2 ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/aragora || cd /home/ec2-user/aragora || cd /home/ubuntu/aragora

            # Save current commit for rollback (clean up stale state file first)
            PREVIOUS_COMMIT=$(git rev-parse HEAD)
            rm -f /tmp/aragora_deploy_state 2>/dev/null || sudo rm -f /tmp/aragora_deploy_state 2>/dev/null || true
            echo "PREVIOUS_COMMIT=$PREVIOUS_COMMIT" > /tmp/aragora_deploy_state
            echo "Saved rollback point: $PREVIOUS_COMMIT"

            echo "Stashing any local changes..."
            git stash --include-untracked || true
            echo "Pulling latest code..."
            git pull origin main
            source venv/bin/activate || source ~/venv/bin/activate
            echo "Installing package..."
            pip install -e . --quiet

            # Create required directories for debate persistence
            echo "Creating data directories..."
            mkdir -p ~/.nomic
            chmod 755 ~/.nomic

            # Pre-flight check: verify server module can be imported
            echo "Running pre-flight import check..."
            if ! python -c "from aragora.server.unified_server import UnifiedServer; print('Import OK')" 2>&1; then
              echo "::error::Pre-flight import check failed! Python traceback:"
              python -c "from aragora.server.unified_server import UnifiedServer" 2>&1 || true
              exit 1
            fi

            # Configure environment via systemd override (secure - not written to .env file)
            echo "Configuring environment via systemd..."
            sudo mkdir -p /etc/systemd/system/aragora.service.d/
            echo '[Service]' | sudo tee /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="ARAGORA_ENV=production"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="ARAGORA_DB_BACKEND=postgres"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="ARAGORA_USE_SECRETS_MANAGER=true"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="ARAGORA_SECRET_NAME=aragora/production"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="AWS_REGION=us-east-2"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="OAUTH_ALLOWED_REDIRECT_HOSTS=aragora.ai,www.aragora.ai,live.aragora.ai"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="GOOGLE_OAUTH_REDIRECT_URI=https://api.aragora.ai/api/auth/oauth/google/callback"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="GITHUB_OAUTH_REDIRECT_URI=https://api.aragora.ai/api/auth/oauth/github/callback"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="OAUTH_SUCCESS_URL=https://aragora.ai/auth/callback"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="OAUTH_ERROR_URL=https://aragora.ai/auth/error"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="OAUTH_DEBUG=1"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo "Environment=\"ARAGORA_API_TOKEN=${{ secrets.ARAGORA_API_TOKEN }}\"" | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo "Environment=\"OAUTH_JWT_SECRET=${{ secrets.OAUTH_JWT_SECRET }}\"" | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            sudo systemctl daemon-reload

            # Configure nginx for WebSocket routing if nginx is installed (non-fatal)
            # Script auto-detects SSL certs and uses HTTP-only config if none found
            if command -v nginx &> /dev/null && [ -f deploy/configure-nginx.sh ]; then
              echo "Configuring nginx for WebSocket routing..."
              chmod +x deploy/configure-nginx.sh
              if ./deploy/configure-nginx.sh; then
                echo "Nginx configured successfully"
              else
                echo "::warning::Nginx configuration failed (non-fatal), continuing with deploy"
              fi
            fi

            # Update cloudflared tunnel config to route through nginx (for CORS headers)
            if command -v cloudflared &> /dev/null; then
              echo "Updating cloudflared config to route through nginx..."
              CLOUDFLARED_CONFIG_DIR="$HOME/.cloudflared"
              if [ -d "$CLOUDFLARED_CONFIG_DIR" ]; then
                # Check if config needs update to route through nginx (port 80)
                if ! grep -q "service: http://localhost:80" "$CLOUDFLARED_CONFIG_DIR/config.yml" 2>/dev/null; then
                  echo "Updating cloudflared to route through nginx..."
                  # Backup existing config
                  cp "$CLOUDFLARED_CONFIG_DIR/config.yml" "$CLOUDFLARED_CONFIG_DIR/config.yml.bak" 2>/dev/null || true
                  # Create updated config routing through nginx for CORS support
                  echo "ingress:" > "$CLOUDFLARED_CONFIG_DIR/config.yml.new"
                  echo "  - hostname: api.aragora.ai" >> "$CLOUDFLARED_CONFIG_DIR/config.yml.new"
                  echo "    service: http://localhost:80" >> "$CLOUDFLARED_CONFIG_DIR/config.yml.new"
                  echo "  - service: http_status:404" >> "$CLOUDFLARED_CONFIG_DIR/config.yml.new"
                  # Preserve tunnel token from old config if present
                  if grep -q "^tunnel:" "$CLOUDFLARED_CONFIG_DIR/config.yml" 2>/dev/null; then
                    grep "^tunnel:" "$CLOUDFLARED_CONFIG_DIR/config.yml" >> "$CLOUDFLARED_CONFIG_DIR/config.yml.new"
                  fi
                  if grep -q "^credentials-file:" "$CLOUDFLARED_CONFIG_DIR/config.yml" 2>/dev/null; then
                    grep "^credentials-file:" "$CLOUDFLARED_CONFIG_DIR/config.yml" >> "$CLOUDFLARED_CONFIG_DIR/config.yml.new"
                  fi
                  mv "$CLOUDFLARED_CONFIG_DIR/config.yml.new" "$CLOUDFLARED_CONFIG_DIR/config.yml"
                  echo "Restarting cloudflared to apply changes..."
                  sudo systemctl restart cloudflared 2>/dev/null || true
                else
                  echo "Cloudflared already routing through nginx"
                  # Force restart anyway to ensure config is applied
                  echo "Restarting cloudflared to ensure latest config..."
                  sudo systemctl restart cloudflared 2>/dev/null || true
                fi
              else
                echo "::warning::Cloudflared config directory not found"
              fi
            fi

            echo "Stopping service and releasing ports..."
            sudo systemctl stop aragora 2>/dev/null || true
            # Force kill any process still using port 8765 (WebSocket)
            sudo fuser -k 8765/tcp 2>/dev/null || true
            # Force kill any process still using port 8080 (HTTP)
            sudo fuser -k 8080/tcp 2>/dev/null || true
            sleep 2
            echo "Starting service..."
            sudo systemctl start aragora
            echo "Checking service status..."
            sleep 5
            if ! sudo systemctl is-active --quiet aragora; then
              echo "::error::Service failed to start! Showing recent logs:"
              sudo journalctl -u aragora -n 100 --no-pager
              exit 1
            fi
            sudo systemctl status aragora --no-pager
            echo "Deploy complete"
          EOF

      - name: Verify deployment
        id: ec2_verify
        if: steps.ssh_config.outputs.ssh_ready == 'true'
        run: |
          # Wait for server to start (up to 60 seconds) - use SSH to check locally
          # External ports may be blocked by security group
          ssh -o ConnectTimeout=10 -i ~/.ssh/ec2 ec2-user@${{ secrets.EC2_HOST }} 'bash -s' << 'VERIFYEOF'
            for i in {1..12}; do
              if curl -sf "http://localhost:8080/api/health" -o /dev/null 2>/dev/null; then
                echo "Health check passed (port 8080)"
                exit 0
              fi
              if curl -sf "http://localhost/api/health" -o /dev/null 2>/dev/null; then
                echo "Health check passed (nginx port 80)"
                exit 0
              fi
              echo "Waiting for server... attempt $i/12"
              sleep 5
            done
            echo "Health check failed after 60 seconds"
            exit 1
          VERIFYEOF
          if [ $? -eq 0 ]; then
            echo "health_ok=true" >> $GITHUB_OUTPUT
          else
            echo "health_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify cloudflared tunnel
        if: steps.ssh_config.outputs.ssh_ready == 'true' && steps.ec2_verify.outputs.health_ok == 'true'
        run: |
          ssh -o ConnectTimeout=10 -i ~/.ssh/ec2 ec2-user@${{ secrets.EC2_HOST }} 'bash -s' << 'TUNNELEOF'
            echo "Checking cloudflared tunnel status..."

            # Check if cloudflared is enabled (auto-start on boot)
            if ! sudo systemctl is-enabled --quiet cloudflared 2>/dev/null; then
              echo "::warning::cloudflared is not enabled for auto-start, enabling..."
              sudo systemctl enable cloudflared
            fi

            # Check if cloudflared is running
            if ! sudo systemctl is-active --quiet cloudflared; then
              echo "::warning::cloudflared not running, attempting restart..."
              sudo systemctl restart cloudflared
              sleep 5
            fi

            # Verify tunnel connection
            if sudo systemctl is-active --quiet cloudflared; then
              echo "cloudflared is running and enabled"
              sudo systemctl status cloudflared --no-pager | head -15
            else
              echo "::error::cloudflared failed to start"
              sudo journalctl -u cloudflared -n 30 --no-pager
              exit 1
            fi
          TUNNELEOF

      - name: Rollback on failure
        if: steps.ssh_config.outputs.ssh_ready == 'true' && steps.ec2_verify.outputs.health_ok == 'false'
        run: |
          echo "::warning::Health check failed - initiating rollback"
          ssh -o ConnectTimeout=30 -i ~/.ssh/ec2 ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/aragora || cd /home/ec2-user/aragora || cd /home/ubuntu/aragora

            # Load previous commit
            if [ -f /tmp/aragora_deploy_state ]; then
              source /tmp/aragora_deploy_state
              echo "Rolling back to: $PREVIOUS_COMMIT"

              # Stash any local changes (including permission changes from chmod)
              git stash --include-untracked || true

              # Checkout previous commit
              git checkout $PREVIOUS_COMMIT

              # Reinstall
              source venv/bin/activate || source ~/venv/bin/activate
              pip install -e . --quiet

              # Restart service
              sudo systemctl restart aragora
              sleep 5

              # Verify rollback
              if sudo systemctl is-active --quiet aragora; then
                echo "::notice::Rollback successful - service running on $PREVIOUS_COMMIT"
              else
                echo "::error::Rollback failed - service not running"
                sudo journalctl -u aragora -n 50 --no-pager
              fi

              # Cleanup
              rm -f /tmp/aragora_deploy_state
            else
              echo "::error::No rollback state found"
            fi
          EOF

      - name: Fail deploy on health check failure
        if: steps.ssh_config.outputs.ssh_ready == 'true' && steps.ec2_verify.outputs.health_ok == 'false'
        run: |
          echo "::error::EC2 health check failed after deploy; rollback attempted."
          exit 1

      - name: Skip if EC2 unreachable
        if: steps.ssh_config.outputs.ssh_ready == 'false'
        run: |
          echo "::notice::EC2 deployment skipped - host unreachable"
          echo "To fix this, ensure:"
          echo "  1. The EC2 instance is running"
          echo "  2. Security group allows SSH (port 22) from 0.0.0.0/0 or GitHub Actions IPs"
          echo "  3. The EC2_HOST secret contains the correct IP address"

  deploy-ec2-2:
    # EC2 Instance #2 for high availability (requires EC2_HOST_2 and EC2_SSH_KEY_2 secrets)
    needs: deprecation-warning
    if: github.event.inputs.environment == 'all' || github.event.inputs.environment == 'ec2' || github.event.inputs.environment == null
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if EC2 #2 is configured
        id: check_config
        run: |
          if [ -z "${{ secrets.EC2_HOST_2 }}" ] || [ -z "${{ secrets.EC2_SSH_KEY_2 }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::EC2 #2 secrets not configured - skipping deployment"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Configure SSH
        id: ssh_config
        if: steps.check_config.outputs.configured == 'true'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY_2 }}" > ~/.ssh/ec2
          chmod 600 ~/.ssh/ec2
          if timeout 10 ssh-keyscan -H ${{ secrets.EC2_HOST_2 }} >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "ssh_ready=true" >> $GITHUB_OUTPUT
            echo "SSH keyscan successful for EC2 #2"
          else
            echo "ssh_ready=false" >> $GITHUB_OUTPUT
            echo "::warning::Could not reach EC2 #2 host"
          fi

      - name: Deploy to EC2 #2
        id: ec2_deploy
        if: steps.check_config.outputs.configured == 'true' && steps.ssh_config.outputs.ssh_ready == 'true'
        run: |
          ssh -i ~/.ssh/ec2 ec2-user@${{ secrets.EC2_HOST_2 }} << 'EOF'
            set -e
            cd ~/aragora || cd /home/ec2-user/aragora

            # Clean up stale state file first to avoid permission issues
            PREVIOUS_COMMIT=$(git rev-parse HEAD)
            rm -f /tmp/aragora_deploy_state 2>/dev/null || sudo rm -f /tmp/aragora_deploy_state 2>/dev/null || true
            echo "PREVIOUS_COMMIT=$PREVIOUS_COMMIT" > /tmp/aragora_deploy_state

            git stash --include-untracked || true
            git pull origin main
            source venv/bin/activate
            pip install -e . --quiet

            mkdir -p ~/.nomic
            chmod 755 ~/.nomic

            if ! python -c "from aragora.server.unified_server import UnifiedServer; print('Import OK')" 2>&1; then
              exit 1
            fi

            # Configure environment via systemd override
            echo "Configuring environment via systemd..."
            sudo mkdir -p /etc/systemd/system/aragora.service.d/
            echo '[Service]' | sudo tee /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="ARAGORA_ENV=production"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="ARAGORA_DB_BACKEND=postgres"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="ARAGORA_USE_SECRETS_MANAGER=true"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="ARAGORA_SECRET_NAME=aragora/production"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="AWS_REGION=us-east-2"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="OAUTH_ALLOWED_REDIRECT_HOSTS=aragora.ai,www.aragora.ai,live.aragora.ai"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="GOOGLE_OAUTH_REDIRECT_URI=https://api.aragora.ai/api/auth/oauth/google/callback"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="GITHUB_OAUTH_REDIRECT_URI=https://api.aragora.ai/api/auth/oauth/github/callback"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="OAUTH_SUCCESS_URL=https://aragora.ai/auth/callback"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="OAUTH_ERROR_URL=https://aragora.ai/auth/error"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo 'Environment="OAUTH_DEBUG=1"' | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo "Environment=\"ARAGORA_API_TOKEN=${{ secrets.ARAGORA_API_TOKEN }}\"" | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            echo "Environment=\"OAUTH_JWT_SECRET=${{ secrets.OAUTH_JWT_SECRET }}\"" | sudo tee -a /etc/systemd/system/aragora.service.d/env.conf > /dev/null
            sudo systemctl daemon-reload

            sudo systemctl stop aragora 2>/dev/null || true
            sudo fuser -k 8765/tcp 2>/dev/null || true
            sudo fuser -k 8080/tcp 2>/dev/null || true
            sleep 2
            sudo systemctl start aragora
            sleep 5
            if ! sudo systemctl is-active --quiet aragora; then
              sudo journalctl -u aragora -n 100 --no-pager
              exit 1
            fi
            echo "Deploy complete on EC2 #2"
          EOF

      - name: Verify deployment
        id: ec2_verify
        if: steps.check_config.outputs.configured == 'true' && steps.ssh_config.outputs.ssh_ready == 'true'
        run: |
          ssh -o ConnectTimeout=10 -i ~/.ssh/ec2 ec2-user@${{ secrets.EC2_HOST_2 }} 'bash -s' << 'VERIFYEOF'
            for i in {1..12}; do
              if curl -sf "http://localhost:8080/api/health" -o /dev/null 2>/dev/null; then
                echo "Health check passed"
                exit 0
              fi
              sleep 5
            done
            exit 1
          VERIFYEOF
          if [ $? -eq 0 ]; then
            echo "health_ok=true" >> $GITHUB_OUTPUT
          else
            echo "health_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Rollback on failure
        if: steps.check_config.outputs.configured == 'true' && steps.ssh_config.outputs.ssh_ready == 'true' && steps.ec2_verify.outputs.health_ok == 'false'
        run: |
          ssh -o ConnectTimeout=30 -i ~/.ssh/ec2 ec2-user@${{ secrets.EC2_HOST_2 }} << 'EOF'
            set -e
            cd ~/aragora
            if [ -f /tmp/aragora_deploy_state ]; then
              source /tmp/aragora_deploy_state
              git stash --include-untracked || true
              git checkout $PREVIOUS_COMMIT
              source venv/bin/activate
              pip install -e . --quiet
              sudo systemctl restart aragora
              rm -f /tmp/aragora_deploy_state
            fi
          EOF

  notify:
    needs: [deprecation-warning, deploy-cloudflare, deploy-ec2, deploy-ec2-2]
    # Don't run notify when workflow is cancelled - prevents stuck "queued" jobs
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest

    steps:
      - name: Summarize deployment status
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Pages | ${{ needs.deploy-cloudflare.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS EC2 #1 | ${{ needs.deploy-ec2.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS EC2 #2 | ${{ needs.deploy-ec2-2.result }} |" >> $GITHUB_STEP_SUMMARY
