name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - cloudflare
          - lightsail
          - ec2

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Run tests before deploying
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install -e ".[dev]"
          pip install pytest-timeout httpx

      - name: Run quick tests
        run: |
          pytest tests/test_handlers_debates.py tests/test_api_handler.py \
            --timeout=60 -x --tb=short
        env:
          PYTHONPATH: .

  deploy-cloudflare:
    needs: test
    if: github.event.inputs.environment == 'all' || github.event.inputs.environment == 'cloudflare' || github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare Pages (aragora)
        run: |
          cd aragora/live
          npm ci
          npm run build
          wrangler pages deploy out --project-name=aragora --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Pages (aragora-live)
        run: |
          cd aragora/live
          wrangler pages deploy out --project-name=aragora-live --commit-dirty=true
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        continue-on-error: true

  deploy-lightsail:
    needs: test
    if: github.event.inputs.environment == 'all' || github.event.inputs.environment == 'lightsail' || github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail
          chmod 600 ~/.ssh/lightsail
          # Timeout after 10 seconds if host unreachable
          timeout 10 ssh-keyscan -H ${{ secrets.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts || {
            echo "::warning::Could not reach Lightsail host for SSH keyscan"
            exit 1
          }

      - name: Deploy to Lightsail
        run: |
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=30 -o ServerAliveCountMax=10 -i ~/.ssh/lightsail ubuntu@${{ secrets.LIGHTSAIL_HOST }} << EOF
            set -e
            cd /home/ubuntu/aragora
            echo "Stashing any local changes..."
            git stash --include-untracked || true
            echo "Pulling latest code..."
            git pull origin main
            source venv/bin/activate
            echo "Installing package (low memory mode)..."
            pip install -e . --quiet --no-cache-dir
            # Configure Sentry DSN if provided
            if [ -n "${{ secrets.SENTRY_DSN }}" ]; then
              echo "Configuring Sentry DSN..."
              echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" > .env
            fi
            # Update systemd service if needed
            echo "Updating systemd service..."
            sudo tee /etc/systemd/system/aragora.service > /dev/null << 'SERVICE'
[Unit]
Description=Aragora Debate Server
After=network.target

[Service]
Type=simple
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/aragora
Environment="PATH=/home/ubuntu/aragora/venv/bin"
EnvironmentFile=-/home/ubuntu/aragora/.env
ExecStart=/home/ubuntu/aragora/venv/bin/python -m aragora.server --host 0.0.0.0 --port 8765 --http-port 8080 --nomic-dir /home/ubuntu/aragora/.nomic
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=aragora

[Install]
WantedBy=multi-user.target
SERVICE
            sudo systemctl daemon-reload
            echo "Restarting service..."
            sudo systemctl restart aragora
            echo "Checking service status..."
            sleep 3
            sudo systemctl status aragora --no-pager || true
            echo "Deploy complete"
          EOF

      - name: Verify deployment
        run: |
          # Wait for server to start (up to 60 seconds)
          for i in {1..12}; do
            if curl -sf "http://${{ secrets.LIGHTSAIL_HOST }}:8080/api/health" -o /dev/null 2>/dev/null; then
              echo "Health check passed"
              exit 0
            fi
            echo "Waiting for server... attempt $i/12"
            sleep 5
          done
          echo "Health check failed after 60 seconds"
          # Don't fail the job - server may be down for other reasons
          echo "::warning::Lightsail health check failed, but deploy may have completed"

  deploy-ec2:
    needs: test
    if: github.event.inputs.environment == 'all' || github.event.inputs.environment == 'ec2' || github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2
          chmod 600 ~/.ssh/ec2
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/ec2 ec2-user@${{ secrets.EC2_HOST }} << EOF
            set -e
            cd ~/aragora || cd /home/ec2-user/aragora || cd /home/ubuntu/aragora
            echo "Stashing any local changes..."
            git stash --include-untracked || true
            echo "Pulling latest code..."
            git pull origin main
            source venv/bin/activate || source ~/venv/bin/activate
            echo "Installing package..."
            pip install -e . --quiet
            # Configure Sentry DSN if provided
            if [ -n "${{ secrets.SENTRY_DSN }}" ]; then
              echo "Configuring Sentry DSN..."
              echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}" > .env
            fi
            echo "Restarting service..."
            sudo systemctl restart aragora-staging 2>/dev/null || sudo systemctl restart aragora
            echo "Checking service status..."
            sleep 3
            sudo systemctl status aragora-staging --no-pager 2>/dev/null || sudo systemctl status aragora --no-pager || true
            echo "Deploy complete"
          EOF

      - name: Verify deployment
        run: |
          # Wait for server to start (up to 60 seconds)
          # EC2 staging runs on port 8765
          for i in {1..12}; do
            if curl -sf "http://${{ secrets.EC2_HOST }}:8765/api/health" -o /dev/null 2>/dev/null; then
              echo "Health check passed"
              exit 0
            fi
            echo "Waiting for server... attempt $i/12"
            sleep 5
          done
          echo "Health check failed after 60 seconds"
          # Don't fail the job - server may be down for other reasons
          echo "::warning::EC2 health check failed, but deploy completed"

  notify:
    needs: [deploy-cloudflare, deploy-lightsail, deploy-ec2]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Summarize deployment status
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare Pages | ${{ needs.deploy-cloudflare.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS Lightsail | ${{ needs.deploy-lightsail.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS EC2 | ${{ needs.deploy-ec2.result }} |" >> $GITHUB_STEP_SUMMARY
