# Aragora Prometheus Alert Rules
#
# These rules define alerting conditions for the Aragora platform.
# Load with: promtool check rules prometheus_rules.yml
#
# Alert Severity Levels:
#   - critical: Page on-call immediately (service down, data loss risk)
#   - warning: Notify team during business hours (degraded performance)
#   - info: Log for review (anomalous but not urgent)

groups:
  # =========================================================================
  # Availability Alerts
  # =========================================================================
  - name: aragora_availability
    rules:
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(aragora_api_requests_total{status="error"}[5m]))
            /
            sum(rate(aragora_api_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          service: aragora
        annotations:
          summary: "High API error rate ({{ $value | humanizePercentage }})"
          description: "More than 5% of API requests are failing. Check logs for error details."
          runbook_url: "https://docs.aragora.io/runbooks/high-error-rate"

      - alert: ServiceDown
        expr: up{job="aragora"} == 0
        for: 1m
        labels:
          severity: critical
          service: aragora
        annotations:
          summary: "Aragora service is down"
          description: "The Aragora service has been unreachable for more than 1 minute."
          runbook_url: "https://docs.aragora.io/runbooks/service-down"

      - alert: NoRecentDebates
        expr: |
          increase(aragora_debates_completed_total[1h]) == 0
          and
          time() - aragora_last_debate_timestamp > 3600
        for: 30m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "No debates completed in the last hour"
          description: "The system may be stuck or experiencing issues accepting new debates."

  # =========================================================================
  # Latency Alerts
  # =========================================================================
  - name: aragora_latency
    rules:
      - alert: HighAPILatency
        expr: |
          histogram_quantile(0.99,
            sum(rate(aragora_api_latency_seconds_bucket[5m])) by (le)
          ) > 2
        for: 5m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "High API latency (p99 > 2s)"
          description: "99th percentile API latency is {{ $value | humanizeDuration }}. Investigate slow endpoints."

      - alert: HighAgentLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(aragora_agent_latency_seconds_bucket[5m])) by (le, agent)
          ) > 30
        for: 10m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "Agent {{ $labels.agent }} has high latency"
          description: "Agent response time p95 is {{ $value | humanizeDuration }}. May indicate provider issues."

      - alert: DebateTakingTooLong
        expr: |
          histogram_quantile(0.95,
            sum(rate(aragora_debate_duration_seconds_bucket[1h])) by (le)
          ) > 600
        for: 30m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "Debates taking unusually long (p95 > 10 minutes)"
          description: "Most debates are taking over 10 minutes. Check for agent bottlenecks."

  # =========================================================================
  # Debate Quality Alerts
  # =========================================================================
  - name: aragora_debate_quality
    rules:
      - alert: HighDebateFailureRate
        expr: |
          (
            sum(rate(aragora_debates_completed_total{status="error"}[1h]))
            /
            sum(rate(aragora_debates_completed_total[1h]))
          ) > 0.1
        for: 15m
        labels:
          severity: critical
          service: aragora
        annotations:
          summary: "High debate failure rate ({{ $value | humanizePercentage }})"
          description: "More than 10% of debates are failing. Check agent connectivity and circuit breakers."

      - alert: LowConsensusRate
        expr: |
          (
            sum(rate(aragora_consensus_reached_total[6h]))
            /
            sum(rate(aragora_debates_completed_total{status="completed"}[6h]))
          ) < 0.5
        for: 1h
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "Low consensus rate ({{ $value | humanizePercentage }})"
          description: "Less than 50% of debates are reaching consensus. May indicate agent quality issues."

      - alert: LowConsensusConfidence
        expr: avg(aragora_consensus_quality) < 0.6
        for: 2h
        labels:
          severity: info
          service: aragora
        annotations:
          summary: "Low average consensus confidence"
          description: "Average consensus confidence is {{ $value | humanize }}. Quality may be degraded."

  # =========================================================================
  # Resource and Capacity Alerts
  # =========================================================================
  - name: aragora_resources
    rules:
      - alert: AgentCircuitBreakerOpen
        expr: aragora_circuit_breakers_open > 0
        for: 1m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "{{ $value }} circuit breaker(s) open"
          description: "One or more agent circuit breakers are open, indicating repeated failures."

      - alert: HighAgentErrorRate
        expr: |
          (
            sum(rate(aragora_agent_requests_total{status="error"}[5m])) by (agent)
            /
            sum(rate(aragora_agent_requests_total[5m])) by (agent)
          ) > 0.2
        for: 5m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "High error rate for agent {{ $labels.agent }}"
          description: "Agent {{ $labels.agent }} has {{ $value | humanizePercentage }} error rate."

      - alert: TooManyActiveDebates
        expr: aragora_active_debates > 50
        for: 5m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "High number of concurrent debates ({{ $value }})"
          description: "More than 50 debates running concurrently. May need to scale."

      - alert: TooManyWebSocketConnections
        expr: aragora_websocket_connections > 1000
        for: 5m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "High WebSocket connection count ({{ $value }})"
          description: "Consider horizontal scaling or connection limits."

  # =========================================================================
  # Security Alerts
  # =========================================================================
  - name: aragora_security
    rules:
      - alert: HighAuthFailureRate
        expr: |
          sum(rate(aragora_auth_failures_total[5m])) > 10
        for: 5m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "High authentication failure rate"
          description: "{{ $value }} auth failures per second. Possible brute force attack."

      - alert: RateLimitingActive
        expr: |
          sum(rate(aragora_rate_limit_hits_total[5m])) > 100
        for: 5m
        labels:
          severity: info
          service: aragora
        annotations:
          summary: "Heavy rate limiting activity"
          description: "{{ $value }} rate limit hits per second. May indicate abuse or misonfiguration."

      - alert: SecurityViolationDetected
        expr: |
          sum(rate(aragora_security_violations_total[5m])) > 0
        for: 1m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "Security violation detected"
          description: "Security violations of type {{ $labels.type }} detected. Review security logs."

  # =========================================================================
  # Billing Alerts
  # =========================================================================
  - name: aragora_billing
    rules:
      - alert: HighPaymentFailureRate
        expr: |
          (
            sum(rate(aragora_payment_failures_total[1h]))
            /
            sum(rate(aragora_subscription_events_total{event="payment_attempt"}[1h]))
          ) > 0.1
        for: 30m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "High payment failure rate ({{ $value | humanizePercentage }})"
          description: "More than 10% of payment attempts are failing. Check Stripe integration."

      - alert: NoRevenueRecorded
        expr: |
          increase(aragora_revenue_cents_total[24h]) == 0
          and
          increase(aragora_subscription_events_total{event="created"}[24h]) > 0
        for: 1h
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "New subscriptions but no revenue recorded"
          description: "Billing may not be properly tracking revenue."

  # =========================================================================
  # Token Usage Alerts
  # =========================================================================
  - name: aragora_tokens
    rules:
      - alert: HighTokenUsage
        expr: |
          sum(rate(aragora_agent_tokens_total[1h])) > 1000000
        for: 30m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "High token usage rate"
          description: "Using {{ $value | humanize }} tokens/hour. Check for runaway debates."

      - alert: UnbalancedAgentUsage
        expr: |
          (
            max(sum(rate(aragora_agent_tokens_total[1h])) by (agent))
            /
            avg(sum(rate(aragora_agent_tokens_total[1h])) by (agent))
          ) > 5
        for: 1h
        labels:
          severity: info
          service: aragora
        annotations:
          summary: "Unbalanced agent token usage"
          description: "One agent is using 5x more tokens than average. Consider rebalancing."

  # =========================================================================
  # Cross-Functional Feature Alerts (v2.0.3+)
  # =========================================================================
  - name: aragora_cross_functional
    rules:
      - alert: LowKnowledgeCacheHitRate
        expr: |
          (
            sum(rate(aragora_knowledge_cache_hits_total[5m]))
            /
            (sum(rate(aragora_knowledge_cache_hits_total[5m])) + sum(rate(aragora_knowledge_cache_misses_total[5m])))
          ) < 0.5
        for: 15m
        labels:
          severity: info
          service: aragora
        annotations:
          summary: "Low knowledge cache hit rate ({{ $value | humanizePercentage }})"
          description: "Knowledge cache hit rate is below 50%. Consider increasing cache TTL or size."

      - alert: MemoryCoordinatorFailures
        expr: |
          sum(rate(aragora_memory_coordinator_writes_total{status="failed"}[5m])) > 0
        for: 5m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "Memory coordinator write failures"
          description: "{{ $value }} failed atomic writes per second. Check memory system connectivity."

      - alert: HighSelectionFeedbackVolatility
        expr: |
          sum(rate(aragora_selection_feedback_adjustments_total[5m])) > 10
        for: 10m
        labels:
          severity: info
          service: aragora
        annotations:
          summary: "High agent selection feedback volatility"
          description: "{{ $value }} selection weight adjustments per second. May indicate unstable agent performance."

      - alert: WorkflowTriggerFailures
        expr: |
          (
            sum(rate(aragora_workflow_triggers_total{status="failed"}[5m]))
            /
            sum(rate(aragora_workflow_triggers_total[5m]))
          ) > 0.2
        for: 10m
        labels:
          severity: warning
          service: aragora
        annotations:
          summary: "High workflow trigger failure rate ({{ $value | humanizePercentage }})"
          description: "More than 20% of post-debate workflows are failing. Check workflow engine logs."

      - alert: NoEvidenceBeingStored
        expr: |
          increase(aragora_evidence_stored_total[1h]) == 0
          and
          increase(aragora_debates_completed_total[1h]) > 10
        for: 30m
        labels:
          severity: info
          service: aragora
        annotations:
          summary: "No evidence stored despite active debates"
          description: "Evidence collection may be disabled or misconfigured."

      - alert: NoCulturePatternsExtracted
        expr: |
          increase(aragora_culture_patterns_total[6h]) == 0
          and
          increase(aragora_debates_completed_total[6h]) > 20
        for: 1h
        labels:
          severity: info
          service: aragora
        annotations:
          summary: "No culture patterns extracted"
          description: "Culture observation may be disabled. Check KnowledgeMound configuration."

  # =========================================================================
  # Notification Delivery Alerts
  # =========================================================================
  - name: aragora_notifications
    rules:
      - alert: HighNotificationFailureRate
        expr: |
          (
            sum(rate(aragora_notification_sent_total{status="failed"}[5m]))
            /
            sum(rate(aragora_notification_sent_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: notifications
        annotations:
          summary: "High notification failure rate ({{ $value | humanizePercentage }})"
          description: "More than 10% of notifications are failing. Check provider connectivity and credentials."
          runbook_url: "https://docs.aragora.io/runbooks/notification-failures"

      - alert: NotificationChannelDown
        expr: |
          (
            sum(rate(aragora_notification_sent_total{status="failed"}[5m])) by (channel)
            /
            sum(rate(aragora_notification_sent_total[5m])) by (channel)
          ) > 0.5
        for: 5m
        labels:
          severity: critical
          service: aragora
          component: notifications
        annotations:
          summary: "Notification channel {{ $labels.channel }} is mostly failing"
          description: "Channel {{ $labels.channel }} has over 50% failure rate. Check provider status and configuration."
          runbook_url: "https://docs.aragora.io/runbooks/notification-channel-down"

      - alert: HighNotificationLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(aragora_notification_latency_seconds_bucket[5m])) by (le, channel)
          ) > 10
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: notifications
        annotations:
          summary: "High notification latency on {{ $labels.channel }} (p95 > 10s)"
          description: "95th percentile notification latency is {{ $value | humanizeDuration }}. Check provider performance."

      - alert: NotificationQueueBacklog
        expr: |
          aragora_notification_queue_size > 100
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: notifications
        annotations:
          summary: "Notification queue backlog on {{ $labels.channel }}"
          description: "Queue size is {{ $value }}. Notifications may be delayed. Check delivery workers."

      - alert: SlackNotificationErrors
        expr: |
          increase(aragora_notification_errors_total{channel="slack"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: notifications
        annotations:
          summary: "Slack notification errors increasing"
          description: "{{ $value }} Slack errors in the last 5 minutes. Check webhook URL and rate limits."

      - alert: EmailNotificationErrors
        expr: |
          increase(aragora_notification_errors_total{channel="email"}[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: notifications
        annotations:
          summary: "Email notification errors increasing"
          description: "{{ $value }} email errors in the last 5 minutes. Check SMTP configuration."

      - alert: NoNotificationsSent
        expr: |
          increase(aragora_notification_sent_total[1h]) == 0
          and
          increase(aragora_checkpoint_approval_requests_total[1h]) > 0
        for: 30m
        labels:
          severity: warning
          service: aragora
          component: notifications
        annotations:
          summary: "No notifications sent despite checkpoint requests"
          description: "Checkpoint approvals are being requested but no notifications sent. Check notification service."

  # =========================================================================
  # Redis Cluster Alerts
  # =========================================================================
  - name: aragora_redis_cluster
    rules:
      - alert: RedisClusterUnhealthy
        expr: |
          aragora_redis_cluster_health == 0
        for: 2m
        labels:
          severity: critical
          service: aragora
          component: redis
        annotations:
          summary: "Redis cluster is unhealthy"
          description: "Redis cluster health check is failing. Check cluster node connectivity."
          runbook_url: "https://docs.aragora.io/runbooks/redis-cluster-unhealthy"

      - alert: RedisClusterNodeDown
        expr: |
          aragora_redis_cluster_nodes_up < 3
        for: 2m
        labels:
          severity: warning
          service: aragora
          component: redis
        annotations:
          summary: "Redis cluster has fewer than 3 nodes"
          description: "Only {{ $value }} Redis cluster nodes are up. Check cluster membership."

      - alert: RedisClusterReconnections
        expr: |
          increase(aragora_redis_cluster_reconnections_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: redis
        annotations:
          summary: "High Redis cluster reconnection rate"
          description: "{{ $value }} reconnections in the last 5 minutes. Check network stability."

  # =========================================================================
  # Knowledge Mound Resilience Alerts
  # =========================================================================
  - name: aragora_km_resilience
    rules:
      - alert: KMCircuitBreakerOpen
        expr: |
          aragora_km_circuit_breaker_state{service="postgres"} == 2
        for: 1m
        labels:
          severity: critical
          service: aragora
          component: knowledge_mound
        annotations:
          summary: "PostgreSQL circuit breaker is OPEN"
          description: "KM circuit breaker for PostgreSQL is open. Database may be unavailable. Check connectivity and health."
          runbook_url: "https://docs.aragora.io/runbooks/km-circuit-breaker"

      - alert: KMCircuitBreakerHalfOpen
        expr: |
          aragora_km_circuit_breaker_state{service="postgres"} == 1
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: knowledge_mound
        annotations:
          summary: "PostgreSQL circuit breaker is half-open"
          description: "KM circuit breaker is in recovery mode. Monitor for full recovery or failure."

      - alert: KMHighRetryRate
        expr: |
          (
            sum(rate(aragora_km_retry_total{outcome!="success"}[5m]))
            /
            sum(rate(aragora_km_retry_total[5m]))
          ) > 0.3
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: knowledge_mound
        annotations:
          summary: "High KM retry failure rate ({{ $value | humanizePercentage }})"
          description: "More than 30% of KM operations require retries. Check database health and connectivity."

      - alert: KMRetryExhaustion
        expr: |
          increase(aragora_km_retry_total{outcome="exhausted"}[5m]) > 5
        for: 5m
        labels:
          severity: critical
          service: aragora
          component: knowledge_mound
        annotations:
          summary: "KM operations exhausting retries"
          description: "{{ $value }} operations exhausted all retries in the last 5 minutes. Database may be unavailable."

      - alert: KMHighCacheInvalidation
        expr: |
          sum(rate(aragora_km_cache_invalidation_total[5m])) > 100
        for: 5m
        labels:
          severity: info
          service: aragora
          component: knowledge_mound
        annotations:
          summary: "High cache invalidation rate"
          description: "{{ $value }} cache invalidations per second. May indicate heavy write activity or cache thrashing."

      - alert: KMConnectionPoolExhaustion
        expr: |
          aragora_km_connection_pool_usage_ratio > 0.9
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: knowledge_mound
        annotations:
          summary: "KM connection pool near exhaustion ({{ $value | humanizePercentage }})"
          description: "Connection pool usage is above 90%. Consider increasing pool size or optimizing queries."

      - alert: KMConnectionPoolCritical
        expr: |
          aragora_km_connection_pool_usage_ratio > 0.95
        for: 2m
        labels:
          severity: critical
          service: aragora
          component: knowledge_mound
        annotations:
          summary: "KM connection pool critically exhausted"
          description: "Connection pool usage is above 95%. Operations may fail. Immediate action required."

      - alert: KMIntegrityErrors
        expr: |
          increase(aragora_km_integrity_check_errors_total[1h]) > 0
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: knowledge_mound
        annotations:
          summary: "KM integrity check errors detected"
          description: "{{ $value }} integrity errors detected in the last hour. Data consistency may be compromised."

      - alert: KMFrequentCircuitBreakerTrips
        expr: |
          increase(aragora_km_circuit_breaker_trips_total[1h]) > 5
        for: 10m
        labels:
          severity: warning
          service: aragora
          component: knowledge_mound
        annotations:
          summary: "Frequent circuit breaker trips"
          description: "{{ $value }} circuit breaker trips in the last hour. Investigate underlying connectivity issues."

  # =========================================================================
  # Explainability API Alerts
  # =========================================================================
  - name: aragora_explainability
    rules:
      - alert: ExplainabilityHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(aragora_explainability_latency_seconds_bucket[5m])) by (le, endpoint)
          ) > 10
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: explainability
        annotations:
          summary: "High explainability API latency (p95 > 10s)"
          description: "Endpoint {{ $labels.endpoint }} p95 latency is {{ $value | humanizeDuration }}. Check LLM provider performance."

      - alert: ExplainabilityHighErrorRate
        expr: |
          (
            sum(rate(aragora_explainability_requests_total{status="error"}[5m])) by (endpoint)
            /
            sum(rate(aragora_explainability_requests_total[5m])) by (endpoint)
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: explainability
        annotations:
          summary: "High explainability error rate on {{ $labels.endpoint }}"
          description: "Error rate is {{ $value | humanizePercentage }}. Check debate data availability and LLM connectivity."

      - alert: ExplainabilityNoRequests
        expr: |
          increase(aragora_explainability_requests_total[1h]) == 0
          and
          increase(aragora_debates_completed_total[1h]) > 10
        for: 1h
        labels:
          severity: info
          service: aragora
          component: explainability
        annotations:
          summary: "No explainability requests despite active debates"
          description: "Explainability feature may be disabled or underutilized."

  # =========================================================================
  # Workflow Template Alerts
  # =========================================================================
  - name: aragora_workflow_templates
    rules:
      - alert: WorkflowTemplateHighFailureRate
        expr: |
          (
            sum(rate(aragora_workflow_template_executions_total{status="error"}[5m]))
            /
            sum(rate(aragora_workflow_template_executions_total[5m]))
          ) > 0.2
        for: 10m
        labels:
          severity: warning
          service: aragora
          component: workflow_templates
        annotations:
          summary: "High workflow template failure rate ({{ $value | humanizePercentage }})"
          description: "More than 20% of workflow template executions are failing. Check workflow engine logs."

      - alert: WorkflowTemplateSlowExecution
        expr: |
          histogram_quantile(0.95,
            sum(rate(aragora_workflow_template_execution_latency_seconds_bucket[5m])) by (le, pattern)
          ) > 300
        for: 10m
        labels:
          severity: warning
          service: aragora
          component: workflow_templates
        annotations:
          summary: "Slow workflow template execution ({{ $labels.pattern }})"
          description: "Pattern {{ $labels.pattern }} p95 execution time is {{ $value | humanizeDuration }}. Check for bottlenecks."

  # =========================================================================
  # Gauntlet Export Alerts
  # =========================================================================
  - name: aragora_gauntlet
    rules:
      - alert: GauntletExportFailures
        expr: |
          (
            sum(rate(aragora_gauntlet_exports_total{status="error"}[5m]))
            /
            sum(rate(aragora_gauntlet_exports_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          service: aragora
          component: gauntlet
        annotations:
          summary: "High gauntlet export failure rate ({{ $value | humanizePercentage }})"
          description: "More than 10% of gauntlet exports are failing. Check receipt data integrity."

      - alert: GauntletExportSlowLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(aragora_gauntlet_export_latency_seconds_bucket[5m])) by (le, format)
          ) > 5
        for: 5m
        labels:
          severity: info
          service: aragora
          component: gauntlet
        annotations:
          summary: "Slow gauntlet export ({{ $labels.format }})"
          description: "Export format {{ $labels.format }} p95 latency is {{ $value | humanizeDuration }}."
