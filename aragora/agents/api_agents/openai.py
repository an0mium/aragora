"""
OpenAI API agent with OpenRouter fallback support.

Supports web search tool for web-capable responses when URLs
or web-related keywords are detected in the prompt.
"""

import logging
import re

from aragora.agents.api_agents.base import APIAgent
from aragora.core_types import AgentRole
from aragora.agents.api_agents.common import get_api_key
from aragora.agents.api_agents.openai_compatible import OpenAICompatibleMixin
from aragora.agents.registry import AgentRegistry

logger = logging.getLogger(__name__)

# Patterns that indicate web search would be helpful
WEB_SEARCH_INDICATORS = [
    r"https?://",  # URLs
    r"github\.com",  # GitHub repos
    r"\brepo\b",  # Repository mentions
    r"\bwebsite\b",  # Website mentions
    r"\bweb\s*page\b",  # Web page mentions
    r"\bonline\b",  # Online content
    r"\blatest\b",  # Latest information (might need fresh data)
    r"\bcurrent\b",  # Current information
    r"\brecent\b",  # Recent information
    r"\bnews\b",  # News
    r"\barticle\b",  # Articles
]


@AgentRegistry.register(
    "openai-api",
    default_model="gpt-5.2",
    default_name="openai-api",
    agent_type="API",
    env_vars="OPENAI_API_KEY",
    accepts_api_key=True,
)
class OpenAIAPIAgent(OpenAICompatibleMixin, APIAgent):  # type: ignore[misc]
    """Agent that uses OpenAI API directly.

    Includes automatic fallback to OpenRouter when OpenAI quota is exceeded (429 error).
    The fallback uses the same GPT model via OpenRouter's API.

    Supports web search tool for web-capable responses when URLs or web-related
    keywords are detected in the prompt.

    Uses OpenAICompatibleMixin for standard OpenAI API implementation.
    """

    OPENROUTER_MODEL_MAP = {
        "gpt-4o": "openai/gpt-4o",
        "gpt-4o-mini": "openai/gpt-4o-mini",
        "gpt-4-turbo": "openai/gpt-4-turbo",
        "gpt-4": "openai/gpt-4",
        "gpt-3.5-turbo": "openai/gpt-3.5-turbo",
        "gpt-5.2": "openai/gpt-4o",  # Fallback to gpt-4o if gpt-5.2 not available
        "gpt-4o-search-preview": "openai/gpt-4o",  # Search model fallback
    }
    DEFAULT_FALLBACK_MODEL = "openai/gpt-4o"

    def __init__(
        self,
        name: str = "openai-api",
        model: str = "gpt-5.2",
        role: AgentRole = "proposer",
        timeout: int = 120,
        api_key: str | None = None,
        enable_fallback: bool | None = None,  # None = use config setting
    ):
        super().__init__(
            name=name,
            model=model,
            role=role,
            timeout=timeout,
            api_key=api_key or get_api_key("OPENAI_API_KEY"),
            base_url="https://api.openai.com/v1",
        )
        self.agent_type = "openai"
        # Use config setting if not explicitly provided
        if enable_fallback is None:
            from aragora.agents.fallback import get_default_fallback_enabled

            self.enable_fallback = get_default_fallback_enabled()
        else:
            self.enable_fallback = enable_fallback
        self._fallback_agent = None
        self.enable_web_search = True  # Enable web search tool by default
        self._current_prompt = ""  # Track current prompt for web search detection

    def _needs_web_search(self, prompt: str) -> bool:
        """Detect if the prompt would benefit from web search.

        Returns True if the prompt contains URLs, GitHub references,
        or keywords indicating need for current/web information.
        """
        if not self.enable_web_search:
            return False

        for pattern in WEB_SEARCH_INDICATORS:
            if re.search(pattern, prompt, re.IGNORECASE):
                return True
        return False

    def _build_messages(self, full_prompt: str) -> list[dict]:
        """Build messages and track prompt for web search detection."""
        # Store prompt for _build_extra_payload to use
        self._current_prompt = full_prompt
        return super()._build_messages(full_prompt)

    def _build_extra_payload(self) -> dict | None:
        """Add web search tool if prompt indicates web content is needed."""
        if self._needs_web_search(self._current_prompt):
            logger.info(f"[{self.name}] Enabling web search tool for web content")
            return {
                "tools": [
                    {
                        "type": "web_search",
                        "web_search": {},
                    }
                ]
            }
        return None


__all__ = ["OpenAIAPIAgent"]
