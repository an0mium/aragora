id: template_accounting_expense_processing
name: Expense Processing Pipeline
description: Automated expense receipt processing, categorization, approval, and QBO sync
version: "1.0.0"
category: accounting
tags:
  - accounting
  - expense
  - receipt
  - qbo
  - reimbursement
icon: receipt
is_template: true

inputs:
  receipt_image: Receipt image or PDF
  employee_id: Employee who incurred the expense
  payment_method: Payment method used
  expense_policy_id: Expense policy to validate against
  auto_approve_threshold: Amount below which auto-approval is allowed
  qbo_tenant_id: QuickBooks tenant ID for sync

outputs:
  expense_record: Processed expense record
  category: Assigned expense category
  policy_violations: Any policy violations found
  approval_status: Final approval status
  qbo_sync_result: QBO synchronization result

steps:
  - id: extract_receipt
    name: Extract Receipt Data
    step_type: task
    description: OCR extraction of receipt data
    config:
      task_type: custom
      handler: expense_tracker.process_receipt
      params:
        image_data: "{receipt_image}"
        employee_id: "{employee_id}"
        payment_method: "{payment_method}"
    visual:
      position: {x: 100, y: 100}
      category: task
      color: "#4299e1"
    next_steps:
      - categorize_expense

  - id: categorize_expense
    name: Categorize Expense
    step_type: task
    description: Auto-categorize expense using LLM + patterns
    config:
      task_type: custom
      handler: expense_tracker.categorize_expense
      params:
        expense: "{step.extract_receipt}"
    visual:
      position: {x: 100, y: 250}
      category: task
      color: "#4299e1"
    next_steps:
      - check_duplicates

  - id: check_duplicates
    name: Check for Duplicates
    step_type: task
    description: Detect potential duplicate expense submissions
    config:
      task_type: custom
      handler: expense_tracker.detect_duplicates
      params:
        expense: "{step.extract_receipt}"
    visual:
      position: {x: 100, y: 400}
      category: task
      color: "#ed8936"
    next_steps:
      - handle_duplicates

  - id: handle_duplicates
    name: Handle Duplicates
    step_type: decision
    description: Route based on duplicate detection
    config:
      conditions:
        - name: has_duplicates
          expression: "len(step.check_duplicates) > 0"
          next_step: duplicate_review
      default_branch: validate_policy
    visual:
      position: {x: 100, y: 550}
      category: control
      color: "#ed8936"

  - id: duplicate_review
    name: Review Potential Duplicate
    step_type: human_checkpoint
    description: Manager review of potential duplicate expense
    config:
      title: Potential Duplicate Expense
      description: "Expense may be a duplicate of existing submissions"
      checklist:
        - label: Reviewed similar expenses
          required: true
        - label: Confirmed this is not a duplicate
          required: true
      timeout_seconds: 86400  # 24 hours
    visual:
      position: {x: 300, y: 650}
      category: human
      color: "#f56565"
    next_steps:
      - validate_policy

  - id: validate_policy
    name: Validate Expense Policy
    step_type: agent
    description: AI validation against expense policy
    config:
      agent_type: accounting
      prompt_template: |
        Validate expense against company policy:

        Expense:
        - Vendor: {step.extract_receipt.vendor_name}
        - Amount: ${step.extract_receipt.amount}
        - Category: {step.categorize_expense}
        - Date: {step.extract_receipt.date}

        Policy ID: {expense_policy_id}

        Check for:
        - Amount limits per category
        - Required receipts threshold
        - Prohibited vendors/categories
        - Weekend/holiday restrictions
        - Per diem limits
    visual:
      position: {x: 100, y: 700}
      category: agent
      color: "#4299e1"
    next_steps:
      - check_policy_violations

  - id: check_policy_violations
    name: Check Policy Violations
    step_type: decision
    description: Route based on policy validation
    config:
      conditions:
        - name: has_violations
          expression: "len(step.validate_policy.get('violations', [])) > 0"
          next_step: policy_exception_review
      default_branch: determine_approval_level
    visual:
      position: {x: 100, y: 850}
      category: control
      color: "#ed8936"

  - id: policy_exception_review
    name: Policy Exception Review
    step_type: human_checkpoint
    description: Manager review of policy exception request
    config:
      title: Expense Policy Exception Required
      description: "Expense violates policy and requires exception approval"
      checklist:
        - label: Reviewed policy violations
          required: true
        - label: Evaluated business justification
          required: true
        - label: Exception approved or denied
          required: true
      timeout_seconds: 86400  # 24 hours
      priority: medium
    visual:
      position: {x: 300, y: 950}
      category: human
      color: "#f6ad55"
    next_steps:
      - determine_approval_level

  - id: determine_approval_level
    name: Determine Approval Level
    step_type: decision
    description: Route based on expense amount
    config:
      conditions:
        - name: auto_approve
          expression: "step.extract_receipt.get('amount', 0) <= inputs.get('auto_approve_threshold', 50)"
          next_step: auto_approve_expense
        - name: manager_approval
          expression: "step.extract_receipt.get('amount', 0) <= 500"
          next_step: manager_approval
      default_branch: director_approval
    visual:
      position: {x: 100, y: 1000}
      category: control
      color: "#ed8936"

  - id: auto_approve_expense
    name: Auto-Approve Expense
    step_type: task
    description: Automatically approve low-value expenses
    config:
      task_type: transform
      transform: |
        {
          'status': 'approved',
          'approved_by': 'system_auto_approve',
          'approved_at': datetime.now().isoformat(),
          'notes': 'Auto-approved: amount below threshold'
        }
    visual:
      position: {x: -100, y: 1150}
      category: task
      color: "#48bb78"
    next_steps:
      - sync_to_qbo

  - id: manager_approval
    name: Manager Approval
    step_type: human_checkpoint
    description: Manager approval for standard expenses
    config:
      title: Expense Approval - Manager Level
      description: "Expense ${step.extract_receipt.amount} at {step.extract_receipt.vendor_name} requires approval"
      checklist:
        - label: Verified receipt legitimacy
          required: true
        - label: Confirmed business purpose
          required: true
        - label: Approved for reimbursement
          required: true
      timeout_seconds: 43200  # 12 hours
    visual:
      position: {x: 100, y: 1150}
      category: human
      color: "#f6ad55"
    next_steps:
      - sync_to_qbo

  - id: director_approval
    name: Director Approval
    step_type: human_checkpoint
    description: Director approval for high-value expenses
    config:
      title: Expense Approval - Director Level
      description: "High-value expense ${step.extract_receipt.amount} requires director approval"
      checklist:
        - label: Verified receipt legitimacy
          required: true
        - label: Confirmed business purpose
          required: true
        - label: Verified against budget
          required: true
        - label: Approved for reimbursement
          required: true
      timeout_seconds: 86400  # 24 hours
      priority: medium
    visual:
      position: {x: 200, y: 1150}
      category: human
      color: "#f56565"
    next_steps:
      - sync_to_qbo

  - id: sync_to_qbo
    name: Sync to QuickBooks
    step_type: task
    description: Create expense in QuickBooks Online
    config:
      task_type: custom
      handler: qbo_connector.create_expense
      params:
        tenant_id: "{qbo_tenant_id}"
        expense_data: "{step.extract_receipt}"
        category: "{step.categorize_expense}"
    visual:
      position: {x: 100, y: 1300}
      category: integration
      color: "#9f7aea"
    next_steps:
      - archive_expense

  - id: archive_expense
    name: Archive Expense
    step_type: memory_write
    description: Archive processed expense to memory
    config:
      content: |
        {
          "expense": step.extract_receipt,
          "category": step.categorize_expense,
          "policy_validation": step.validate_policy,
          "qbo_sync": step.sync_to_qbo
        }
      source_type: EXPENSE
      domain: accounting/expenses
    visual:
      position: {x: 100, y: 1450}
      category: memory
      color: "#9f7aea"
