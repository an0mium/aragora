#!/usr/bin/env python3
"""
Gate CI on unresolved penetration-test findings.

Expected input schema (JSON):
{
  "metadata": {...},
  "findings": [
    {"id": "PT-001", "severity": "critical|high|...", "status": "open|fixed|...", ...}
  ]
}
"""

from __future__ import annotations

import argparse
import json
import sys
from pathlib import Path


BLOCKING_SEVERITIES = {"critical", "high"}
RESOLVED_STATUSES = {"fixed", "resolved", "mitigated", "accepted", "closed", "false_positive"}


def _load_findings(path: Path) -> list[dict]:
    data = json.loads(path.read_text(encoding="utf-8"))
    findings = data.get("findings", [])
    if not isinstance(findings, list):
        raise ValueError("'findings' must be a list")
    return [f for f in findings if isinstance(f, dict)]


def main() -> int:
    parser = argparse.ArgumentParser(description="Check pentest findings for unresolved high/critical items")
    parser.add_argument(
        "--file",
        default="security/pentest/findings.json",
        help="Path to pentest findings JSON file",
    )
    args = parser.parse_args()

    path = Path(args.file)
    if not path.exists():
        print(f"Pentest findings file not found: {path}", file=sys.stderr)
        return 2

    try:
        findings = _load_findings(path)
    except (json.JSONDecodeError, OSError, ValueError) as exc:
        print(f"Failed to read pentest findings: {exc}", file=sys.stderr)
        return 2

    blocking: list[dict] = []
    for finding in findings:
        severity = str(finding.get("severity", "")).strip().lower()
        status = str(finding.get("status", "")).strip().lower()
        if severity in BLOCKING_SEVERITIES and status not in RESOLVED_STATUSES:
            blocking.append(finding)

    if blocking:
        print("Unresolved high/critical pentest findings detected:")
        for finding in blocking:
            fid = finding.get("id", "UNKNOWN")
            severity = finding.get("severity", "unknown")
            status = finding.get("status", "unknown")
            title = finding.get("title", "")
            print(f"  - {fid} [{severity}/{status}] {title}")
        return 1

    print(
        "Pentest findings check passed "
        f"(total={len(findings)}, blocking_open={len(blocking)})"
    )
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
